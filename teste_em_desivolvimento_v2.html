<!DOCTYPE html>
<html lang="pt-br">
<head>
      <!-- Leaflet CSS e JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Gerenciamento de Obras</title>
    <style>
        body {
            background-color: #f4f4f4;
            color: #333;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }
        header {
            background-color: #961c1c;
            color: white;
            padding: 20px;
            text-align: center;
            font-size: 28px;
            font-weight: bold;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            position: relative;
        }
        .container {
            padding: 20px;
            max-width: 800px;
            margin: auto;
        }
        input, button, select, textarea {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-size: 16px;
            background-color: #fff;
            color: #333;
            outline: none;
        }
        button {
            background-color: #961c1c;
            color: white;
            transition: background-color 0.3s;
            cursor: pointer;
        }
        button:hover {
            background-color: #c62828;
        }
        .menu {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
        }
        .menu button {
            flex: 1;
            margin: 5px;
        }
        .screen {
            display: none;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }
        .screen.active {
            display: block;
            opacity: 1;
        }
        .user-menu {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
        }
        .user-menu button {
            background: none;
            border: none;
            cursor: pointer;
        }
        .user-menu img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
        }
        .profile-menu {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
        }
        .profile-menu button {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: none;
            border: none;
            cursor: pointer;
            transition: transform 0.3s;
        }
        .profile-menu button:hover {
            transform: scale(1.1);
        }
        .profile-menu img {
            width: 60px;
            height: 60px;
            border-radius: 50%;
        }
        .profile-menu span {
            margin-top: 5px;
            font-size: 14px;
            color: #333;
        }
        .profile-info {
            text-align: center;
            margin-top: 10px;
        }
        .profile-info p {
            margin: 5px 0;
            font-size: 14px;
            color: #666;
        }
        .controle-prazos-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            position: absolute;
            top: 10px;
            right: 10px;
        }
        .controle-prazos-buttons button {
            width: auto;
            padding: 8px 12px;
            font-size: 14px;
        }
        .controle-prazos-buttons button svg {
            margin-right: 5px;
        }
        .controle-prazos-container {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        .controle-prazos-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }
        #calendar {
            width: 80%;
            max-width: 600px;
            margin-top: 20px;
        }
        .visao-geral-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            padding: 20px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .progresso-obra {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        .progresso-obra progress {
            width: 100%;
            height: 20px;
        }
        .cronograma-prazos {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .indicadores, .riscos-desafios {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .indicador, .risco {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 8px;
            background-color: #f9f9f9;
        }
        .tabela-colaboradores {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 18px;
            text-align: left;
        }
        .tabela-colaboradores thead tr {
            background-color: #961c1c;
            color: white;
            text-align: left;
        }
        .tabela-colaboradores th, .tabela-colaboradores td {
            padding: 12px 15px;
            border: 1px solid #ddd;
        }
        .tabela-colaboradores tbody tr {
            border-bottom: 1px solid #ddd;
        }
        .tabela-colaboradores tbody tr:nth-of-type(even) {
            background-color: #f3f3f3;
        }
        .tabela-colaboradores tbody tr:last-of-type {
            border-bottom: 2px solid #961c1c;
        }
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #4caf50;
            color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            display: none;
            z-index: 1000;
        }
        .obras-importadas-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 20px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
        }
        .obra-importada {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 8px;
            background-color: #f9f9f9;
        }
        .folder {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 8px;
            background-color: #e0e0e0;
            margin-bottom: 10px;
            cursor: pointer;
        }
        .folder:hover {
            background-color: #d0d0d0;
        }
        .file {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 8px;
            background-color: #f9f9f9;
            margin-bottom: 10px;
        }
        #assinaturaDigitalScreen {
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        #canvasAssinatura {
            transition: box-shadow 0.3s ease-in-out;
        }

        #canvasAssinatura:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        #listaAssinaturas div {
            transition: transform 0.3s ease-in-out;
        }

        #listaAssinaturas div:hover {
            transform: scale(1.05);
        }

        button {
            transition: background-color 0.3s ease-in-out, transform 0.2s ease-in-out;
        }

        button:hover {
            transform: scale(1.05);
        }

        .estrela {
            font-size: 30px;
            color: #ccc;
            cursor: pointer;
            transition: color 0.3s;
        }

        .estrela.selecionada {
            color: #FFD700;
        }

        .estrela:hover {
            color: #FFD700;
        }
    </style>
    <style>
        /* Tabela de Produção Semanal - versão compacta/mobile */
        #tabelaApontamentoProducao {
            border-radius: 10px;
            overflow-x: auto;
            box-shadow: 0 2px 8px rgba(50,50,50,0.08);
            background: #fff;
            margin-bottom: 16px;
            font-size: 13px;
        }
        #tabelaApontamentoProducao th, #tabelaApontamentoProducao td {
            border: 1px solid #e0e0e0;
            padding: 0;
            vertical-align: top;
        }
        #tabelaApontamentoProducao th {
            background: #23272f;
            color: #f4f4f4;
            font-size: 13px;
            font-weight: 600;
            padding: 8px 4px;
            border-right: 1px solid #fff;
            letter-spacing: 0.5px;
        }
        #tabelaApontamentoProducao tr:nth-child(even) td {
            background: #f7f8fa;
        }
        #tabelaApontamentoProducao tr:nth-child(odd) td {
            background: #f1f2f6;
        }
        #tabelaApontamentoProducao td {
            min-width: 80px;
            border-right: 1px solid #e0e0e0;
            border-bottom: 1px solid #e0e0e0;
            position: relative;
            font-size: 12px;
        }
        #tabelaApontamentoProducao td:first-child {
            background: #f6f7fa;
            font-weight: bold;
            color: #23272f;
            border-right: 2px solid #23272f;
            min-width: 70px;
            text-align: left;
            padding-left: 6px;
            font-size: 12px;
        }
        #tabelaApontamentoProducao td > div[contenteditable] {
            background: #fff;
            margin: 2px 0;
            border-radius: 4px;
            border: 1px solid #e0e0e0;
            min-height: 18px;
            padding: 4px 5px;
            font-size: 12px;
            transition: border 0.2s, box-shadow 0.2s;
            box-shadow: 0 1px 2px rgba(50,50,50,0.03);
        }
        #tabelaApontamentoProducao td > div[contenteditable]:focus {
            border: 2px solid #23272f;
            background: #f6f7fa;
            outline: none;
            box-shadow: 0 2px 8px #23272f22;
        }
        #tabelaApontamentoProducao input[type="date"] {
            width: 95%;
            padding: 4px;
            border-radius: 6px;
            border: 1px solid #bbb;
            margin: 2px 0;
            background: #f6f7fa;
            font-size: 12px;
            color: #23272f;
            transition: border 0.2s;
        }
        #tabelaApontamentoProducao input[type="date"]:focus {
            border: 2px solid #23272f;
            background: #fff;
        }
        #tabelaApontamentoProducao td:not(:last-child) {
            box-shadow: 1px 0 0 #e0e0e0;
        }
        #tabelaApontamentoProducao td:hover {
            background: #e9ecef;
            transition: background 0.2s;
        }
        /* Mobile: rolagem horizontal e fonte menor */
        @media (max-width: 600px) {
            #tabelaApontamentoProducao, #tabelaApontamentoProducao th, #tabelaApontamentoProducao td {
                font-size: 11px;
                min-width: 60px;
            }
            #tabelaApontamentoProducao th, #tabelaApontamentoProducao td {
                padding: 4px 2px;
            }
            #tabelaApontamentoProducao td > div[contenteditable] {
                font-size: 11px;
                min-height: 14px;
                padding: 2px 3px;
            }
            #tabelaApontamentoProducao input[type="date"] {
                font-size: 11px;
                padding: 2px;
            }
        }
    </style>
    <style>
        /* Estilo moderno e responsivo para Controle de Prazos */
        #controlePrazosScreen {
            background: #f7f9fb;
            border-radius: 16px;
            box-shadow: 0 4px 16px rgba(33,60,100,0.08);
            padding: 24px 12px 32px 12px;
            max-width: 700px;
            margin: 24px auto;
        }
        #controlePrazosScreen h2 {
            color: #22304a;
            font-size: 2rem;
            margin-bottom: 18px;
            text-align: center;
            font-weight: bold;
        }
        .controle-prazos-container {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(33,60,100,0.10);
            padding: 18px 12px;
            margin-top: 10px;
        }
        .controle-prazos-header {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 18px;
        }
        .controle-prazos-header h3 {
            color: #22304a;
            font-size: 1.2rem;
            font-weight: 600;
        }
        .controle-prazos-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        .controle-prazos-buttons button {
            background: #22304a;
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
        }
        .controle-prazos-buttons button:hover {
            background: #34495e;
        }
        #controlePrazosScreen label {
            font-size: 15px;
            color: #34495e;
            margin-top: 10px;
            margin-bottom: 3px;
            display: block;
        }
        #controlePrazosScreen select,
        #controlePrazosScreen input[type="date"] {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #cfd8dc;
            font-size: 15px;
            margin-bottom: 10px;
            background: #f7f9fb;
            color: #22304a;
            transition: border 0.2s;
        }
        #controlePrazosScreen select:focus,
        #controlePrazosScreen input[type="date"]:focus {
            border: 2px solid #22304a;
            background: #fff;
            outline: none;
        }
        #controlePrazosScreen input[type="checkbox"] {
            accent-color: #22304a;
            margin-right: 6px;
        }
        #calendar {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(33,60,100,0.10);
            padding: 10px;
            margin: 24px auto 0 auto;
            max-width: 100%;
            min-width: 0;
        }
        .fc {
            font-size: 14px;
            background: #fff;
            border-radius: 12px;
        }
        .fc-toolbar-title {
            color: #22304a;
            font-size: 1.3rem;
            font-weight: 600;
        }
        .fc-button {
            background: #22304a !important;
            color: #fff !important;
            border: none !important;
            border-radius: 6px !important;
            padding: 6px 12px !important;
            font-size: 13px !important;
            margin: 0 2px !important;
            transition: background 0.2s;
        }
        .fc-button:hover, .fc-button:focus {
            background: #34495e !important;
        }
        .fc-daygrid-day-number {
            color: #22304a;
            font-weight: 500;
        }
        .fc-day-today {
            background: #e3eafc !important;
        }
        .fc-event {
            background: linear-gradient(90deg, #3498db 60%, #22304a 100%) !important;
            color: #fff !important;
            border: none !important;
            border-radius: 8px !important;
            font-size: 13px !important;
            box-shadow: 0 2px 8px rgba(33,60,100,0.10);
            padding: 2px 8px !important;
        }
        .fc-daygrid-event-dot {
            border-color: #3498db !important;
        }
        #prazosOutput {
            margin-top: 18px;
            background: #f7f9fb;
            border-radius: 8px;
            padding: 10px;
            font-size: 14px;
            color: #22304a;
            box-shadow: 0 1px 4px rgba(33,60,100,0.05);
        }
        @media (max-width: 700px) {
            #controlePrazosScreen {
                padding: 8px 2vw 16px 2vw;
                max-width: 100vw;
            }
            .controle-prazos-container {
                padding: 10px 2vw;
            }
            #calendar {
                padding: 2px;
            }
        }
        @media (max-width: 500px) {
            #controlePrazosScreen h2 {
                font-size: 1.2rem;
            }
            .controle-prazos-header h3 {
                font-size: 1rem;
            }
            .fc-toolbar-title {
                font-size: 1rem;
            }
        }
        </style>
        <style>
            /* Visual inspirado em apontamentoProducaoScreen para a tabela de programação semanal */
            #tabelaProgramacaoVeiculos {
                border-radius: 10px;
                overflow-x: auto;
                box-shadow: 0 2px 8px rgba(50,50,50,0.08);
                background: #fff;
                margin-bottom: 16px;
                font-size: 13px;
            }
            #tabelaProgramacaoVeiculos th, #tabelaProgramacaoVeiculos td {
                border: 1px solid #e0e0e0;
                padding: 0;
                vertical-align: top;
            }
            #tabelaProgramacaoVeiculos th {
                background: #23272f;
                color: #f4f4f4;
                font-size: 13px;
                font-weight: 600;
                padding: 8px 4px;
                border-right: 1px solid #fff;
                letter-spacing: 0.5px;
            }
            #tabelaProgramacaoVeiculos tr:nth-child(even) td {
                background: #f7f8fa;
            }
            #tabelaProgramacaoVeiculos tr:nth-child(odd) td {
                background: #f1f2f6;
            }
            #tabelaProgramacaoVeiculos td {
                min-width: 120px;
                border-right: 1px solid #e0e0e0;
                border-bottom: 1px solid #e0e0e0;
                position: relative;
                font-size: 12px;
                padding: 0;
            }
            #tabelaProgramacaoVeiculos td:first-child {
                background: #f6f7fa;
                font-weight: bold;
                color: #23272f;
                border-right: 2px solid #23272f;
                min-width: 90px;
                text-align: left;
                padding-left: 6px;
                font-size: 13px;
                vertical-align: middle;
            }
            #tabelaProgramacaoVeiculos td > div.cell-content {
                background: linear-gradient(120deg, #fff 80%, #f7f8fa 100%);
                margin: 6px 4px;
                border-radius: 8px;
                border: 1px solid #e0e0e0;
                min-height: 70px;
                padding: 8px 10px 6px 10px;
                font-size: 12px;
                box-shadow: 0 1px 4px rgba(50,50,50,0.04);
                display: flex;
                flex-direction: column;
                gap: 4px;
                transition: border 0.2s, box-shadow 0.2s;
            }
            #tabelaProgramacaoVeiculos td > div.cell-content:focus-within {
                border: 2px solid #23272f;
                background: #f6f7fa;
                outline: none;
                box-shadow: 0 2px 8px #23272f22;
            }
            #tabelaProgramacaoVeiculos .cell-label {
                font-size: 11px;
                color: #961c1c;
                font-weight: bold;
                margin-bottom: 2px;
                letter-spacing: 0.2px;
            }
            #tabelaProgramacaoVeiculos .cell-label.lider,
            #tabelaProgramacaoVeiculos .cell-label.ajudantes {
                color: #34495e;
            }
            #tabelaProgramacaoVeiculos .cell-edit {
                border-bottom: 1px solid #ccc;
                min-height: 18px;
                margin-bottom: 4px;
                padding: 2px 4px;
                border-radius: 4px;
                background: #fff;
                transition: border 0.2s;
            }
            #tabelaProgramacaoVeiculos .cell-edit:focus {
                border-bottom: 2px solid #961c1c;
                background: #f6f7fa;
                outline: none;
            }
            #tabelaProgramacaoVeiculos .cell-edit.ajudantes {
                border-bottom: none;
                margin-bottom: 0;
            }
            #tabelaProgramacaoVeiculos input[type="date"] {
                width: 95%;
                padding: 4px;
                border-radius: 6px;
                border: 1px solid #bbb;
                margin: 2px 0;
                background: #f6f7fa;
                font-size: 12px;
                color: #23272f;
                transition: border 0.2s;
            }
            #tabelaProgramacaoVeiculos input[type="date"]:focus {
                border: 2px solid #23272f;
                background: #fff;
            }
            #tabelaProgramacaoVeiculos td:not(:last-child) {
                box-shadow: 1px 0 0 #e0e0e0;
            }
            #tabelaProgramacaoVeiculos td:hover {
                background: #e9ecef;
                transition: background 0.2s;
            }
            @media (max-width: 700px) {
                #tabelaProgramacaoVeiculos, #tabelaProgramacaoVeiculos th, #tabelaProgramacaoVeiculos td {
                    font-size: 11px;
                    min-width: 80px;
                }
                #tabelaProgramacaoVeiculos th, #tabelaProgramacaoVeiculos td {
                    padding: 4px 2px;
                }
                #tabelaProgramacaoVeiculos td > div.cell-content {
                    font-size: 11px;
                    min-height: 40px;
                    padding: 4px 3px;
                }
                #tabelaProgramacaoVeiculos input[type="date"] {
                    font-size: 11px;
                    padding: 2px;
                }
            }
            </style>
    <style>
        /* Tabela de Pendências de Produção - compacta/mobile e tom azul escuro */
        #tabelaPendenciasProducao {
            border-radius: 10px;
            overflow-x: auto;
            box-shadow: 0 2px 8px rgba(33,60,100,0.10);
            background: #fff;
            margin-bottom: 16px;
            font-size: 13px;
        }
        #tabelaPendenciasProducao th, #tabelaPendenciasProducao td {
            border: 1px solid #e0e0e0;
            padding: 0;
            vertical-align: top;
        }
        #tabelaPendenciasProducao th {
            background: #22304a;
            color: #f4f4f4;
            font-size: 13px;
            font-weight: 600;
            padding: 8px 4px;
            border-right: 1px solid #fff;
            letter-spacing: 0.5px;
        }
        #tabelaPendenciasProducao tr:nth-child(even) td {
            background: #f5f8fc;
        }
        #tabelaPendenciasProducao tr:nth-child(odd) td {
            background: #e9eef5;
        }
        #tabelaPendenciasProducao td {
            min-width: 80px;
            border-right: 1px solid #e0e0e0;
            border-bottom: 1px solid #e0e0e0;
            position: relative;
            font-size: 12px;
        }
        #tabelaPendenciasProducao td:first-child {
            background: #f3f6fa;
            font-weight: bold;
            color: #22304a;
            border-right: 2px solid #22304a;
            min-width: 70px;
            text-align: left;
            padding-left: 6px;
            font-size: 12px;
        }
        #tabelaPendenciasProducao td > div[contenteditable] {
            background: #fff;
            margin: 2px 0;
            border-radius: 4px;
            border: 1px solid #e0e0e0;
            min-height: 18px;
            padding: 4px 5px;
            font-size: 12px;
            transition: border 0.2s, box-shadow 0.2s;
            box-shadow: 0 1px 2px rgba(33,60,100,0.03);
        }
        #tabelaPendenciasProducao td > div[contenteditable]:focus {
            border: 2px solid #22304a;
            background: #f3f6fa;
            outline: none;
            box-shadow: 0 2px 8px #22304a22;
        }
        #tabelaPendenciasProducao input[type="date"] {
            width: 95%;
            padding: 4px;
            border-radius: 6px;
            border: 1px solid #bbb;
            margin: 2px 0;
            background: #f3f6fa;
            font-size: 12px;
            color: #22304a;
            transition: border 0.2s;
        }
        #tabelaPendenciasProducao input[type="date"]:focus {
            border: 2px solid #22304a;
            background: #fff;
        }
        #tabelaPendenciasProducao td:not(:last-child) {
            box-shadow: 1px 0 0 #e0e0e0;
        }
        #tabelaPendenciasProducao td:hover {
            background: #e0e7f1;
            transition: background 0.2s;
        }
        @media (max-width: 600px) {
            #tabelaPendenciasProducao, #tabelaPendenciasProducao th, #tabelaPendenciasProducao td {
                font-size: 11px;
                min-width: 60px;
            }
            #tabelaPendenciasProducao th, #tabelaPendenciasProducao td {
                padding: 4px 2px;
            }
            #tabelaPendenciasProducao td > div[contenteditable] {
                font-size: 11px;
                min-height: 14px;
                padding: 2px 3px;
            }
            #tabelaPendenciasProducao input[type="date"] {
                font-size: 11px;
                padding: 2px;
            }
        }
    </style>
    
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.0/main.min.css' rel='stylesheet' />
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.0/main.min.js'></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
</head>
<body>
    <header>
        Gerenciamento de Obras
        <div class="user-menu">
            <button onclick="showScreen('profileMenuScreen')">
                <img src="https://img.icons8.com/ios-filled/50/000000/user-menu-male.png" alt="Menu de Perfis">
            </button>
        </div>
    </header>
    <div class="menu">
        <button onclick="showScreen('loginScreen')">Login</button>
        <button onclick="showScreen('obrasScreen')">Obras</button>
        <button onclick="showScreen('arquivosImportadosScreen')">Arquivos Importados</button>
        <button onclick="showScreen('paineisRotinaScreen')">Paineis de Rotina</button>
          <button onclick="showScreen('vendasScreen')">vendas</button>
    </div>
  <!-- Painel lateral aprimorado -->
<div id="painelMapa" style="display:none; position:fixed; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.10); z-index:20000; align-items:stretch;">
  <div id="painelLateralMapa" style="width:340px; background:#fff; height:100vh; overflow-y:auto; box-shadow:2px 0 16px #22304a22; padding:22px 16px 16px 16px; border-top-right-radius:18px; border-bottom-right-radius:18px; transition:margin-left 0.3s;">
    <div style="display:flex;align-items:center;justify-content:space-between;">
      <h3 style="margin:0;color:#22304a;font-size:22px;">Pontos no Mapa</h3>
      <button onclick="ocultarPainelLateral()" title="Ocultar painel" style="background:none;border:none;font-size:22px;color:#961c1c;cursor:pointer;">&#10094;</button>
    </div>
    <input id="buscaMapa" type="text" placeholder="Buscar anotação..." style="width:100%;margin:12px 0 8px 0;padding:8px;border-radius:8px;border:1px solid #ccc;font-size:15px;">
    <select id="filtroTipoMapa" style="width:100%;margin-bottom:12px;padding:8px;border-radius:8px;border:1px solid #ccc;font-size:15px;">
      <option value="">Todos os Tipos</option>
      <option value="obra">Obra</option>
      <option value="visita">Visita</option>
      <option value="problema">Problema</option>
      <option value="entrega">Entrega</option>
    </select>
    <div style="display:flex;gap:8px;margin-bottom:12px;">
      <button onclick="exportarMarcadores()" style="flex:1;background:#22304a;color:#fff;border:none;border-radius:8px;padding:8px;font-size:15px;">Exportar</button>
      <button onclick="importarMarcadoresPrompt()" style="flex:1;background:#27ae60;color:#fff;border:none;border-radius:8px;padding:8px;font-size:15px;">Importar</button>
    </div>
    <ul id="listaMarcadores" style="list-style:none;padding:0;font-size:15px;max-height:38vh;overflow-y:auto;"></ul>
    <hr style="margin:18px 0 12px 0; border:none; border-top:1px solid #eee;">
    <button onclick="desenharPoligono()" style="width:100%;background:#f39c12;color:#fff;border:none;border-radius:8px;padding:10px;margin-bottom:10px;font-size:15px;">Desenhar Área</button>
    <button onclick="centralizarUsuario()" style="width:100%;background:#2980b9;color:#fff;border:none;border-radius:8px;padding:10px;display:flex;align-items:center;justify-content:center;gap:8px;font-size:15px;">
      <svg width="22" height="22" fill="none" viewBox="0 0 24 24"><circle cx="12" cy="12" r="8" stroke="#fff" stroke-width="2"/><circle cx="12" cy="12" r="3" fill="#fff"/></svg>
      Minha Localização
    </button>
  </div>
  <button id="btnMostrarPainel" onclick="mostrarPainelLateral()" title="Mostrar painel"
    style="display:none;position:absolute;top:32px;left:0;z-index:21001;background:#22304a;color:#fff;border:none;border-radius:0 12px 12px 0;width:38px;height:48px;font-size:22px;cursor:pointer;box-shadow:2px 0 8px #22304a22;">&#10095;</button>
  <div id="mapaBrasil" style="flex:1; height:100vh; min-width:0;"></div>
  <button onclick="fecharMapaBrasil()" title="Fechar Mapa"
    style="position:absolute;top:24px;right:32px;z-index:21000;background:#c0392b;color:#fff;border:none;border-radius:50%;width:48px;height:48px;font-size:28px;cursor:pointer;box-shadow:0 2px 8px #22304a22;">&times;</button>
</div>
<style>
.pulse-marker {
  animation: pulse 1.2s infinite;
}
@keyframes pulse {
  0% { box-shadow: 0 0 0 0 rgba(41,128,185,0.5);}
  70% { box-shadow: 0 0 0 16px rgba(41,128,185,0);}
  100% { box-shadow: 0 0 0 0 rgba(41,128,185,0);}
}
</style>
<!-- Botão flutuante para abrir o mapa -->
<button id="btnMapaFlutuante" onclick="abrirMapaBrasil()" title="Abrir Mapa Interativo"
  style="
    position: fixed;
    bottom: 32px;
    left: 32px;
    z-index: 20000;
    background: #22304a;
    color: #fff;
    border: none;
    border-radius: 50%;
    width: 64px;
    height: 64px;
    box-shadow: 0 4px 16px #22304a44;
    font-size: 32px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s;
  "
  onmouseover="this.style.background='#34495e'"
  onmouseout="this.style.background='#22304a'">
  <span style="font-size: 32px;">🗺️</span>
</button>

<script>
// Ícones personalizados para tipos de marcador
const icones = {
  obra: L.icon({
    iconUrl: 'https://cdn.jsdelivr.net/gh/feathericons/feather@4.29.0/icons/briefcase.svg', // Obra
    iconSize: [32, 32],
    iconAnchor: [16, 32],
    popupAnchor: [0, -32]
  }),
  visita: L.icon({
    iconUrl: 'https://cdn.jsdelivr.net/gh/feathericons/feather@4.29.0/icons/user.svg', // Visita
    iconSize: [32, 32],
    iconAnchor: [16, 32],
    popupAnchor: [0, -32]
  }),
  problema: L.icon({
    iconUrl: 'https://cdn.jsdelivr.net/gh/feathericons/feather@4.29.0/icons/alert-triangle.svg', // Problema
    iconSize: [32, 32],
    iconAnchor: [16, 32],
    popupAnchor: [0, -32]
  }),
  entrega: L.icon({
    iconUrl: 'https://cdn.jsdelivr.net/gh/feathericons/feather@4.29.0/icons/truck.svg', // Entrega
    iconSize: [32, 32],
    iconAnchor: [16, 32],
    popupAnchor: [0, -32]
  }),
  default: L.icon({
    iconUrl: 'https://cdn.jsdelivr.net/gh/feathericons/feather@4.29.0/icons/map-pin.svg', // Padrão
    iconSize: [32, 32],
    iconAnchor: [16, 32],
    popupAnchor: [0, -32]
  })
};
let mapa, marcadores = [], poligono = null, desenhandoMapa = false;

function abrirMapaBrasil() {
  document.getElementById('painelMapa').style.display = 'flex';
  document.getElementById('btnMapaFlutuante').style.display = 'none';
  setTimeout(() => { if (mapa) mapa.invalidateSize(); }, 300);

  if (!mapa) {
    mapa = L.map('mapaBrasil').setView([-14.235, -51.925], 4);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(mapa);

    mapa.on('click', function(e) {
      if (desenhandoMapa) {
        adicionarPontoPoligono(e.latlng);
        return;
      }
      abrirModalMarcador(e.latlng);
    });

    carregarMarcadores();
    atualizarListaMarcadores();
  }
}

function fecharMapaBrasil() {
  document.getElementById('painelMapa').style.display = 'none';
  document.getElementById('btnMapaFlutuante').style.display = 'flex';
}

// Modal simples para adicionar/editar marcador
function abrirModalMarcador(latlng, idx=null) {
  let tipo = 'obra', anotacao = '', edicao = false;
  if (idx !== null && marcadores[idx]) {
    tipo = marcadores[idx].tipo;
    anotacao = marcadores[idx].anotacao;
    edicao = true;
  }
  const html = `
    <div style="font-size:15px;">
      <label>Tipo:<br>
        <select id="tipoMarcador" style="width:100%;margin-bottom:6px;">
          <option value="obra">Obra</option>
          <option value="visita">Visita</option>
          <option value="problema">Problema</option>
          <option value="entrega">Entrega</option>
        </select>
      </label>
      <label>Anotação:<br>
        <textarea id="anotacaoMarcador" rows="3" style="width:100%;border-radius:6px;border:1px solid #ccc;">${anotacao}</textarea>
      </label>
      <button onclick="salvarMarcador(${latlng.lat},${latlng.lng},${idx})" style="margin-top:8px;width:100%;background:#27ae60;color:#fff;border:none;border-radius:6px;padding:6px;">Salvar</button>
      ${edicao ? `<button onclick="removerMarcador(${idx})" style="margin-top:8px;width:100%;background:#c0392b;color:#fff;border:none;border-radius:6px;padding:6px;">Remover</button>` : ''}
    </div>
  `;
  const popup = L.popup().setLatLng(latlng).setContent(html).openOn(mapa);
  setTimeout(() => {
    document.getElementById('tipoMarcador').value = tipo;
  }, 100);
}

window.salvarMarcador = function(lat, lng, idx) {
  const tipo = document.getElementById('tipoMarcador').value;
  const anotacao = document.getElementById('anotacaoMarcador').value;
  if (idx !== null && marcadores[idx]) {
    // Editar marcador existente
    marcadores[idx].leafletMarker.setIcon(icones[tipo] || icones.default);
    marcadores[idx].tipo = tipo;
    marcadores[idx].anotacao = anotacao;
    marcadores[idx].leafletMarker.closePopup();
  } else {
    // Novo marcador
    const marker = L.marker([lat, lng], { icon: icones[tipo] || icones.default, draggable:true }).addTo(mapa);
    const novo = { lat, lng, tipo, anotacao, leafletMarker: marker };
    marker.on('click', () => abrirModalMarcador(marker.getLatLng(), marcadores.indexOf(novo)));
    marcadores.push(novo);
  }
  salvarMarcadores();
  atualizarListaMarcadores();
  mapa.closePopup();
};

window.removerMarcador = function(idx) {
  if (marcadores[idx]) {
    mapa.removeLayer(marcadores[idx].leafletMarker);
    marcadores.splice(idx, 1);
    salvarMarcadores();
    atualizarListaMarcadores();
    mapa.closePopup();
  }
};
function ocultarPainelLateral() {
  document.getElementById('painelLateralMapa').style.marginLeft = '-340px';
  document.getElementById('btnMostrarPainel').style.display = 'block';
}
function mostrarPainelLateral() {
  document.getElementById('painelLateralMapa').style.marginLeft = '0';
  document.getElementById('btnMostrarPainel').style.display = 'none';
}

// Carregar marcadores do backend
async function carregarMarcadoresBackend() {
  const resp = await fetch('http://localhost:3001/api/marcadores');
  const dados = await resp.json();
  marcadores.forEach(m => mapa.removeLayer(m.leafletMarker));
  marcadores = [];
  dados.forEach(m => {
    const marker = L.marker([m.lat, m.lng], { icon: icones[m.tipo] || icones.default, draggable:true }).addTo(mapa);
    const novo = { ...m, leafletMarker: marker };
    marker.on('click', () => abrirModalMarcador(marker.getLatLng(), marcadores.indexOf(novo)));
    marcadores.push(novo);
  });
  atualizarListaMarcadores();
}

// Salvar marcadores no backend
async function salvarMarcadoresBackend() {
  const dados = marcadores.map(m => ({
    lat: m.lat, lng: m.lng, tipo: m.tipo, anotacao: m.anotacao
  }));
  await fetch('http://localhost:3000/api/marcadores', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(dados)
  });
}

// Substitua as funções de salvar/carregar locais:
function salvarMarcadores() { salvarMarcadoresBackend(); }
function carregarMarcadores() { carregarMarcadoresBackend(); }

// ...restante do código igual ao exemplo anterior...

// Localização do usuário (melhorada)
function centralizarUsuario() {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(function(pos) {
      mapa.setView([pos.coords.latitude, pos.coords.longitude], 15);
      // Remove marcadores antigos de localização, se desejar
      if (window._marcadorLocalizacao) mapa.removeLayer(window._marcadorLocalizacao);
      window._marcadorLocalizacao = L.marker([pos.coords.latitude, pos.coords.longitude], {
        icon: L.divIcon({
          className: 'pulse-marker', // Adiciona a classe para animação
          html: `<div style="width:38px;height:38px;display:flex;align-items:center;justify-content:center;">
            <svg width="38" height="38" viewBox="0 0 38 38">
              <circle cx="19" cy="19" r="16" fill="#2980b9" fill-opacity="0.25"/>
              <circle cx="19" cy="19" r="10" fill="#2980b9" fill-opacity="0.5"/>
              <circle cx="19" cy="19" r="5" fill="#fff" stroke="#2980b9" stroke-width="2"/>
            </svg>
          </div>`,
          iconSize: [38, 38],
          iconAnchor: [19, 19]
        })
      }).addTo(mapa).bindPopup('Você está aqui!').openPopup();
    }, function() {
      alert('Não foi possível obter sua localização.');
    }, { enableHighAccuracy: true });
  } else {
    alert('Geolocalização não suportada.');
  }
}
// Adicione uma legenda visual para os marcadores (coloque logo após o painel do mapa):
document.addEventListener('DOMContentLoaded', function() {
  const legenda = document.createElement('div');
  legenda.style = "position:absolute;bottom:24px;left:24px;z-index:21001;background:#fff;padding:10px 18px;border-radius:12px;box-shadow:0 2px 8px #22304a22;font-size:15px;display:flex;gap:16px;align-items:center;";
  legenda.innerHTML = `
    <img src="https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/svg/1f3d7.svg" width="24" title="Obra"> Obra
    <img src="https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/svg/1f465.svg" width="24" title="Visita" style="margin-left:12px;"> Visita
    <img src="https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/svg/26a0.svg" width="24" title="Problema" style="margin-left:12px;"> Problema
    <img src="https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/svg/1f69a.svg" width="24" title="Entrega" style="margin-left:12px;"> Entrega
  `;
  document.getElementById('painelMapa')?.appendChild(legenda);
});

// Ao abrir o mapa, carregue do backend
function abrirMapaBrasil() {
  document.getElementById('painelMapa').style.display = 'flex';
  document.getElementById('btnMapaFlutuante').style.display = 'none';
  setTimeout(() => { if (mapa) mapa.invalidateSize(); }, 300);

  if (!mapa) {
    mapa = L.map('mapaBrasil').setView([-14.235, -51.925], 4);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(mapa);

    mapa.on('click', function(e) {
      if (desenhando) {
        adicionarPontoPoligono(e.latlng);
        return;
      }
      abrirModalMarcador(e.latlng);
    });

    carregarMarcadoresBackend();
  } else {
    carregarMarcadoresBackend();
  }
}


function atualizarListaMarcadores() {
  const busca = document.getElementById('buscaMapa').value.toLowerCase();
  const tipoFiltro = document.getElementById('filtroTipoMapa').value;
  const ul = document.getElementById('listaMarcadores');
  ul.innerHTML = '';
  marcadores.forEach((m, idx) => {
    if (
      (busca === '' || m.anotacao.toLowerCase().includes(busca)) &&
      (tipoFiltro === '' || m.tipo === tipoFiltro)
    ) {
      const li = document.createElement('li');
      li.innerHTML = `<b>${m.tipo[0].toUpperCase() + m.tipo.slice(1)}</b>: ${m.anotacao.substring(0, 30)}... 
        <button onclick="focarMarcador(${idx})" style="background:#2980b9;color:#fff;border:none;border-radius:4px;padding:2px 8px;margin-left:6px;">Ver</button>`;
      ul.appendChild(li);
    }
  });
}

window.focarMarcador = function(idx) {
  if (marcadores[idx]) {
    mapa.setView([marcadores[idx].lat, marcadores[idx].lng], 15);
    marcadores[idx].leafletMarker.openPopup();
    abrirModalMarcador({lat: marcadores[idx].lat, lng: marcadores[idx].lng}, idx);
  }
};

document.getElementById('buscaMapa').oninput = atualizarListaMarcadores;
document.getElementById('filtroTipoMapa').onchange = atualizarListaMarcadores;

// Exportar/importar
function exportarMarcadores() {
  const dados = marcadores.map(m => ({
    lat: m.lat, lng: m.lng, tipo: m.tipo, anotacao: m.anotacao
  }));
  const blob = new Blob([JSON.stringify(dados, null, 2)], {type: 'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'marcadores_mapa_brasil.json';
  a.click();
  URL.revokeObjectURL(url);
}

function importarMarcadoresPrompt() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json,application/json';
  input.onchange = function(e) {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(evt) {
      try {
        const dados = JSON.parse(evt.target.result);
        marcadores.forEach(m => mapa.removeLayer(m.leafletMarker));
        marcadores = [];
        dados.forEach(m => {
          const marker = L.marker([m.lat, m.lng], { icon: icones[m.tipo] || icones.default, draggable:true }).addTo(mapa);
          const novo = { ...m, leafletMarker: marker };
          marker.on('click', () => abrirModalMarcador(marker.getLatLng(), marcadores.indexOf(novo)));
          marcadores.push(novo);
        });
        salvarMarcadores();
        atualizarListaMarcadores();
      } catch (e) {
        alert('Arquivo inválido!');
      }
    };
    reader.readAsText(file);
  };
  input.click();
}

// Desenhar área (polígono)
function desenharPoligono() {
  desenhandoMapa = true;
  if (poligono) {
    mapa.removeLayer(poligono);
    poligono = null;
  }
  alert('Clique nos pontos do mapa para desenhar a área. Clique duas vezes para finalizar.');
  let pontos = [];
  mapa.on('click', function handler(e) {
    if (!desenhandoMapa) return;
    pontos.push([e.latlng.lat, e.latlng.lng]);
    if (poligono) mapa.removeLayer(poligono);
    poligono = L.polygon(pontos, {color: '#f39c12'}).addTo(mapa);
  });
  mapa.on('dblclick', function finalizar() {
    desenhandoMapa = false;
    mapa.off('click');
    mapa.off('dblclick');
    alert('Área desenhada!');
  });
}


</script>

    <div class="container">
        <div id="loginScreen" class="screen active">
            <h2>Login</h2>
            <input type="text" id="username" placeholder="Usuário">
            <input type="password" id="password" placeholder="Senha">
            <button onclick="login()">Entrar</button>
        </div>
    </div>
        <div id="obrasScreen" class="screen">
            <h2>Cadastro de Obras</h2>
            <input type="text" id="obraNome" placeholder="Nome da Obra">
            <input type="text" id="obraEndereco" placeholder="Endereço da Obra">
            <input type="date" id="dataInicio" placeholder="Data de Início">
            <input type="date" id="previsaoTermino" placeholder="Previsão de Término">
            <textarea id="obraDescricao" placeholder="Descrição da Obra"></textarea>
            <button onclick="salvarObra()">Salvar Obra</button>
            <h3>Importar Planilha de Obras</h3>
            <input type="file" id="fileUpload" accept=".xlsx, .xls" multiple />
            <button onclick="importarPlanilha()">Importar Planilha</button>
            <h3>Buscar Obras</h3>
            <input type="text" id="buscarObraInput" placeholder="Digite o nome da obra" onkeyup="buscarObra()">
            <div id="obrasOutput"></div>
            <h3>Obras Importadas</h3>
            <div id="obrasImportadas" class="obras-importadas-container"></div> <!-- Contêiner para exibir as obras importadas -->
            <button onclick="showScreen('loginScreen')">Voltar</button>

            
        </div>

        <div id="arquivosImportadosScreen" class="screen">
            <h2 style="text-align: center; color: #961c1c; font-size: 28px; margin-bottom: 20px; font-weight: bold;">Arquivos Importados</h2>
            <div class="importacao-container" style="background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);">
                <!-- Área de Importação -->
                <div class="importar-arquivos" style="margin-bottom: 20px;">
                    <h3 style="color: #333; font-size: 22px; margin-bottom: 10px; font-weight: bold;">Importar Arquivos</h3>
                    <input id="inputArquivo" type="file" multiple style="padding: 10px; border: 1px solid #ccc; border-radius: 8px; font-size: 16px; width: 100%; margin-bottom: 10px;">
                    <button onclick="importarArquivos()" style="padding: 12px 20px; background-color: #961c1c; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; font-weight: bold;">Importar</button>
                </div>
        
                <!-- Lista de Arquivos Importados -->
                <div class="arquivos-importados">
                    <h3 style="color: #333; font-size: 22px; margin-bottom: 10px; font-weight: bold;">Arquivos Importados</h3>
                    <table style="width: 100%; border-collapse: collapse; text-align: left; font-size: 16px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); background-color: white; border-radius: 12px; overflow: hidden;">
                        <thead>
                            <tr style="background-color: #961c1c; color: white; text-align: left;">
                                <th style="padding: 15px; font-weight: bold;">Nome do Arquivo</th>
                                <th style="padding: 15px; font-weight: bold;">Tamanho</th>
                                <th style="padding: 15px; font-weight: bold; text-align: center;">Ação</th>
                            </tr>
                        </thead>
                        <tbody id="listaArquivos" style="background-color: #fff5f5;">
                            <!-- Arquivos importados serão listados aqui -->
                        </tbody>
                    </table>
                </div>
        
                <!-- Exibição do Conteúdo -->
                <div id="conteudoArquivo" style="margin-top: 30px; display: none;">
                    <h3 style="color: #333; font-size: 22px; margin-bottom: 10px; font-weight: bold;">Visualização do Arquivo</h3>
                    <div id="visualizadorArquivo" style="border: 1px solid #ccc; border-radius: 8px; overflow: hidden; height: 500px; background: #f5f5f5;">
                        <!-- O conteúdo do arquivo será exibido aqui -->
                    </div>
                    <!-- Adicione o botão de salvar no visualizador de arquivos -->
<div id="conteudoArquivo" style="margin-top: 30px; display: none;">
    <h3 style="color: #333; font-size: 22px; margin-bottom: 10px; font-weight: bold;">Visualização do Arquivo</h3>
    <div id="visualizadorArquivo" style="border: 1px solid #ccc; border-radius: 8px; overflow: hidden; height: 500px; background: #f5f5f5;">
        <!-- O conteúdo do arquivo será exibido aqui -->
    </div>
    <button id="salvarEdicao" onclick="salvarEdicaoArquivo()" style="margin-top: 10px; padding: 12px 20px; background-color: #4CAF50; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; display: none;">
        <img src="https://img.icons8.com/ios-filled/20/ffffff/save.png" alt="Salvar" style="margin-right: 5px;"> Salvar Edição
    </button>
</div>
                </div>
            </div>
            <button onclick="showScreen('menuScreen')" style="margin-top: 20px; padding: 12px 20px; background-color: #961c1c; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; font-weight: bold;">Voltar ao Menu</button>
        </div>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
        <script>
            const arquivosImportados = [];
        
            function importarArquivos() {
                const input = document.getElementById("inputArquivo");
                const listaArquivos = document.getElementById("listaArquivos");
        
                if (input.files.length === 0) {
                    alert("Por favor, selecione pelo menos um arquivo para importar.");
                    return;
                }
        
                Array.from(input.files).forEach((file) => {
                    if (arquivosImportados.some((arquivo) => arquivo.name === file.name)) {
                        alert(`O arquivo "${file.name}" já foi importado.`);
                        return;
                    }
        
                    arquivosImportados.push(file);
        
                    const linha = document.createElement("tr");
                    const urlArquivo = URL.createObjectURL(file);
        
                    linha.innerHTML = `
                        <td style="padding: 15px; border-bottom: 1px solid #ddd; color: #333;">
                            <a href="${urlArquivo}" target="_blank" style="color: #961c1c; text-decoration: none;">${file.name}</a>
                        </td>
                        <td style="padding: 15px; border-bottom: 1px solid #ddd; color: #333;">${(file.size / 1024).toFixed(2)} KB</td>
                        <td style="padding: 15px; border-bottom: 1px solid #ddd; text-align: center;">
            <button onclick="exibirConteudoArquivo('${file.name}', '${file.type}')" style="padding: 8px 15px; background-color: #4CAF50; color: white; border: none; border-radius: 8px; font-size: 14px; cursor: pointer;">Exibir</button>
            <button onclick="editarArquivo('${file.name}')" style="padding: 8px 15px; background-color: #FFA500; color: white; border: none; border-radius: 8px; font-size: 14px; cursor: pointer;">Editar</button>

                            <button onclick="removerArquivo('${file.name}', this)" style="padding: 8px 15px; background-color: #f44336; color: white; border: none; border-radius: 8px; font-size: 14px; cursor: pointer;">Excluir</button>
                        </td>
                    `;
        
                    listaArquivos.appendChild(linha);
                });
        
                input.value = "";
            }
        
            function removerArquivo(nomeArquivo, botao) {
                const index = arquivosImportados.findIndex((arquivo) => arquivo.name === nomeArquivo);
                if (index !== -1) {
                    arquivosImportados.splice(index, 1);
                }
        
                const linha = botao.parentElement.parentElement;
                linha.remove();
            }
        
            function editarArquivo(nomeArquivo) {
    const arquivo = arquivosImportados.find((file) => file.name === nomeArquivo);
    
    if (!arquivo) {
        alert("Arquivo não encontrado.");
        return;
    }

    const visualizador = document.getElementById("visualizadorArquivo");
    const conteudoDiv = document.getElementById("conteudoArquivo");
    const salvarBotao = document.getElementById("salvarEdicao");

    // Exibe o PDF em um iframe para edição
    const urlArquivo = URL.createObjectURL(arquivo);
    visualizador.innerHTML = `<iframe src="${urlArquivo}" style="width: 100%; height: 100%; border: none;"></iframe>`;
    conteudoDiv.style.display = "block";
    salvarBotao.style.display = "inline-block"; // Exibe o botão de salvar
}

function salvarEdicaoArquivo() {
    const nomeArquivo = "arquivo_editado.pdf"; // Nome do arquivo editado
    const subPasta = "subpasta_edicoes"; // Nome da subpasta

    // Simula a criação de uma subpasta e o salvamento do arquivo
    alert(`As edições do arquivo foram salvas em: ${subPasta}/${nomeArquivo}`);

    // Aqui você pode implementar a lógica para salvar o arquivo no servidor ou localmente
}
        </script>
        <div id="detalhesObraScreen" class="screen">
            <h2>Detalhes da Obra</h2>
            <div id="detalhesObra"></div>
            <button onclick="showScreen('painelObraScreen')">Painel da Obra</button>
            <button onclick="showScreen('obrasScreen')">Voltar</button>
        </div>
        <div id="painelObraScreen" class="screen">
            <h2>Painel da Obra</h2>
            <button onclick="showScreen('rdoScreen')">Registro de Atividades</button>
            <button onclick="showScreen('equipesScreen')">Gerenciamento de Equipes</button>
            <button onclick="showScreen('relatoriosScreen')">Relatórios e Avaliações</button>
            <button onclick="showScreen('visaoGeralScreen')">Visão Geral</button>
            <button onclick="showScreen('controlePrazosScreen')">Controle de Prazos</button>
            <button onclick="showScreen('assinaturaDigitalScreen')">Assinatura Digital</button>
            <button onclick="showScreen('detalhesObraScreen')">Voltar</button>
        </div>
        
        <script>
            function atualizarProgresso() {
                const andamento = document.getElementById("andamentoObra").value;
                const barraProgresso = document.getElementById("barraProgresso");
                const porcentagemProgresso = document.getElementById("porcentagemProgresso");
        
                let progresso = 0;
        
                if (andamento === "planejamento") progresso = 30;
                else if (andamento === "execucao") progresso = 60;
                else if (andamento === "finalizacao") progresso = 100;
        
                barraProgresso.style.width = `${progresso}%`;
                porcentagemProgresso.innerText = `${progresso}%`;
            }
        </script>

<!-- ...existing code... -->
<style>
    /* --- RDO SCREEN MODERNO E RESPONSIVO --- */
    #rdoScreen {
        max-width: 700px;
        margin: 32px auto 0 auto;
        padding: 0 8px 32px 8px;
    }
    #rdoScreen .atividade-container {
        background: #fff;
        padding: 24px 18px 18px 18px;
        border-radius: 16px;
        box-shadow: 0 4px 16px rgba(150,28,28,0.10);
        margin-bottom: 24px;
    }
    #rdoScreen h2 {
        font-size: 2rem;
        color: #961c1c;
        font-weight: bold;
        margin-bottom: 18px;
        text-align: center;
    }
    #rdoScreen h3 {
        color: #34495e;
        font-size: 1.2rem;
        margin-bottom: 12px;
        font-weight: 600;
    }
    #rdoScreen .inputs-flex {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 18px;
    }
    #rdoScreen .inputs-flex > * {
        flex: 1 1 150px;
        min-width: 120px;
    }
    #rdoScreen textarea {
        width: 100%;
        padding: 12px;
        border: 1px solid #ccc;
        border-radius: 8px;
        font-size: 16px;
        margin-bottom: 18px;
        min-height: 90px;
        background: #fafbfc;
        resize: vertical;
    }
    #rdoScreen .botoes-rdo {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        margin-top: 8px;
        flex-wrap: wrap;
    }
    #rdoScreen .botoes-rdo button {
        flex: 1 1 120px;
        padding: 12px 0;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        transition: background 0.2s, transform 0.2s;
    }
    #rdoScreen .botoes-rdo button.salvar {
        background: #27ae60;
        color: #fff;
    }
    #rdoScreen .botoes-rdo button.menu {
        background: #961c1c;
        color: #fff;
    }
    #rdoScreen .botoes-rdo button:active {
        transform: scale(0.97);
    }
    #rdoScreen #listaAtividades {
        margin-top: 10px;
        padding: 0;
        background: none;
        border-radius: 0;
        box-shadow: none;
    }
    #rdoScreen .atividade-item {
        background: #fff;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(150,28,28,0.08);
        padding: 16px;
        margin-bottom: 14px;
        border-left: 6px solid #961c1c;
        position: relative;
    }
    #rdoScreen .atividade-item strong {
        color: #961c1c;
    }
    #rdoScreen .atividade-item .atividade-data {
        position: absolute;
        top: 16px;
        right: 18px;
        font-size: 13px;
        color: #888;
    }
    @media (max-width: 600px) {
        #rdoScreen {
            padding: 0 2vw 24px 2vw;
            max-width: 100vw;
        }
        #rdoScreen .atividade-container {
            padding: 12px 4vw 12px 4vw;
        }
        #rdoScreen .inputs-flex {
            flex-direction: column;
            gap: 8px;
        }
        #rdoScreen .botoes-rdo {
            flex-direction: column;
            gap: 8px;
        }
        #rdoScreen .botoes-rdo button {
            font-size: 15px;
            padding: 10px 0;
        }
        #rdoScreen .atividade-item {
            padding: 12px;
            font-size: 15px;
        }
    }
    </style>
   <div id="rdoScreen" class="screen">
    <h3 style="margin-bottom:16px; color:#22304a; font-size: 24px; text-align:center;">Galeria de Imagens e Vídeos</h3>
<input type="file" id="galeriaInput" accept="image/*,video/*" multiple style="margin-bottom:12px;">
<button onclick="enviarGaleria()" style="margin-bottom:24px; background:#22304a; color:#fff; border:none; border-radius:6px; padding:8px 18px; font-size:16px; cursor:pointer;">Enviar</button>
<div style="display: flex; gap: 32px; margin-top: 16px; flex-wrap: wrap;">
    <div style="flex:1; min-width:220px;">
        <h4 style="color:#961c1c; margin-bottom:8px;">Fotos</h4>
        <div id="galeriaFotos" class="galeria-fotos"></div>
    </div>
    <div style="flex:1; min-width:220px;">
        <h4 style="color:#22304a; margin-bottom:8px;">Vídeos</h4>
        <div id="galeriaVideos" class="galeria-videos"></div>
    </div>
</div>
<!-- Modal para ampliar imagem -->
<div id="modalAmpliarImagem" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.92); align-items:center; justify-content:center; z-index:9999; flex-direction:column;">
    <button onclick="fecharModalImagem()" style="position:absolute;top:24px;right:32px;background:#f44336;color:#fff;border:none;border-radius:50%;width:40px;height:40px;font-size:28px;cursor:pointer;z-index:10001;">&times;</button>
    <button id="btnAnterior" onclick="trocarImagem(-1)" style="position:absolute;left:32px;top:50%;transform:translateY(-50%);background:rgba(0,0,0,0.5);color:#fff;border:none;border-radius:50%;width:48px;height:48px;font-size:28px;cursor:pointer;z-index:10001;display:none;">&#8592;</button>
    <img id="imgAmpliada" src="" style="max-width:90vw; max-height:80vh; border-radius:16px; box-shadow:0 8px 32px #000a; margin-bottom:12px;">
    <button id="btnProxima" onclick="trocarImagem(1)" style="position:absolute;right:32px;top:50%;transform:translateY(-50%);background:rgba(0,0,0,0.5);color:#fff;border:none;border-radius:50%;width:48px;height:48px;font-size:28px;cursor:pointer;z-index:10001;display:none;">&#8594;</button>
    <div id="contadorImagem" style="color:#fff; margin-top:8px; font-size:16px;"></div>
</div>
<style>
.galeria-fotos {
    display: flex;
    flex-wrap: wrap;
    gap: 18px;
    min-height: 120px;
    background: #f7f7fa;
    border-radius: 12px;
    padding: 18px 10px;
    box-shadow: 0 2px 12px #0001;
    max-height: 170px;
    overflow-x: auto;
    overflow-y: hidden;
    position: relative;
}
.galeria-fotos .foto-box {
    position: relative;
    border-radius: 10px;
    box-shadow: 0 2px 8px #0002;
    overflow: hidden;
    min-width: 120px;
    min-height: 90px;
    background: #fff;
    transition: transform 0.15s;
    cursor: pointer;
}
.galeria-fotos .foto-box:hover {
    transform: scale(1.04);
    box-shadow: 0 4px 16px #0003;
}
.galeria-fotos .foto-box img {
    width: 120px;
    height: 90px;
    object-fit: cover;
    border-radius: 10px;
    display: block;
}
.galeria-fotos .excluir-btn {
    position: absolute;
    top: 6px;
    right: 6px;
    background: rgba(255,255,255,0.95);
    border: none;
    border-radius: 50%;
    width: 28px;
    height: 28px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 1px 4px #0002;
    transition: background 0.2s;
}
.galeria-fotos .excluir-btn:hover {
    background: #ffeaea;
}
.galeria-videos {
    display: flex;
    flex-wrap: wrap;
    gap: 18px;
    min-height: 120px;
    background: #f7f7fa;
    border-radius: 12px;
    padding: 18px 10px;
    box-shadow: 0 2px 12px #0001;
    max-height: 170px;
    overflow-x: auto;
    overflow-y: hidden;
    position: relative;
}
.galeria-videos video {
    max-width: 180px;
    border-radius: 10px;
    box-shadow: 0 2px 8px #0002;
    background: #fff;
}
.galeria-videos .excluir-btn {
    position: absolute;
    top: 6px;
    right: 6px;
    background: rgba(255,255,255,0.95);
    border: none;
    border-radius: 50%;
    width: 28px;
    height: 28px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 1px 4px #0002;
    transition: background 0.2s;
}
.galeria-videos .excluir-btn:hover {
    background: #ffeaea;
}
@media (max-width: 700px) {
    .galeria-fotos, .galeria-videos {
        max-height: 120px;
        padding: 8px 2px;
        gap: 8px;
    }
    .galeria-fotos .foto-box img {
        width: 80px;
        height: 60px;
    }
}
</style>
        <h2>Registro de Atividades</h2>
        <div class="atividade-container">
            <h3>Adicionar Atividade</h3>
            <div class="inputs-flex">
                <select id="atividadeDescricao">
                    <option value="" disabled selected>Selecione a fase</option>
                    <option value="fase_de_solicitacao">Fase de Solicitação</option>
                    <option value="fase_de_producao">Fase de Produção</option>
                    <option value="fase_de_expedicao">Fase de Expedição</option>
                    <option value="fase_de_conclusao">Fase de Conclusão</option>
                </select>
                <select id="atividadeStatus">
                    <option value="pendente">Pendente</option>
                    <option value="em_progresso">Em Progresso</option>
                    <option value="concluida">Concluída</option>
                </select>
                <input type="date" id="atividadeData">
            </div>
            <textarea id="atividadeRelatorio" placeholder="Adicione um relatório detalhado..."></textarea>
            <div class="botoes-rdo">
                <button class="salvar" onclick="salvarAtividade()">Salvar</button>
                <button class="menu" onclick="showScreen('painelObraScreen')">Menu</button>
            </div>
        </div>
       <h3 style="text-align: center; color: #333; font-size: 22px; margin-top: 30px;">Atividades Registradas</h3>
<div id="listaAtividades">
           
            <!-- Atividades salvas aparecerão aqui -->
        </div>
    </div>
    <script>
     async function enviarGaleria() {
    const input = document.getElementById('galeriaInput');
    const files = input.files;
    if (!files.length) {
        alert('Selecione arquivos para enviar.');
        return;
    }
    const formData = new FormData();
    for (const file of files) {
        formData.append('midias', file);
    }
    try {
        await fetch('/api/galeria', {
            method: 'POST',
            body: formData
        });
        alert('Mídia enviada!');
        input.value = '';
        carregarGaleria();
    } catch {
        alert('Erro ao enviar mídia!');
    }
}

async function carregarGaleria() {
    try {
        const res = await fetch('/api/galeria');
        const midias = await res.json();
        const fotosDiv = document.getElementById('galeriaFotos');
        const videosDiv = document.getElementById('galeriaVideos');
        fotosDiv.innerHTML = '';
        videosDiv.innerHTML = '';
        // Fotos: limitar visualização a 3, depois mostrar barra de rolagem horizontal
        const imagens = midias.filter(m => m.tipo.startsWith('image'));
        imagensGaleria = imagens; // Para navegação no modal
        imagens.slice(0, 3).forEach((midia, idx) => {
            const fotoBox = document.createElement('div');
            fotoBox.className = 'foto-box';
            fotoBox.innerHTML = `
                <img src="${midia.url}" alt="Foto ${idx+1}" onclick="ampliarImagemGaleria(${idx})">
                <button class="excluir-btn" onclick="excluirMidia('${midia.id}', 'image')" title="Excluir imagem">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#c00" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="3 6 5 6 21 6"/>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"/>
                    <line x1="10" y1="11" x2="10" y2="17"/>
                    <line x1="14" y1="11" x2="14" y2="17"/>
                  </svg>
                </button>
            `;
            fotosDiv.appendChild(fotoBox);
        });
        // Se houver mais de 3 imagens, mostrar as demais acumuladas (rolagem horizontal)
        if (imagens.length > 3) {
            imagens.slice(3).forEach((midia, idx) => {
                const fotoBox = document.createElement('div');
                fotoBox.className = 'foto-box';
                fotoBox.innerHTML = `
                    <img src="${midia.url}" alt="Foto ${idx+4}" onclick="ampliarImagemGaleria(${idx+3})">
                    <button class="excluir-btn" onclick="excluirMidia('${midia.id}', 'image')" title="Excluir imagem">
                      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#c00" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="3 6 5 6 21 6"/>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"/>
                        <line x1="10" y1="11" x2="10" y2="17"/>
                        <line x1="14" y1="11" x2="14" y2="17"/>
                      </svg>
                    </button>
                `;
                fotosDiv.appendChild(fotoBox);
            });
        }
        // Vídeos
        midias.filter(m => m.tipo.startsWith('video')).forEach((midia, idx) => {
            const videoBox = document.createElement('div');
            videoBox.style.position = 'relative';
            videoBox.innerHTML = `
                <video src="${midia.url}" controls style="max-width:180px; border-radius:10px; background:#fff;"></video>
                <button class="excluir-btn" onclick="excluirMidia('${midia.id}', 'video')" title="Excluir vídeo">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#c00" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="3 6 5 6 21 6"/>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"/>
                    <line x1="10" y1="11" x2="10" y2="17"/>
                    <line x1="14" y1="11" x2="14" y2="17"/>
                  </svg>
                </button>
            `;
            videosDiv.appendChild(videoBox);
        });
    } catch {
        document.getElementById('galeriaFotos').innerHTML = '<p style="color:#c00;">Erro ao carregar galeria.</p>';
        document.getElementById('galeriaVideos').innerHTML = '';
    }
}

async function excluirMidia(id, tipo) {
    if (!confirm('Deseja realmente excluir esta mídia?')) return;
    try {
        await fetch(`/api/galeria/${id}`, { method: 'DELETE' });
        carregarGaleria();
    } catch {
        alert('Erro ao excluir mídia!');
    }
}

// Modal de ampliação com navegação
function ampliarImagemGaleria(indice) {
    indiceAtual = indice;
    mostrarImagemModal();
    document.getElementById('modalAmpliarImagem').style.display = 'flex';
}
function mostrarImagemModal() {
    const img = document.getElementById('imgAmpliada');
    if (!imagensGaleria[indiceAtual]) return;
    img.src = imagensGaleria[indiceAtual].url;
    document.getElementById('contadorImagem').innerText = `Imagem ${indiceAtual+1} de ${imagensGaleria.length}`;
    // Mostrar/ocultar botões de navegação
    document.getElementById('btnAnterior').style.display = indiceAtual > 0 ? 'block' : 'none';
    document.getElementById('btnProxima').style.display = indiceAtual < imagensGaleria.length-1 ? 'block' : 'none';
}
function trocarImagem(delta) {
    if (imagensGaleria.length === 0) return;
    indiceAtual += delta;
    if (indiceAtual < 0) indiceAtual = 0;
    if (indiceAtual > imagensGaleria.length-1) indiceAtual = imagensGaleria.length-1;
    mostrarImagemModal();
}
function fecharModalImagem() {
    document.getElementById('modalAmpliarImagem').style.display = 'none';
}
async function enviarGaleria() {
    const input = document.getElementById('galeriaInput');
    const files = input.files;
    if (!files.length) {
        alert('Selecione arquivos para enviar.');
        return;
    }
    const formData = new FormData();
    for (const file of files) {
        formData.append('midias', file);
    }
    try {
        await fetch('/api/galeria', {
            method: 'POST',
            body: formData
        });
        alert('Mídia enviada!');
        input.value = '';
        carregarGaleria();
    } catch {
        alert('Erro ao enviar mídia!');
    }
}

document.addEventListener('DOMContentLoaded', carregarGaleria);
document.addEventListener('DOMContentLoaded', carregarGaleria);
document.addEventListener('DOMContentLoaded', carregarGaleria);

async function salvarAtividade() {
    const descricao = document.getElementById("atividadeDescricao").value;
    const status = document.getElementById("atividadeStatus").value;
    const data = document.getElementById("atividadeData").value;
    const relatorio = document.getElementById("atividadeRelatorio").value;

    if (!descricao || !status || !data || !relatorio) {
        alert("Por favor, preencha todos os campos.");
        return;
    }

    try {
        const res = await fetch('/api/atividades', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                descricao,
                status,
                data,
                relatorio
            })
        });
        if (!res.ok) throw new Error();
        alert("Atividade salva com sucesso!");
        document.getElementById("atividadeDescricao").selectedIndex = 0;
        document.getElementById("atividadeStatus").value = "pendente";
        document.getElementById("atividadeData").value = "";
        document.getElementById("atividadeRelatorio").value = "";
        listarAtividades();
    } catch {
        alert("Erro ao salvar atividade!");
    }
}

// Listar atividades do backend
async function listarAtividades() {
    const lista = document.getElementById("listaAtividades");
    lista.innerHTML = "";
    try {
        const res = await fetch('/api/atividades');
        const atividades = await res.json();
        if (!Array.isArray(atividades) || atividades.length === 0) {
            lista.innerHTML = '<p style="color:#888;text-align:center;">Nenhuma atividade registrada.</p>';
            return;
        }
        atividades.forEach(atividade => {
            const div = document.createElement("div");
            div.className = "atividade-item";
            div.innerHTML = `
                <span class="atividade-data">${atividade.data ? new Date(atividade.data).toLocaleDateString() : ''}</span>
                <p><strong>Descrição:</strong> ${atividade.descricao ? atividade.descricao.replace(/_/g, ' ').replace('fase de ', '') : ''}</p>
                <p><strong>Status:</strong> ${atividade.status ? atividade.status.charAt(0).toUpperCase() + atividade.status.slice(1) : ''}</p>
                <p><strong>Relatório:</strong> ${atividade.relatorio || ''}</p>
                <button onclick="excluirAtividade('${atividade.id}', this)" title="Excluir atividade" style="position:absolute;top:10px;right:10px;background:rgba(255,255,255,0.95);border:none;border-radius:50%;width:32px;height:32px;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 1px 4px #0002;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#c00" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="3 6 5 6 21 6"/>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"/>
                        <line x1="10" y1="11" x2="10" y2="17"/>
                        <line x1="14" y1="11" x2="14" y2="17"/>
                    </svg>
                </button>
            `;
            lista.appendChild(div);
        });
    } catch {
        lista.innerHTML = '<p style="color:#c00;text-align:center;">Erro ao carregar atividades.</p>';
    }
}

// Excluir atividade do backend
async function excluirAtividade(id, btn) {
    if (!confirm("Tem certeza que deseja excluir esta atividade?")) return;
    if (btn) btn.disabled = true;
    try {
        const res = await fetch(`/api/atividades/${id}`, { method: 'DELETE' });
        if (!res.ok) throw new Error();
        listarAtividades();
    } catch {
        alert('Erro ao excluir atividade!');
    } finally {
        if (btn) btn.disabled = false;
    }
}

// Carrega a lista ao abrir a tela
document.addEventListener('DOMContentLoaded', listarAtividades);
    </script>
    <!-- ...existing code... -->


        <div id="equipesScreen" class="screen">
            <h2 style="text-align: center; color: #961c1c; font-size: 28px; margin-bottom: 20px; font-weight: bold;">Gerenciamento de Equipes e Materiais</h2>
            <div class="equipes-container" style="background: #faf7f7; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);">
                <!-- Formulário para adicionar colaboradores -->
                <div class="adicionar-colaborador" style="margin-bottom: 20px;">
                    <h3 style="color: #961c1c; font-size: 22px; margin-bottom: 10px; font-weight: bold;">Adicionar Colaborador</h3>
                    <input id="nomeColaborador" type="text" placeholder="Nome do Colaborador" style="padding: 12px; border: 1px solid #c0bfbf; border-radius: 8px; font-size: 16px; width: 100%; margin-bottom: 10px;">
                    <select id="funcaoColaborador" style="padding: 12px; border: 1px solid #ccc; border-radius: 8px; font-size: 16px; width: 100%; margin-bottom: 10px;">
                        <option value="ajudante">Ajudante</option>
                        <option value="lider">Líder</option>
                    </select>
                    <button onclick="adicionarColaborador()" style="padding: 12px 20px; background-color: #961c1c; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; font-weight: bold;">Adicionar</button>
             

                </div>
        
                <!-- Seleção de veículos -->
                <div class="adicionar-veiculo" style="margin-bottom: 20px;">
                    <h3 style="color: #961c1c; font-size: 22px; margin-bottom: 10px; font-weight: bold;">Selecionar Veículos</h3>
                    <select id="veiculoSelecionado" style="padding: 12px; border: 1px solid #ccc; border-radius: 8px; font-size: 16px; width: 100%; margin-bottom: 10px;">
                        <option value="Caminhão 08 - Placa EEX1839">Caminhão 08 - Placa EEX1839</option>
                        <option value="Caminhão 10 - Placa BTZ3E92">Caminhão 10 - Placa BTZ3E92</option>
                        <option value="Caminhão 14 - Placa GDK6156">Caminhão 14 - Placa GDK6156</option>
                        <option value="Caminhão 18 - Placa TMG2H59">Caminhão 18 - Placa TMG2H59</option>
                        <option value="Carro 13 - Placa CUJ5C38">Carro 13 - Placa CUJ5C38</option>
                        <option value="Carro 15 - Placa CUE7C87">Carro 15 - Placa CUE7C87</option>
                        <option value="Pick-up 12 - Placa EOO9F68">Pick-up 12 - Placa EOO9F68</option>
                        <option value="Pick-up 16 - Placa FXA1D61">Pick-up 16 - Placa FXA1D61</option>
                    </select>
                    <button onclick="adicionarVeiculo()" style="padding: 12px 20px; background-color: #961c1c; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; font-weight: bold;">Adicionar Veículo</button>
                </div>
        
                <!-- Adicionar materiais -->
                <div class="adicionar-material" style="margin-bottom: 20px;">
                    <h3 style="color: #961c1c; font-size: 22px; margin-bottom: 10px; font-weight: bold;">Adicionar Material</h3>
                    <select id="materialSelecionado" style="padding: 12px; border: 1px solid #ccc; border-radius: 8px; font-size: 16px; width: 100%; margin-bottom: 10px;">
                        <option value="ANDAIMES">ANDAIMES</option>
                        <option value="CAVALETE">CAVALETE</option>
                        <option value="GUINCHO ARANHA">GUINCHO ARANHA</option>
                        <option value="PERNAS">PERNAS</option>
                        <option value="PLATAFORMAS">PLATAFORMAS</option>
                        <option value="SAPATA">SAPATA</option>
                        <option value="TRAVAS">TRAVAS</option>
                    </select>
                    <input id="quantidadeMaterial" type="number" placeholder="Quantidade" style="padding: 12px; border: 1px solid #ccc; border-radius: 8px; font-size: 16px; width: 100%; margin-bottom: 10px;">
                    <button onclick="adicionarMaterial()" style="padding: 12px 20px; background-color: #961c1c; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; font-weight: bold;">Adicionar Material</button>
                </div>

        <div style="margin-bottom: 18px; display: flex; gap: 18px; align-items: center;">
    <label for="dataEquipe" style="font-size: 15px; font-weight: bold;">Data da Equipe:</label>
    <input type="date" id="dataEquipe" style="padding:8px; border-radius:8px; border:1px solid #ccc; font-size:15px;">
    <button onclick="salvarTabelaEquipe()" style="padding:10px 20px; background:#27ae60; color:white; border:none; border-radius:8px; font-size:16px; font-weight:bold;">Salvar Equipe</button>
</div>

                <!-- Tabela de equipe, veículos e materiais -->
                <div class="tabela-equipe">
                    <h3 style="color: #961c1c; font-size: 22px; margin-bottom: 10px; font-weight: bold;">Equipe, Veículos e Materiais</h3>
                    <table style="width: 100%; border-collapse: collapse; text-align: left; font-size: 16px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); background-color: white; border-radius: 12px; overflow: hidden;">
                        <thead>
                            <tr style="background-color: #961c1c; color: white; text-align: left;">
                                <th style="padding: 15px; font-weight: bold;">Nome/Descrição</th>
                                <th style="padding: 15px; font-weight: bold;">Função/Modelo/Quantidade</th>
                                <th style="padding: 15px; font-weight: bold; text-align: center;">Ação</th>
                            </tr>
                        </thead>
                        <tbody id="listaEquipe" style="background-color: #fff5f5;">
                            <!-- Colaboradores, veículos e materiais serão adicionados aqui -->
                        </tbody>
                    </table>
                </div>
            </div>
            <button onclick="showScreen('painelObraScreen')" style="margin-top: 20px; padding: 12px 20px; background-color: #961c1c; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; font-weight: bold;">Menu</button>
      <!-- Botão para abrir o histórico -->
<button onclick="abrirHistoricoEquipes()" style="margin: 18px 0; background: #22304a; color: #fff; border: none; border-radius: 8px; padding: 10px 20px; font-size: 16px; font-weight: bold;">Ver Histórico de Equipes</button>

<!-- Modal/área para mostrar o histórico -->
<div id="historicoEquipesModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.7); z-index:9999; align-items:center; justify-content:center;">
  <div style="background:#fff; border-radius:12px; padding:32px; max-width:700px; width:90vw; max-height:80vh; overflow:auto; position:relative;">
    <button onclick="fecharHistoricoEquipes()" style="position:absolute;top:12px;right:18px;background:#f44336;color:#fff;border:none;border-radius:50%;width:32px;height:32px;font-size:22px;cursor:pointer;">&times;</button>
    <h3 style="margin-bottom:18px; color:#22304a;">Histórico de Equipes</h3>
    <div id="listaHistoricoEquipes"></div>
  </div>
</div>

<script>
async function abrirHistoricoEquipes() {
    document.getElementById('historicoEquipesModal').style.display = 'flex';
    await carregarHistoricoEquipes();
}

function fecharHistoricoEquipes() {
    document.getElementById('historicoEquipesModal').style.display = 'none';
}

async function carregarHistoricoEquipes() {
    const lista = document.getElementById('listaHistoricoEquipes');
    lista.innerHTML = '<p style="color:#888;">Carregando...</p>';
    try {
        const res = await fetch('/api/equipes/historico');
        const historico = await res.json();
        if (!Array.isArray(historico) || historico.length === 0) {
            lista.innerHTML = '<p style="color:#888;">Nenhum registro encontrado.</p>';
            return;
        }
        lista.innerHTML = '';
        historico.forEach(equipe => {
            const div = document.createElement('div');
            div.style = "border:1px solid #ccc; border-radius:8px; margin-bottom:14px; padding:12px; background:#f9f9f9; position:relative;";
            div.innerHTML = `
                <strong>Data:</strong> ${equipe.data || '-'}<br>
                <strong>Equipe:</strong>
                <ul style="margin:6px 0 0 18px; padding:0;">
                    ${(equipe.equipe || []).map(item => `<li>${item.nomeOuDescricao} - ${item.funcaoModeloOuQtd}</li>`).join('')}
                </ul>
                <button onclick="excluirEquipeHistorico('${equipe.id}', this)" style="position:absolute;top:12px;right:12px;background:#f44336;color:#fff;border:none;border-radius:50%;width:28px;height:28px;cursor:pointer;">&#128465;</button>
            `;
            lista.appendChild(div);
        });
    } catch {
        lista.innerHTML = '<p style="color:#c00;">Erro ao carregar histórico.</p>';
    }
}

async function excluirEquipeHistorico(id, btn) {
    if (!confirm("Deseja excluir este registro do histórico?")) return;
    btn.disabled = true;
    try {
        const res = await fetch(`/api/equipes/${id}`, { method: 'DELETE' });
        if (!res.ok) throw new Error();
        btn.parentElement.remove();
    } catch {
        alert('Erro ao excluir registro!');
        btn.disabled = false;
    }
}
</script>
            <!-- Adicione um campo de data para a equipe -->
     </div>
        
        <script>
// Função para salvar a tabela de equipe no backend, com rastreio por data
async function salvarTabelaEquipe() {
    const tabela = document.getElementById("listaEquipe");
    const linhas = tabela.querySelectorAll("tr");
    const dataEquipe = document.getElementById("dataEquipe").value;

    if (!dataEquipe) {
        alert("Por favor, selecione a data da equipe.");
        return;
    }
    if (linhas.length === 0) {
        alert("Adicione pelo menos um colaborador, veículo ou material.");
        return;
    }

    // Monta o array de itens da equipe
    const equipe = [];
    linhas.forEach(linha => {
        const colunas = linha.querySelectorAll("td");
        if (colunas.length >= 2) {
            equipe.push({
                nomeOuDescricao: colunas[0].innerText.trim(),
                funcaoModeloOuQtd: colunas[1].innerText.trim()
            });
        }
    });

    try {
        const res = await fetch('/api/equipes', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                data: dataEquipe,
                equipe
            })
        });
        if (!res.ok) throw new Error();
        alert("Equipe salva com sucesso!");
        // Limpa a tabela e o campo de data
        tabela.innerHTML = "";
        document.getElementById("dataEquipe").value = "";
    } catch {
        alert("Erro ao salvar equipe!");
    }
}
// Carregar equipe do backend para a data selecionada
async function carregarTabelaEquipePorData() {
    const tabela = document.getElementById("listaEquipe");
    const dataEquipe = document.getElementById("dataEquipe").value;
    tabela.innerHTML = "";
    if (!dataEquipe) return;

    try {
        const res = await fetch(`/api/equipes?data=${encodeURIComponent(dataEquipe)}`);
        if (!res.ok) throw new Error();
        const equipes = await res.json();
        // Espera-se que o backend retorne um array, mas só um registro por data
        const equipe = Array.isArray(equipes) ? equipes[0]?.equipe : equipes.equipe;
        if (equipe && equipe.length > 0) {
            equipe.forEach(item => {
                const linha = document.createElement("tr");
                linha.innerHTML = `
                    <td style="padding: 15px; border-bottom: 1px solid #ddd; color: #333;">${item.nomeOuDescricao}</td>
                    <td style="padding: 15px; border-bottom: 1px solid #ddd; color: #333;">${item.funcaoModeloOuQtd}</td>
                    <td style="padding: 15px; border-bottom: 1px solid #ddd; text-align: center;">
                        <button onclick="excluirLinha(this)" style="padding: 8px 15px; background-color: #f44336; color: white; border: none; border-radius: 8px; font-size: 14px; cursor: pointer;">Excluir</button>
                    </td>
                `;
                tabela.appendChild(linha);
            });
        }
    } catch {
        // Se não houver equipe para a data, apenas limpa a tabela
        tabela.innerHTML = "";
    }
}

// Ao mudar a data, carrega a equipe correspondente do backend
document.getElementById("dataEquipe").addEventListener("change", carregarTabelaEquipePorData);

// Ao abrir a tela, se já houver uma data selecionada, carrega a equipe correspondente
document.addEventListener('DOMContentLoaded', carregarTabelaEquipePorData);

// Função para excluir uma linha da tabela (apenas visual, precisa salvar para persistir)
function excluirLinha(botao) {
    const linha = botao.parentElement.parentElement;
    linha.remove();
}
            // Função para adicionar colaboradores à tabela
            function adicionarColaborador() {
                const nome = document.getElementById("nomeColaborador").value;
                const funcao = document.getElementById("funcaoColaborador").value;
        
                if (nome && funcao) {
                    const tabela = document.getElementById("listaEquipe");
                    const linha = document.createElement("tr");
        
                    linha.innerHTML = `
                        <td style="padding: 15px; border-bottom: 1px solid #ddd; color: #333;">${nome}</td>
                        <td style="padding: 15px; border-bottom: 1px solid #ddd; color: #333; text-transform: capitalize;">${funcao}</td>
                        <td style="padding: 15px; border-bottom: 1px solid #ddd; text-align: center;">
                            <button onclick="excluirLinha(this)" style="padding: 8px 15px; background-color: #f44336; color: white; border: none; border-radius: 8px; font-size: 14px; cursor: pointer;">Excluir</button>
                        </td>
                    `;
        
                    tabela.appendChild(linha);
        
                    // Limpa os campos de entrada
                    document.getElementById("nomeColaborador").value = "";
                    document.getElementById("funcaoColaborador").value = "ajudante";
                } else {
                    alert("Por favor, preencha todos os campos.");
                }
            }
        
            // Função para adicionar veículos à tabela
            function adicionarVeiculo() {
                const veiculo = document.getElementById("veiculoSelecionado").value;
        
                if (veiculo) {
                    const tabela = document.getElementById("listaEquipe");
                    const linha = document.createElement("tr");
        
                    linha.innerHTML = `
                        <td style="padding: 15px; border-bottom: 1px solid #ddd; color: #333;">🚗 ${veiculo}</td>
                        <td style="padding: 15px; border-bottom: 1px solid #ddd; color: #333;">Veículo</td>
                        <td style="padding: 15px; border-bottom: 1px solid #ddd; text-align: center;">
                            <button onclick="excluirLinha(this)" style="padding: 8px 15px; background-color: #f44336; color: white; border: none; border-radius: 8px; font-size: 14px; cursor: pointer;">Excluir</button>
                        </td>
                    `;
        
                    tabela.appendChild(linha);
                }
            }
        
            // Função para adicionar materiais à tabela
            function adicionarMaterial() {
                const material = document.getElementById("materialSelecionado").value;
                const quantidade = document.getElementById("quantidadeMaterial").value;
        
                if (material && quantidade) {
                    const tabela = document.getElementById("listaEquipe");
                    const linha = document.createElement("tr");
        
                    linha.innerHTML = `
                        <td style="padding: 15px; border-bottom: 1px solid #ddd; color: #333;">📦 ${material}</td>
                        <td style="padding: 15px; border-bottom: 1px solid #ddd; color: #333;">Quantidade: ${quantidade}</td>
                        <td style="padding: 15px; border-bottom: 1px solid #ddd; text-align: center;">
                            <button onclick="excluirLinha(this)" style="padding: 8px 15px; background-color: #f44336; color: white; border: none; border-radius: 8px; font-size: 14px; cursor: pointer;">Excluir</button>
                        </td>
                    `;
        
                    tabela.appendChild(linha);
        
                    // Limpa os campos de entrada
                    document.getElementById("materialSelecionado").value = "ANDAIMES";
                    document.getElementById("quantidadeMaterial").value = "";
                } else {
                    alert("Por favor, preencha todos os campos.");
                }
            }
        
            // Função para excluir uma linha da tabela
            function excluirLinha(botao) {
                const linha = botao.parentElement.parentElement;
                linha.remove();
            }
        </script>
        </script>
        <div id="visaoGeralScreen" class="screen">
            <h2 style="text-align: center; color: #961c1c; font-size: 28px; margin-bottom: 20px;">Visão Geral</h2>
            <div class="visao-geral-container" style="background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);">
                <!-- Cabeçalho Interativo com Informações da Obra -->
                <div class="cabecalho-obra" style="margin-bottom: 20px;">
                    <h3 style="color: #333; font-size: 22px; margin-bottom: 10px;">Informações da Obra</h3>
                    <p><strong>Nome:</strong> <span id="obraNomeCabecalho" style="color: #555;">-</span></p>
                    <p><strong>Endereço:</strong> <span id="obraEnderecoCabecalho" style="color: #555;">-</span></p>
                    <p><strong>Data de Início:</strong> <span id="dataInicioCabecalho" style="color: #555;">-</span></p>
                    <p><strong>Previsão de Término:</strong> <span id="dataTerminoCabecalho" style="color: #555;">-</span></p>
                </div>
        
                <!-- Andamento da Obra -->
                <div class="progresso-obra" style="margin-bottom: 20px;">
                    <h3 style="color: #333; font-size: 22px; margin-bottom: 10px;">Andamento da Obra</h3>
                    <select id="andamentoObra" onchange="atualizarAndamento()" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; font-size: 16px;">
                        <option value="planejamento">Planejamento</option>
                        <option value="execucao">Execução</option>
                        <option value="finalizacao">Finalização</option>
                    </select>
                    <div id="statusContainer" style="margin-top: 15px; display: flex; align-items: center; gap: 10px;">
                        <span id="statusAndamento" style="font-size: 18px; color: #555;">Planejamento</span>
                        <img id="statusIcon" src="https://via.placeholder.com/40" alt="Ícone de Status" style="width: 40px; height: 40px;">
                    </div>
                </div>
        
                <!-- Ocorrências em Forma de Relatórios -->
                <div class="ocorrencias" style="margin-bottom: 20px;">
                    <h3 style="color: #333; font-size: 22px; margin-bottom: 10px;">Ocorrências</h3>
                    <textarea id="ocorrenciaTexto" placeholder="Descreva a ocorrência..." style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; font-size: 16px;"></textarea>
                    <button onclick="adicionarOcorrencia()" style="margin-top: 10px; padding: 10px 20px; background-color: #961c1c; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer;">Adicionar Ocorrência</button>
                    <ul id="listaOcorrencias" style="margin-top: 15px; list-style: none; padding: 0;">
                        <!-- Ocorrências serão listadas aqui -->
                    </ul>
                </div>
        
                <!-- Documentos da Obra em Pequenas Pastas -->
                <div class="documentos-obra">
                    <h3 style="color: #333; font-size: 22px; margin-bottom: 10px;">Documentos da Obra</h3>
                    <div class="folder" onclick="abrirPasta('Documentos Técnicos')" style="display: inline-block; padding: 15px; background-color: #f4f4f4; border: 1px solid #ccc; border-radius: 8px; margin-right: 10px; cursor: pointer; text-align: center;">
                        📁 Documentos Técnicos
                    </div>
                    <div class="folder" onclick="abrirPasta('Contratos')" style="display: inline-block; padding: 15px; background-color: #f4f4f4; border: 1px solid #ccc; border-radius: 8px; margin-right: 10px; cursor: pointer; text-align: center;">
                        📁 Contratos
                    </div>
                    <div class="folder" onclick="abrirPasta('Relatórios')" style="display: inline-block; padding: 15px; background-color: #f4f4f4; border: 1px solid #ccc; border-radius: 8px; cursor: pointer; text-align: center;">
                        📁 Relatórios
                    </div>
                </div>
            </div>
            <button onclick="showScreen('painelObraScreen')" style="margin-top: 20px; padding: 10px 20px; background-color: #961c1c; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer;">Menu</button>
        </div>
        
        <script>
            function atualizarAndamento() {
                const andamento = document.getElementById("andamentoObra").value;
                const statusText = document.getElementById("statusAndamento");
                const statusIcon = document.getElementById("statusIcon");
        
                statusText.innerText = andamento.charAt(0).toUpperCase() + andamento.slice(1);
        
                // Atualiza o ícone com base no andamento
                if (andamento === "planejamento") {
                    statusIcon.src = "https://via.placeholder.com/40/0000FF/FFFFFF?text=P"; // Ícone de Planejamento
                } else if (andamento === "execucao") {
                    statusIcon.src = "https://via.placeholder.com/40/008000/FFFFFF?text=E"; // Ícone de Execução
                } else if (andamento === "finalizacao") {
                    statusIcon.src = "https://via.placeholder.com/40/FF0000/FFFFFF?text=F"; // Ícone de Finalização
                }
            }
        
            function adicionarOcorrencia() {
                const texto = document.getElementById("ocorrenciaTexto").value;
                if (texto) {
                    const lista = document.getElementById("listaOcorrencias");
                    const li = document.createElement("li");
                    li.style.padding = "10px";
                    li.style.marginBottom = "10px";
                    li.style.border = "1px solid #ccc";
                    li.style.borderRadius = "8px";
                    li.style.backgroundColor = "#f9f9f9";
                    li.style.boxShadow = "0 2px 4px rgba(0, 0, 0, 0.1)";
                    li.innerHTML = `<strong>•</strong> ${texto}`;
                    lista.appendChild(li);
                    document.getElementById("ocorrenciaTexto").value = "";
                } else {
                    alert("Por favor, descreva a ocorrência.");
                }
            }
        
            function abrirPasta(nomePasta) {
                alert(`Abrindo a pasta: ${nomePasta}`);
            }
        </script>
        </script>
            <button onclick="showScreen('painelObraScreen')">Menu</button>
        </div>
        <div id="controlePrazosScreen" class="screen">
            <h2>Controle de Prazos</h2>
            <div class="controle-prazos-container">
                <div class="controle-prazos-header">
                    <h3>Adicionar Novo Prazo</h3>
                    <div class="controle-prazos-buttons">
                        <button onclick="salvarControlePrazos()">Salvar</button>
                        <button onclick="showScreen('painelObraScreen')">Menu</button>
                    </div>
                </div>
                <label for="itemSelecionado">Item:</label>
                <select id="itemSelecionado">
                    <option value="vidros">Vidros</option>
                    <option value="componentes">Componentes</option>
                    <option value="acessorios">Acessórios</option>
                </select>
                <label for="dataSelecionada">Data:</label>
                <input type="date" id="dataSelecionada">
                <label for="notificacoesPrazos">
                    <input type="checkbox" id="notificacoesPrazos">
                    Notificações
                </label>
                <div id="calendar"></div>
                <div id="prazosOutput"></div> <!-- Contêiner para exibir os prazos salvos -->
            </div>
        </div>
        
        <div id="relatoriosScreen" class="screen">
    <h2 style="text-align: center; color: #2c3e50; font-size: 32px; margin-bottom: 30px; font-weight: bold;">Relatórios e Avaliações</h2>
    <div class="relatorios-container" style="background: #ecf0f1; padding: 30px; border-radius: 15px; box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);">
        <h3 style="color: #34495e; font-size: 24px; margin-bottom: 20px; font-weight: bold;">Criar Novo Relatório</h3>
        <select id="tipoRelatorio" style="padding: 15px; border: 1px solid #bdc3c7; border-radius: 10px; font-size: 16px; width: 100%; margin-bottom: 20px; background-color: #fff;">
            <option value="">Selecione o tipo de relatório</option>
            <option value="visita_tecnica">Relatório de Visita Técnica</option>
            <option value="expedicao">Relatório de Expedição</option>
            <option value="rio">Relatório de Informe de Obra (R.I.O)</option>
            <option value="inspecao">Relatório de Inspeção de Obra</option>
            <option value="instalacao">Relatório de Instalação</option>
        </select>
        <input id="tituloRelatorio" type="text" placeholder="Título do Relatório" style="padding: 15px; border: 1px solid #bdc3c7; border-radius: 10px; font-size: 16px; width: 100%; margin-bottom: 15px; background-color: #fff;">
        <textarea id="conteudoRelatorio" placeholder="Escreva o conteúdo do relatório" style="width: 100%; padding: 15px; border: 1px solid #bdc3c7; border-radius: 10px; font-size: 16px; height: 150px; margin-bottom: 20px; background-color: #fff;"></textarea>
        
        <div style="margin-bottom: 20px;">
            <h4 style="color: #34495e; font-size: 18px; margin-bottom: 10px;">Escolher Assinatura:</h4>
            <div id="painelAssinaturas" style="display: flex; flex-wrap: wrap; gap: 15px; justify-content: center;">
                <!-- Assinaturas disponíveis serão exibidas aqui -->
            </div>
        </div>

        <div id="assinaturaSelecionadaPreview" style="text-align: center; margin-top: 20px; display: none;">
            <h4 style="font-size: 18px; color: #34495e;">Assinatura Selecionada:</h4>
            <img id="assinaturaPreview" src="" alt="Assinatura Selecionada" style="width: 200px; height: auto; border: 1px solid #bdc3c7; border-radius: 8px;">
            <p id="nomeAssinaturaPreview" style="margin-top: 10px; font-size: 16px; color: #7f8c8d;"></p>
        </div>

        <button onclick="salvarRelatorio()" style="padding: 15px 25px; background-color: #27ae60; color: white; border: none; border-radius: 10px; font-size: 16px; cursor: pointer; font-weight: bold; transition: background-color 0.3s;">
            Salvar Relatório
        </button>
    </div>

    <h3 style="color: #34495e; font-size: 24px; margin-top: 40px; font-weight: bold;">Relatórios Salvos</h3>
    <div id="listaRelatorios" style="margin-top: 20px; display: flex; flex-wrap: wrap; gap: 15px;">
        <!-- Relatórios salvos aparecerão aqui -->
    </div>

    <script>
        function atualizarListaRelatorios() {
            const listaRelatorios = document.getElementById("listaRelatorios");
            listaRelatorios.innerHTML = "";

            const relatorios = JSON.parse(localStorage.getItem('relatorios')) || [];
            relatorios.forEach((relatorio, index) => {
                const div = document.createElement("div");
                div.style.border = "1px solid #ccc";
                div.style.borderRadius = "8px";
                div.style.padding = "15px";
                div.style.backgroundColor = "#fff";
                div.style.boxShadow = "0 4px 8px rgba(0, 0, 0, 0.1)";
                div.style.width = "300px";
                div.style.position = "relative";

                // Define a cor do status
                let corStatus = "#ccc";
                if (relatorio.status === "Preenchendo") corStatus = "#f0ad4e";
                else if (relatorio.status === "Revisar") corStatus = "#5bc0de";
                else if (relatorio.status === "Aprovado") corStatus = "#5cb85c";

                div.innerHTML = `
                    <h4 style="margin-bottom: 10px; color: #34495e;">${relatorio.titulo}</h4>
                    <p style="margin-bottom: 5px; font-size: 14px; color: #555;"><strong>Tipo:</strong> ${relatorio.tipo}</p>
                    <p style="margin-bottom: 10px; font-size: 14px; color: ${corStatus};"><strong>Status:</strong> ${relatorio.status}</p>
                    <select onchange="atualizarStatus(${index}, this.value)" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 8px; font-size: 14px; margin-bottom: 10px;">
                        <option value="Preenchendo" ${relatorio.status === "Preenchendo" ? "selected" : ""}>Preenchendo</option>
                        <option value="Revisar" ${relatorio.status === "Revisar" ? "selected" : ""}>Revisar</option>
                        <option value="Aprovado" ${relatorio.status === "Aprovado" ? "selected" : ""}>Aprovado</option>
                    </select>
                    <button onclick="visualizarRelatorio(${index})" style="width: 100%; padding: 10px; background-color: #3498db; color: white; border: none; border-radius: 8px; font-size: 14px; cursor: pointer;">Visualizar</button>
                `;

                listaRelatorios.appendChild(div);
            });
        }

        function atualizarStatus(index, novoStatus) {
            const relatorios = JSON.parse(localStorage.getItem('relatorios')) || [];
            if (index >= 0 && index < relatorios.length) {
                relatorios[index].status = novoStatus;
                localStorage.setItem('relatorios', JSON.stringify(relatorios));
                atualizarListaRelatorios();
                alert("Status atualizado com sucesso!");
            } else {
                alert("Erro ao atualizar o status.");
            }
        }

        document.addEventListener('DOMContentLoaded', atualizarListaRelatorios);
    </script>
</div>

<script>
    function carregarPainelAssinaturas() {
        const assinaturas = JSON.parse(localStorage.getItem('assinaturas')) || [];
        const painelAssinaturas = document.getElementById('painelAssinaturas');

        painelAssinaturas.innerHTML = '';
        assinaturas.forEach((assinatura, index) => {
            const div = document.createElement('div');
            div.style.border = "1px solid #ccc";
            div.style.borderRadius = "8px";
            div.style.padding = "10px";
            div.style.textAlign = "center";
            div.style.backgroundColor = "#fff";
            div.style.boxShadow = "0 4px 8px rgba(0, 0, 0, 0.1)";
            div.style.width = "150px";
            div.style.cursor = "pointer";

            div.innerHTML = `
                <img src="${assinatura.imagem}" alt="Assinatura de ${assinatura.nome}" style="width: 100%; height: auto; border-radius: 8px;">
                <p style="margin: 10px 0; font-size: 14px; color: #333;">${assinatura.nome}</p>
                <button onclick="selecionarAssinatura(${index})" style="padding: 8px 12px; background-color: #4CAF50; color: white; border: none; border-radius: 8px; font-size: 14px; cursor: pointer;">Selecionar</button>
            `;
            painelAssinaturas.appendChild(div);
        });
    }

    function selecionarAssinatura(index) {
        const assinaturas = JSON.parse(localStorage.getItem('assinaturas')) || [];
        assinaturaSelecionada = assinaturas[index];

        if (assinaturaSelecionada) {
            const previewDiv = document.getElementById('assinaturaSelecionadaPreview');
            const previewImg = document.getElementById('assinaturaPreview');
            const previewNome = document.getElementById('nomeAssinaturaPreview');

            previewImg.src = assinaturaSelecionada.imagem;
            previewNome.innerText = assinaturaSelecionada.nome;
            previewDiv.style.display = 'block';
        }
    }

    function salvarRelatorio() {
        const tipoRelatorio = document.getElementById("tipoRelatorio").value;
        const titulo = document.getElementById("tituloRelatorio").value;
        const conteudo = document.getElementById("conteudoRelatorio").value;

        if (!tipoRelatorio || !titulo || !conteudo || !assinaturaSelecionada) {
            alert("Por favor, preencha todos os campos e selecione uma assinatura.");
            return;
        }

        const relatorio = {
            tipo: tipoRelatorio,
            titulo,
            conteudo,
            assinatura: assinaturaSelecionada,
            status: avaliacaoAtual || "Não avaliado" // Adiciona o status da avaliação
        };

        const relatorios = JSON.parse(localStorage.getItem('relatorios')) || [];
        relatorios.push(relatorio);
        localStorage.setItem('relatorios', JSON.stringify(relatorios));

        alert('Relatório salvo com sucesso!');
        atualizarListaRelatorios();
    }

    function atualizarListaRelatorios() {
        const listaRelatorios = document.getElementById("listaRelatorios");
        listaRelatorios.innerHTML = "";

        const relatorios = JSON.parse(localStorage.getItem('relatorios')) || [];
        relatorios.forEach((relatorio, index) => {
            const div = document.createElement("div");
            div.style.border = "1px solid #ccc";
            div.style.borderRadius = "8px";
            div.style.padding = "15px";
            div.style.backgroundColor = "#fff";
            div.style.boxShadow = "0 4px 8px rgba(0, 0, 0, 0.1)";
            div.style.cursor = "pointer";
            div.style.position = "relative";

            // Define a cor do status
            let corStatus = "#ccc";
            if (relatorio.status === "Preenchendo") corStatus = "#f0ad4e";
            else if (relatorio.status === "Revisar") corStatus = "#5bc0de";
            else if (relatorio.status === "Aprovado") corStatus = "#5cb85c";

            div.innerHTML = `
                <h4>${relatorio.titulo}</h4>
                <p><strong>Tipo:</strong> ${relatorio.tipo}</p>
                <p><strong>Status:</strong> <span style="color: ${corStatus}; font-weight: bold;">${relatorio.status}</span></p>
                <p><strong>Comentário:</strong> ${relatorio.comentario || 'Nenhum comentário'}</p>
                <button onclick="visualizarRelatorio(${index})" style="margin-top: 10px; padding: 10px 20px; background-color: #4CAF50; color: white; border: none; border-radius: 8px; font-size: 14px; cursor: pointer;">Visualizar</button>
                <button onclick="excluirRelatorio(${index})" style="margin-top: 10px; margin-left: 10px; padding: 10px 20px; background-color: #f44336; color: white; border: none; border-radius: 8px; font-size: 14px; cursor: pointer;">Excluir</button>
            `;

            listaRelatorios.appendChild(div);
        });
    }

    function excluirRelatorio(index) {
        const relatorios = JSON.parse(localStorage.getItem('relatorios')) || [];
        if (index >= 0 && index < relatorios.length) {
            relatorios.splice(index, 1); // Remove o relatório do array
            localStorage.setItem('relatorios', JSON.stringify(relatorios)); // Atualiza o localStorage
            alert("Relatório excluído com sucesso!");
            atualizarListaRelatorios(); // Atualiza a lista exibida
        } else {
            alert("Erro ao excluir o relatório.");
        }
    }

    document.addEventListener('DOMContentLoaded', carregarPainelAssinaturas);
</script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var calendarEl = document.getElementById('calendar');
            var calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'pt-br',
                events: [],
                eventClick: function(info) {
                    alert('Item: ' + info.event.title + '\nData: ' + info.event.start.toLocaleDateString());
                }
            });
            calendar.render();

            const itemColors = {
                vidros: '#3498db',
                componentes: '#2ecc71',
                acessorios: '#e74c3c'
            };

            window.salvarControlePrazos = function() {
                const notificacoes = document.getElementById("notificacoesPrazos").checked;
                const itemSelecionado = document.getElementById("itemSelecionado").value;
                const dataSelecionada = document.getElementById("dataSelecionada").value;

                if (itemSelecionado && dataSelecionada) {
                    calendar.addEvent({
                        title: itemSelecionado,
                        start: dataSelecionada,
                        allDay: true,
                        backgroundColor: itemColors[itemSelecionado],
                        borderColor: itemColors[itemSelecionado]
                    });
                    alert("Controle de prazos salvo com sucesso!");

                    const prazosOutput = document.getElementById("prazosOutput");
                    const div = document.createElement("div");
                    div.innerHTML = ` 
                        <p><strong>Item:</strong> ${itemSelecionado}</p>
                        <p><strong>Data:</strong> ${dataSelecionada}</p>
                        <p><strong>Notificações:</strong> ${notificacoes ? 'Sim' : 'Não'}</p>
                    `;
                    prazosOutput.appendChild(div);

                    document.getElementById("itemSelecionado").value = '';
                    document.getElementById("dataSelecionada").value = '';
                    document.getElementById("notificacoesPrazos").checked = false;
                } else {
                    alert("Por favor, preencha todos os campos.");
                }
            };
        });
        function excluirObra(id, btn) {
    if (!confirm("Tem certeza que deseja excluir esta obra?")) return;
    if (btn) btn.disabled = true; // Desabilita o botão para evitar múltiplos cliques

    fetch(`/api/obras/${id}`, {
        method: 'DELETE'
    })
    .then(res => {
        if (!res.ok) throw new Error('Erro ao excluir obra!');
        return res.json();
    })
    .then(() => {
        alert('Obra excluída!');
        listarObras();
    })
    .catch(() => {
        alert('Erro ao excluir obra!');
    })
    .finally(() => {
        if (btn) btn.disabled = false;
    });
}

    function showScreen(screenId) {
    document.querySelectorAll('.screen').forEach(screen => {
        screen.classList.remove('active');
        screen.style.opacity = 0;
        screen.style.display = 'none'; // Garante que todas as telas fiquem ocultas
    });
    const activeScreen = document.getElementById(screenId);
    if (!activeScreen) {
        console.error('Tela não encontrada:', screenId);
        return;
    }
    activeScreen.style.display = 'block'; // Mostra a tela desejada
    activeScreen.classList.add('active');
    setTimeout(() => {
        activeScreen.style.opacity = 1;
    }, 10);

    // Exemplo: ações específicas ao abrir certas telas
    if (screenId === 'obrasScreen') {
        buscarObra();
    }
    if (screenId === 'vendasScreen') {
        atualizarDashVendas();
        mostrarSubVendas('clientesRegistrados');
    }
}
        function showProfileInfo(profile) {
            const profileInfo = document.getElementById('profileInfo');
            let info = '';

            switch (profile) {
                case 'admin':
                    info = '<p>Admin: Acesso total ao sistema.</p>';
                    break;
                case 'user':
                    info = '<p>User: Acesso limitado a algumas funcionalidades.</p>';
                    break;
                case 'guest':
                    info = '<p>Guest: Acesso restrito a visualizações.</p>';
                    break;
            }

            profileInfo.innerHTML = info;
        }

      // ...existing code...

function salvarObra() {
    const nome = document.getElementById("obraNome").value.trim();
    const endereco = document.getElementById("obraEndereco").value.trim();
    const dataInicio = document.getElementById("dataInicio").value;
    const previsaoTermino = document.getElementById("previsaoTermino").value;
    const descricao = document.getElementById("obraDescricao").value.trim();

    if (!nome || !endereco || !dataInicio || !previsaoTermino || !descricao) {
        alert("Por favor, preencha todos os campos.");
        return;
    }

    fetch('/api/obras', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ nome, endereco, dataInicio, previsaoTermino, descricao })
    })
    .then(res => res.json())
    .then(data => {
        alert('Obra salva!');
        // Limpa os campos do formulário
        document.getElementById("obraNome").value = "";
        document.getElementById("obraEndereco").value = "";
        document.getElementById("dataInicio").value = "";
        document.getElementById("previsaoTermino").value = "";
        document.getElementById("obraDescricao").value = "";
        // Limpa o campo de busca e atualiza a lista
        document.getElementById("buscarObraInput").value = "";
        listarObras(); // Chama a função que SEMPRE lista todas as obras
    })
    .catch(() => alert('Erro ao salvar obra!'));
}

function listarObras() {
    fetch('/api/obras')
        .then(res => res.json())
        .then(obras => {
            const obrasOutput = document.getElementById("obrasOutput");
            obrasOutput.innerHTML = '';
            if (!Array.isArray(obras)) {
                obrasOutput.innerHTML = '<p style="color:#c00;">Erro ao carregar obras.</p>';
                return;
            }
            if (obras.length === 0) {
                obrasOutput.innerHTML = '<p style="color:#888;">Nenhuma obra cadastrada.</p>';
                return;
            }
            obras.forEach(obra => {
                obrasOutput.innerHTML += `
    <div style="border:1px solid #ccc; border-radius:8px; padding:12px; margin-bottom:10px; background:#fff;">
        <p><strong>Nome:</strong> ${obra.nome}</p>
        <p><strong>Endereço:</strong> ${obra.endereco}</p>
        <button onclick="abrirObra('${obra.id}')">Ver Detalhes</button>
        <button onclick="excluirObra('${obra.id}', this)" style="background:#f44336; color:#fff; margin-left:8px;">Excluir</button>
    </div>
`;
            });
        })
        .catch(() => {
            const obrasOutput = document.getElementById("obrasOutput");
            obrasOutput.innerHTML = '<p style="color:#c00;">Erro ao carregar obras.</p>';
        });
}

// Busca filtrando pelo nome, mas SEMPRE mostra tudo se o campo estiver vazio
function buscarObra() {
    const termo = document.getElementById("buscarObraInput").value.trim().toLowerCase();
    if (!termo) {
        listarObras();
        return;
    }
    fetch('/api/obras')
        .then(res => res.json())
        .then(obras => {
            const obrasOutput = document.getElementById("obrasOutput");
            obrasOutput.innerHTML = '';
            const filtradas = obras.filter(obra => obra.nome.toLowerCase().includes(termo));
            if (filtradas.length === 0) {
                obrasOutput.innerHTML = '<p style="color:#888;">Nenhuma obra encontrada.</p>';
                return;
            }
            filtradas.forEach(obra => {
                obrasOutput.innerHTML += `
    <div style="border:1px solid #ccc; border-radius:8px; padding:12px; margin-bottom:10px; background:#fff;">
        <p><strong>Nome:</strong> ${obra.nome}</p>
        <p><strong>Endereço:</strong> ${obra.endereco}</p>
        <button onclick="abrirObra('${obra.id}')">Ver Detalhes</button>
        <button onclick="excluirObra('${obra.id}', this)" style="background:#f44336; color:#fff; margin-left:8px;">Excluir</button>
    </div>
`;
            });
        });
        
}
function excluirObra(id) {
    if (!confirm("Tem certeza que deseja excluir esta obra?")) return;
    fetch(`/api/obras/${id}`, {
        method: 'DELETE'
    })
    .then(res => res.json())
    .then(data => {
        alert('Obra excluída!');
        listarObras();
    })
    .catch(() => alert('Erro ao excluir obra!'));
}

// ...existing code...
function abrirObra(id) {
    fetch(`/api/obras/id/${id}`)
        .then(res => res.json())
        .then(obra => {
            document.getElementById("detalhesObra").innerHTML = `
                <h3>${obra.nome}</h3>
                <p><strong>Endereço:</strong> ${obra.endereco}</p>
                <p><strong>Data de Início:</strong> ${obra.dataInicio ? obra.dataInicio.substring(0,10) : '-'}</p>
                <p><strong>Previsão de Término:</strong> ${obra.previsaoTermino ? obra.previsaoTermino.substring(0,10) : '-'}</p>
                <p><strong>Descrição:</strong> ${obra.descricao}</p>
            `;
            showScreen("detalhesObraScreen");
        })
        .catch(() => alert("Obra não encontrada."));
}


        function atualizarGrafico() {
            const textoRelatorio = document.getElementById("relatorioTexto").value;
            const tipoGrafico = document.getElementById("tipoGrafico").value;
            const dados = textoRelatorio.split(',').map(num => parseInt(num.trim())).filter(num => !isNaN(num));

            if (dados.length === 0) {
                alert("Insira valores numéricos separados por vírgula para atualizar o gráfico.");
                return;
            }

            const ctx = document.getElementById('grafico').getContext('2d');
            if (window.myChart) {
                window.myChart.destroy();
            }
            window.myChart = new Chart(ctx, {
                type: tipoGrafico,
                data: {
                    labels: dados.map((_, i) => `Item ${i + 1}`),
                    datasets: [{
                        label: 'Dados do Relatório',
                        data: dados,
                        backgroundColor: tipoGrafico === 'bar' ? 'rgba(211, 47, 47, 0.6)' : 'rgba(33, 150, 243, 0.6)',
                        borderColor: tipoGrafico === 'bar' ? 'rgba(211, 47, 47, 1)' : 'rgba(33, 150, 243, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    animation: {
                        duration: 1000
                    }
                }
            });
        }

function importarPlanilha() {
    const fileUpload = document.getElementById('fileUpload');
    const tabela = document.getElementById('tabelaDados');
    const visualizacao = document.getElementById('visualizacaoPlanilha');

    if (fileUpload.files.length === 0) {
        alert('Por favor, selecione um arquivo.');
        return;
    }

    const file = fileUpload.files[0];
    const reader = new FileReader();

    reader.onload = function (e) {
        try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const primeiraPlanilha = workbook.Sheets[workbook.SheetNames[0]];
            const conteudo = XLSX.utils.sheet_to_json(primeiraPlanilha, { header: 1 });

            if (conteudo.length === 0) {
                alert('A planilha está vazia ou não contém dados legíveis.');
                return;
            }

            tabela.innerHTML = ''; // Limpa a tabela antes de adicionar novos dados

            conteudo.forEach((linha, index) => {
                const tr = document.createElement('tr');
                linha.forEach((celula) => {
                    const td = document.createElement(index === 0 ? 'th' : 'td');
                    td.style.padding = '10px';
                    td.style.border = '1px solid #ddd';
                    td.style.color = '#333';
                    td.style.backgroundColor = index === 0 ? '#f4f4f4' : '#fff';
                    td.innerText = celula || '';
                    tr.appendChild(td);
                });
                tabela.appendChild(tr);
            });

            visualizacao.style.display = 'block'; // Exibe a tabela
        } catch (error) {
            console.error('Erro ao processar a planilha:', error);
            alert('Ocorreu um erro ao processar a planilha. Verifique se o arquivo está no formato correto.');
        }
    };

    reader.readAsArrayBuffer(file);
}
function visualizarRelatorio(index) {
    const relatorios = JSON.parse(localStorage.getItem('relatorios')) || [];
    const relatorio = relatorios[index];

    if (!relatorio) {
        alert("Relatório não encontrado.");
        return;
    }

    const relatorioVisualizacao = document.getElementById("relatorioVisualizacao");

    relatorioVisualizacao.innerHTML = `
        <div style="text-align: center; margin-bottom: 20px;">
            <h3 style="color: #333; font-size: 22px; font-weight: bold;">${relatorio.titulo}</h3>
            <p style="font-size: 16px; color: #555; margin-bottom: 20px;"><strong>Tipo:</strong> ${relatorio.tipo}</p>
        </div>
        <div style="margin-bottom: 20px;">
            <p style="font-size: 16px; color: #555; line-height: 1.6;">${relatorio.conteudo}</p>
        </div>
        <div style="text-align: center; margin-top: 20px;">
            <h4 style="font-size: 18px; color: #333;">Assinatura do Responsável:</h4>
            <img src="${relatorio.assinatura.imagem}" alt="Assinatura do Autor" style="width: 200px; height: auto; border: 1px solid #ccc; border-radius: 8px;">
            <p style="margin-top: 10px; font-size: 16px; color: #555;">${relatorio.assinatura.nome}</p>
        </div>
    `;

    carregarStatusRelatorio(relatorio.titulo); // Carrega o status salvoalvo
    showScreen("relatorioVisualizacaoScreen");
}

function aprovarRelatorio() {
    alert("Relatório aprovado com sucesso!");
    showScreen("relatoriosScreen");
}

function reprovarRelatorio() {
    alert("Relatório reprovado. Você pode editá-lo.");
    showScreen("relatorioEdicaoScreen");
}

 
function carregarStatusRelatorio(titulo) {
    const relatorios = JSON.parse(localStorage.getItem('relatorios')) || [];
    const relatorio = relatorios.find(r => r.titulo === titulo);

    if (relatorio && relatorio.status) {
        avaliarRelatorio(relatorio.status); // Atualiza a aparência dos botões com base no status salvo
    }
}

function salvarAvaliacaoComCor() {
    const comentario = document.getElementById('comentarioAvaliacao').value;

    if (!avaliacaoAtual) {
        alert('Por favor, selecione um status para o relatório.');
        return;
    }

    if (!comentario.trim()) {
        alert('Por favor, deixe um comentário sobre o relatório.');
        return;
    }

    // Define a cor do painel com base no tipo de avaliação
    const painel = document.getElementById('avaliacaoRelatorio');
    let cor = '';
    if (avaliacaoAtual === 'Preenchendo') {
        cor = '#f0ad4e';
    } else if (avaliacaoAtual === 'Revisar') {
        cor = '#5bc0de';
    } else if (avaliacaoAtual === 'Aprovado') {
        cor = '#5cb85c';
    }

    painel.style.border = `5px solid ${cor}`;

    // Salva a avaliação no localStorage
    const relatorios = JSON.parse(localStorage.getItem('relatorios')) || [];
    const index = relatorios.findIndex(r => r.titulo === document.querySelector('#relatorioVisualizacao h3').innerText);

    if (index !== -1) {
        relatorios[index].status = avaliacaoAtual; // Atualiza o status do relatório
        relatorios[index].comentario = comentario; // Salva o comentário
        localStorage.setItem('relatorios', JSON.stringify(relatorios));
        alert('Avaliação salva com sucesso!');
        document.getElementById('comentarioAvaliacao').value = ''; // Limpa o campo de comentário
    } else {
        alert('Erro ao salvar a avaliação. Relatório não encontrado.');
    }
}

function carregarAvaliacoes() {
    const avaliacoes = JSON.parse(localStorage.getItem('avaliacoes')) || [];
    const relatorioVisualizacao = document.getElementById('relatorioVisualizacao');

    if (avaliacoes.length > 0) {
        const divAvaliacoes = document.createElement('div');
        divAvaliacoes.style.marginTop = '30px';
        divAvaliacoes.innerHTML = `
            <h3 style="text-align: center; color: #333; font-size: 22px; margin-bottom: 20px;">Avaliações Recentes</h3>
        `;

        avaliacoes.forEach(avaliacao => {
            const div = document.createElement('div');
            div.style.padding = '15px';
            div.style.marginBottom = '15px';
            div.style.border = '1px solid #ccc';
            div.style.borderRadius = '8px';
            div.style.backgroundColor = '#fff';
            div.style.boxShadow = '0 2px 4px rgba(0, 0, 0, 0.1)';

            div.innerHTML = `
                <p><strong>Status:</strong> ${avaliacao.status}</p>
                <p><strong>Comentário:</strong> ${avaliacao.comentario}</p>
                <p style="font-size: 12px; color: #555;"><strong>Data:</strong> ${avaliacao.data}</p>
            `;

            divAvaliacoes.appendChild(div);
        });

        relatorioVisualizacao.appendChild(divAvaliacoes);
    }
}
    </script>
<!-- ...existing code... -->
<style>
    /* --- MELHORIA VISUAL DA TELA DE ASSINATURA DIGITAL --- */
    #assinaturaDigitalScreen {
        background: linear-gradient(120deg, #f8f9fa 60%, #e3eafc 100%);
        border-radius: 18px;
        box-shadow: 0 8px 32px rgba(33,60,100,0.13);
        padding: 36px 12px 36px 12px;
        max-width: 1100px;
        margin: 36px auto;
        animation: fadeIn 0.7s;
    }
    #assinaturaDigitalScreen h2 {
        color: #961c1c;
        font-size: 2.2rem;
        margin-bottom: 28px;
        font-weight: bold;
        letter-spacing: 1px;
    }
    #assinaturaDigitalScreen .assinatura-flex {
        display: flex;
        flex-wrap: wrap;
        gap: 32px;
        justify-content: space-between;
    }
    #assinaturaDigitalScreen .painel-assinatura,
    #assinaturaDigitalScreen .painel-lista {
        flex: 1 1 350px;
        background: #fff;
        padding: 28px 24px 24px 24px;
        border-radius: 16px;
        box-shadow: 0 6px 24px rgba(33,60,100,0.10);
        min-width: 320px;
        max-width: 500px;
    }
    #assinaturaDigitalScreen .painel-assinatura {
        border: 2px solid #961c1c22;
    }
    #assinaturaDigitalScreen .painel-lista {
        border: 2px solid #22304a22;
    }
    #assinaturaDigitalScreen label {
        font-size: 16px;
        color: #34495e;
        margin-bottom: 4px;
        font-weight: 500;
    }
    #assinaturaDigitalScreen input[type="color"] {
        border: none;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        box-shadow: 0 2px 8px #22304a11;
        margin-left: 8px;
        cursor: pointer;
    }
    #assinaturaDigitalScreen input[type="number"] {
        width: 60px;
        padding: 6px;
        border-radius: 8px;
        border: 1px solid #bbb;
        margin-left: 8px;
        font-size: 15px;
    }
   /* ...existing code... */
#assinaturaDigitalScreen #canvasAssinatura {
    /* ...existing code... */
    cursor: crosshair;
    /* Adiciona efeito de caneta personalizada animada */
    position: relative;
    z-index: 1;
}
#assinaturaDigitalScreen .caneta-preview {
    position: absolute;
    pointer-events: none;
    z-index: 10;
    width: 36px;
    height: 36px;
    transform: translate(-50%, -50%) scale(1.1);
    transition: filter 0.15s, transform 0.08s;
    filter: drop-shadow(0 2px 6px #0002);
    will-change: left, top;
    display: none;
}
#assinaturaDigitalScreen .caneta-preview.ativa {
    display: block;
    animation: canetaPulse 0.5s infinite alternate;
}
@keyframes canetaPulse {
    0% { transform: translate(-50%, -50%) scale(1.08);}
    100% { transform: translate(-50%, -50%) scale(1.18);}
}
/* ...existing code... */
    #assinaturaDigitalScreen #canvasAssinatura:focus,
    #assinaturaDigitalScreen #canvasAssinatura:hover {
        box-shadow: 0 8px 32px #961c1c22;
        outline: 2px solid #961c1c;
    }
    #assinaturaDigitalScreen .botoes-assinatura {
        display: flex;
        gap: 12px;
        margin-top: 16px;
        justify-content: flex-end;
    }
    #assinaturaDigitalScreen .botoes-assinatura button {
        padding: 12px 22px;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        transition: background 0.2s, transform 0.2s;
        box-shadow: 0 2px 8px #22304a11;
    }
    #assinaturaDigitalScreen .botoes-assinatura button.limpar {
        background: #f44336;
        color: #fff;
    }
    #assinaturaDigitalScreen .botoes-assinatura button.salvar {
        background: #27ae60;
        color: #fff;
    }
    #assinaturaDigitalScreen .botoes-assinatura button:active {
        transform: scale(0.97);
    }
    #assinaturaDigitalScreen .linha-opcoes {
        display: flex;
        gap: 18px;
        align-items: center;
        margin-bottom: 10px;
        margin-top: 10px;
    }
    #assinaturaDigitalScreen #nomeAssinante {
        width: 100%;
        margin-top: 8px;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 8px;
        font-size: 16px;
        background: #f7f9fb;
    }
    #assinaturaDigitalScreen .painel-lista h3 {
        color: #34495e;
        font-size: 20px;
        margin-bottom: 10px;
        font-weight: bold;
    }
    #assinaturaDigitalScreen #listaAssinaturas {
        display: flex;
        flex-wrap: wrap;
        gap: 14px;
        justify-content: center;
        max-height: 400px;
        overflow-y: auto;
    }
    #assinaturaDigitalScreen .assinatura-card {
        border: 1.5px solid #ccc;
        border-radius: 10px;
        padding: 10px 10px 6px 10px;
        text-align: center;
        background: #f8f9fa;
        box-shadow: 0 2px 8px #22304a11;
        width: 140px;
        position: relative;
        transition: box-shadow 0.2s, border 0.2s;
    }
    #assinaturaDigitalScreen .assinatura-card:hover {
        border: 2px solid #961c1c;
        box-shadow: 0 6px 24px #961c1c22;
        z-index: 2;
    }
    #assinaturaDigitalScreen .assinatura-card img {
        width: 100%;
        height: 70px;
        object-fit: contain;
        border-radius: 8px;
        background: #fff;
        border: 1px solid #eee;
    }
    #assinaturaDigitalScreen .assinatura-card .nome {
        margin: 8px 0 4px 0;
        font-size: 14px;
        color: #333;
        font-weight: 500;
    }
    #assinaturaDigitalScreen .assinatura-card .botoes {
        display: flex;
        gap: 6px;
        justify-content: center;
    }
    #assinaturaDigitalScreen .assinatura-card button {
        padding: 6px 10px;
        border: none;
        border-radius: 6px;
        font-size: 13px;
        cursor: pointer;
        background: #27ae60;
        color: #fff;
        font-weight: bold;
        transition: background 0.2s;
    }
    #assinaturaDigitalScreen .assinatura-card button.excluir {
        background: #f44336;
    }
    #assinaturaDigitalScreen .assinatura-card button:active {
        transform: scale(0.97);
    }
    @media (max-width: 900px) {
        #assinaturaDigitalScreen .assinatura-flex {
            flex-direction: column;
            gap: 24px;
            align-items: stretch;
        }
        #assinaturaDigitalScreen .painel-assinatura,
        #assinaturaDigitalScreen .painel-lista {
            max-width: 100%;
        }
    }
    </style>
    
    <!-- ...existing code... -->
    <div id="assinaturaDigitalScreen" class="screen">
        <h2>Assinatura Digital</h2>
        <div class="assinatura-flex">
            <!-- Área de Assinatura -->
            <div class="painel-assinatura">
                <h3 style="color: #961c1c; font-size: 22px; margin-bottom: 10px;">Assine Aqui</h3>
                <canvas id="canvasAssinatura" tabindex="0"></canvas>
                <div class="linha-opcoes">
                    <label>
                        Cor:
                        <input type="color" id="corLinha" value="#000000">
                    </label>
                    <label>
                        Espessura:
                        <input type="number" id="espessuraLinha" value="2" min="1" max="10">
                    </label>
                    <button onclick="desfazerUltimoTraço()" style="background:#ff9800; color:#fff; border:none; border-radius:8px; padding:8px 14px; font-size:14px; font-weight:bold; cursor:pointer;">Desfazer</button>
                </div>
                <div style="margin-top: 10px;">
                    <label for="nomeAssinante">Nome do Assinante:</label>
                    <input type="text" id="nomeAssinante" placeholder="Digite o nome do assinante">
                </div>
                <div class="botoes-assinatura">
                    <button class="limpar" onclick="limparAssinatura()">Limpar</button>
                    <button class="salvar" onclick="salvarAssinatura()">Salvar</button>
                </div>
            </div>
            <!-- Painel de Assinaturas -->
            <div class="painel-lista">
                <h3>Painel de Assinaturas</h3>
                <div id="listaAssinaturas">
                    <!-- Assinaturas salvas aparecerão aqui -->
                </div>
            </div>
        </div>
        <button onclick="showScreen('painelObraScreen')" style="margin-top: 24px; padding: 14px 28px; background-color: #961c1c; color: white; border: none; border-radius: 10px; font-size: 18px; cursor: pointer; font-weight: bold;">Menu</button>
    </div>
    <script>
    // --- MELHORIA FUNCIONALIDADE ASSINATURA DIGITAL ---
    let canvas, ctx, desenhando = false, ultimaPosicao = { x: 0, y: 0 }, trilhas = [], trilhaAtual = [];
    
    function redimensionarCanvas() {
        // Responsivo: mantém proporção ao redimensionar
        const parent = canvas.parentElement;
        canvas.width = parent.offsetWidth - 8;
        canvas.height = 320;
        redesenharTrilhas();
    }
    
    document.addEventListener('DOMContentLoaded', () => {
        canvas = document.getElementById('canvasAssinatura');
        ctx = canvas.getContext('2d');
        redimensionarCanvas();
        window.addEventListener('resize', redimensionarCanvas);
    
        canvas.addEventListener('mousedown', iniciarDesenho);
        canvas.addEventListener('mousemove', desenhar);
        canvas.addEventListener('mouseup', pararDesenho);
        canvas.addEventListener('mouseout', pararDesenho);
    
        canvas.addEventListener('touchstart', iniciarDesenhoTouch, { passive: true });
        canvas.addEventListener('touchmove', desenharTouch, { passive: true });
        canvas.addEventListener('touchend', pararDesenho);
    
        canvas.style.cursor = 'crosshair';
        exibirAssinaturas();
    });
    
    function iniciarDesenho(e) {
        desenhando = true;
        trilhaAtual = [];
        canvas.style.cursor = 'url(https://img.icons8.com/ios-filled/50/000000/pen.png), auto';
        const { offsetX, offsetY } = e;
        ultimaPosicao = { x: offsetX, y: offsetY };
        trilhaAtual.push({ x: offsetX, y: offsetY, cor: corLinha(), esp: espLinha() });
    }
    function desenhar(e) {
        if (!desenhando) return;
        const { offsetX, offsetY } = e;
        ctx.beginPath();
        ctx.moveTo(ultimaPosicao.x, ultimaPosicao.y);
        ctx.lineTo(offsetX, offsetY);
        ctx.strokeStyle = corLinha();
        ctx.lineWidth = espLinha();
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        ctx.stroke();
        ultimaPosicao = { x: offsetX, y: offsetY };
        trilhaAtual.push({ x: offsetX, y: offsetY, cor: corLinha(), esp: espLinha() });
    }
    function pararDesenho() {
        if (desenhando && trilhaAtual.length > 1) {
            trilhas.push([...trilhaAtual]);
        }
        desenhando = false;
        trilhaAtual = [];
        canvas.style.cursor = 'crosshair';
        ctx.closePath();
    }
    function iniciarDesenhoTouch(e) {
        desenhando = true;
        trilhaAtual = [];
        const touch = e.touches[0];
        const rect = canvas.getBoundingClientRect();
        ultimaPosicao = { x: touch.clientX - rect.left, y: touch.clientY - rect.top };
        trilhaAtual.push({ x: ultimaPosicao.x, y: ultimaPosicao.y, cor: corLinha(), esp: espLinha() });
    }
    function desenharTouch(e) {
        if (!desenhando) return;
        const touch = e.touches[0];
        const rect = canvas.getBoundingClientRect();
        const x = touch.clientX - rect.left;
        const y = touch.clientY - rect.top;
        ctx.beginPath();
        ctx.moveTo(ultimaPosicao.x, ultimaPosicao.y);
        ctx.lineTo(x, y);
        ctx.strokeStyle = corLinha();
        ctx.lineWidth = espLinha();
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        ctx.stroke();
        ultimaPosicao = { x, y };
        trilhaAtual.push({ x, y, cor: corLinha(), esp: espLinha() });
    }
    function corLinha() {
        return document.getElementById('corLinha').value;
    }
    function espLinha() {
        return parseInt(document.getElementById('espessuraLinha').value, 10) || 2;
    }
    function limparAssinatura() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        trilhas = [];
        trilhaAtual = [];
    }
    function desfazerUltimoTraço() {
        if (trilhas.length > 0) {
            trilhas.pop();
            redesenharTrilhas();
        }
    }
    function redesenharTrilhas() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        trilhas.forEach(trilha => {
            ctx.beginPath();
            for (let i = 1; i < trilha.length; i++) {
                ctx.strokeStyle = trilha[i].cor;
                ctx.lineWidth = trilha[i].esp;
                ctx.moveTo(trilha[i - 1].x, trilha[i - 1].y);
                ctx.lineTo(trilha[i].x, trilha[i].y);
                ctx.stroke();
            }
            ctx.closePath();
        });
    }
    function salvarAssinatura() {
        if (trilhas.length === 0) {
            alert('Desenhe sua assinatura antes de salvar.');
            return;
        }
        const nomeAssinante = document.getElementById('nomeAssinante').value.trim();
        if (!nomeAssinante) {
            alert('Por favor, insira o nome do assinante antes de salvar.');
            return;
        }
        const assinatura = canvas.toDataURL('image/png');
        const assinaturas = JSON.parse(localStorage.getItem('assinaturas')) || [];
        assinaturas.push({ nome: nomeAssinante, imagem: assinatura });
        localStorage.setItem('assinaturas', JSON.stringify(assinaturas));
        alert('Assinatura salva com sucesso!');
        limparAssinatura();
        exibirAssinaturas();
        document.getElementById('nomeAssinante').value = '';
    }
    function exibirAssinaturas() {
        const listaAssinaturas = document.getElementById('listaAssinaturas');
        listaAssinaturas.innerHTML = '';
        const assinaturas = JSON.parse(localStorage.getItem('assinaturas')) || [];
        assinaturas.forEach((assinatura, index) => {
            const div = document.createElement('div');
            div.className = 'assinatura-card';
            div.innerHTML = `
                <img src="${assinatura.imagem}" alt="Assinatura de ${assinatura.nome}">
                <div class="nome">${assinatura.nome}</div>
                <div class="botoes">
                    <button onclick="usarAssinatura(${index})">Usar</button>
                    <button class="excluir" onclick="excluirAssinatura(${index})">Excluir</button>
                </div>
            `;
            listaAssinaturas.appendChild(div);
        });
    }
    function excluirAssinatura(index) {
        const assinaturas = JSON.parse(localStorage.getItem('assinaturas')) || [];
        assinaturas.splice(index, 1);
        localStorage.setItem('assinaturas', JSON.stringify(assinaturas));
        exibirAssinaturas();
    }
    function usarAssinatura(index) {
        const assinaturas = JSON.parse(localStorage.getItem('assinaturas')) || [];
        const assinaturaSelecionada = assinaturas[index];
        if (assinaturaSelecionada) {
            alert(`Assinatura de ${assinaturaSelecionada.nome} selecionada para validação.`);
        }
    }
  
function validarComAssinatura() {
    const assinaturas = JSON.parse(localStorage.getItem('assinaturas')) || [];
    if (assinaturas.length === 0) {
        alert('Nenhuma assinatura disponível para validação.');
        return;
    }

    const assinaturaSelecionada = assinaturas[0]; // Exemplo: usar a primeira assinatura
    alert(`Validação realizada com a assinatura de ${assinaturaSelecionada.nome}.`);
}

function carregarPainelAssinaturas() {
    const assinaturas = JSON.parse(localStorage.getItem('assinaturas')) || [];
    const painelAssinaturas = document.getElementById('painelAssinaturas');

    painelAssinaturas.innerHTML = '';
    assinaturas.forEach((assinatura, index) => {
        const div = document.createElement('div');
        div.style.border = "1px solid #ccc";
        div.style.borderRadius = "8px";
        div.style.padding = "10px";
        div.style.textAlign = "center";
        div.style.backgroundColor = "#fff";
        div.style.boxShadow = "0 4px 8px rgba(0, 0, 0, 0.1)";
        div.style.width = "150px";
        div.style.cursor = "pointer";

        div.innerHTML = `
            <img src="${assinatura.imagem}" alt="Assinatura de ${assinatura.nome}" style="width: 100%; height: auto; border-radius: 8px;">
            <p style="margin: 10px 0; font-size: 14px; color: #333;">${assinatura.nome}</p>
            <button onclick="selecionarAssinatura(${index})" style="padding: 8px 12px; background-color: #4CAF50; color: white; border: none; border-radius: 8px; font-size: 14px; cursor: pointer;">Selecionar</button>
        `;
        painelAssinaturas.appendChild(div);
    });
}


</script>
<div id="relatorioVisualizacaoScreen" class="screen">
    <h2 style="text-align: center; color: #2c3e50; font-size: 32px; margin-bottom: 30px; font-weight: bold;">Visualização do Relatório</h2>
    <div id="relatorioVisualizacao" style="background: #ffffff; padding: 30px; border-radius: 15px; box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);">
        <!-- O conteúdo do relatório será exibido aqui -->
    </div>
    <div id="avaliacaoRelatorio" style="margin-top: 40px; background: #f8f9fa; padding: 30px; border-radius: 15px; box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);">
        <h3 style="text-align: center; color: #34495e; font-size: 28px; margin-bottom: 20px; font-weight: bold;">Avaliação do Relatório</h3>
        <div style="display: flex; justify-content: center; gap: 15px; margin-bottom: 20px;">
            <button onclick="confirmarAvaliacao('Preenchendo')" id="btnPreenchendo" style="padding: 15px 25px; background-color: #f39c12; color: white; border: none; border-radius: 10px; font-size: 16px; cursor: pointer; font-weight: bold; transition: transform 0.3s;">
                Preenchendo
            </button>
            <button onclick="confirmarAvaliacao('Revisar')" id="btnRevisar" style="padding: 15px 25px; background-color: #3498db; color: white; border: none; border-radius: 10px; font-size: 16px; cursor: pointer; font-weight: bold; transition: transform 0.3s;">
                Revisar
            </button>
            <button onclick="confirmarAvaliacao('Aprovado')" id="btnAprovado" style="padding: 15px 25px; background-color: #2ecc71; color: white; border: none; border-radius: 10px; font-size: 16px; cursor: pointer; font-weight: bold; transition: transform 0.3s;">
                Aprovado
            </button>
        </div>
        <textarea id="comentarioAvaliacao" placeholder="Deixe seu comentário sobre o relatório..." style="width: 100%; padding: 15px; border: 1px solid #bdc3c7; border-radius: 10px; font-size: 16px; height: 120px; margin-bottom: 20px; background-color: #ffffff;"></textarea>
        <button onclick="salvarAvaliacaoComCor()" style="padding: 15px 25px; background-color: #27ae60; color: white; border: none; border-radius: 10px; font-size: 16px; cursor: pointer; font-weight: bold; transition: background-color 0.3s;">
            Salvar Avaliação
        </button>
    </div>
    <button onclick="showScreen('relatoriosScreen')" style="margin-top: 30px; padding: 15px 25px; background-color: #e74c3c; color: white; border: none; border-radius: 10px; font-size: 16px; cursor: pointer; font-weight: bold; transition: transform 0.3s;">
        Voltar
    </button>
</div>

<script>
    let avaliacaoAtual = '';

    function confirmarAvaliacao(status) {
        const confirmacao = confirm(`Você selecionou "${status}". Deseja confirmar esta ação?`);
        if (confirmacao) {
            avaliarRelatorio(status);
        }
    }

    function avaliarRelatorio(status) {
        avaliacaoAtual = status;

        // Atualiza a aparência dos botões
        document.getElementById('btnPreenchendo').style.backgroundColor = status === 'Preenchendo' ? '#f0ad4e' : '#ddd';
        document.getElementById('btnRevisar').style.backgroundColor = status === 'Revisar' ? '#5bc0de' : '#ddd';
        document.getElementById('btnAprovado').style.backgroundColor = status === 'Aprovado' ? '#5cb85c' : '#ddd';

        alert(`Status "${status}" selecionado com sucesso!`);
    }

    function salvarAvaliacaoComCor() {
        const comentario = document.getElementById('comentarioAvaliacao').value;

        if (!avaliacaoAtual) {
            alert('Por favor, selecione um status para o relatório.');
            return;
        }

        if (!comentario.trim()) {
            alert('Por favor, deixe um comentário sobre o relatório.');
            return;
        }

        // Define a cor do painel com base no tipo de avaliação
        const painel = document.getElementById('avaliacaoRelatorio');
        let cor = '';
        if (avaliacaoAtual === 'Preenchendo') {
            cor = '#f0ad4e';
        } else if (avaliacaoAtual === 'Revisar') {
            cor = '#5bc0de';
        } else if (avaliacaoAtual === 'Aprovado') {
            cor = '#5cb85c';
        }

        painel.style.border = `5px solid ${cor}`;

        // Salva a avaliação no localStorage
        const relatorios = JSON.parse(localStorage.getItem('relatorios')) || [];
        const tituloRelatorio = document.querySelector('#relatorioVisualizacao h3').innerText;
        const index = relatorios.findIndex(r => r.titulo === tituloRelatorio);

        if (index !== -1) {
            relatorios[index].status = avaliacaoAtual; // Atualiza o status do relatório
            relatorios[index].comentario = comentario; // Salva o comentário
            localStorage.setItem('relatorios', JSON.stringify(relatorios));
            alert('Avaliação salva com sucesso!');
            document.getElementById('comentarioAvaliacao').value = ''; // Limpa o campo de comentário
        } else {
            alert('Erro ao salvar a avaliação. Relatório não encontrado.');
        }
    }

    function carregarStatusRelatorio(titulo) {
        const relatorios = JSON.parse(localStorage.getItem('relatorios')) || [];
        const relatorio = relatorios.find(r => r.titulo === titulo);

        if (relatorio && relatorio.status) {
            avaliarRelatorio(relatorio.status); // Atualiza a aparência dos botões com base no status salvo
            aplicarCorPainel(relatorio.status); // Aplica a cor do painel com base no status salvo
        }
    }

    function aplicarCorPainel(status) {
        const painel = document.getElementById('avaliacaoRelatorio');
        let cor = '';
        if (status === 'Preenchendo') {
            cor = '#f0ad4e';
        } else if (status === 'Revisar') {
            cor = '#5bc0de';
        } else if (status === 'Aprovado') {
            cor = '#5cb85c';
        }
        painel.style.border = `5px solid ${cor}`;
    }

    // Aplica a cor do painel ao carregar a tela
    document.addEventListener('DOMContentLoaded', () => {
        const tituloRelatorio = document.querySelector('#relatorioVisualizacao h3')?.innerText;
        if (tituloRelatorio) {
            carregarStatusRelatorio(tituloRelatorio);
        }
    });
</script>

<div id="paineisRotinaScreen" class="screen">
    <h2 style="text-align: center; color: #961c1c; font-size: 28px; margin-bottom: 20px; font-weight: bold;">Paineis de Rotina</h2>
    <div class="submenu-container" style="display: flex; flex-direction: column; gap: 15px; padding: 20px;">
        <button onclick="showScreen('programacaoSemanalScreen')" style="padding: 12px 20px; background-color: #961c1c; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer;">Programação Semanal de Instalação</button>
        <button onclick="showScreen('apontamentoProducaoScreen')" style="padding: 12px 20px; background-color: #961c1c; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer;">Apontamento de Produção</button>
        <button onclick="showScreen('statusProducaoScreen')" style="padding: 12px 20px; background-color: #961c1c; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer;">Status de Produção</button>
        <button onclick="showScreen('chegadaMateriaPrimaScreen')" style="padding: 12px 20px; background-color: #961c1c; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer;">Chegada de Matéria-Prima para Semana</button>
    </div>
    <button onclick="showScreen('menuScreen')" style="margin-top: 20px; padding: 12px 20px; background-color: #961c1c; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer;">Voltar ao Menu</button>
</div>

<div id="programacaoSemanalScreen" class="screen">
   <div style="margin-top:18px; display:flex; gap:12px; flex-wrap:wrap; justify-content:center;">
    <button onclick="salvarProgramacaoSemanalBackend()" style="padding:12px 20px; background:#27ae60; color:white; border:none; border-radius:8px; font-size:16px; font-weight:bold;">Salvar Programação Semanal</button>
   
<label for="filtroDataProgramacao" style="font-size:16px;">Filtrar por Data:</label>
    <input type="date" id="filtroDataProgramacao" style="padding:8px; border-radius:8px; border:1px solid #ccc; font-size:15px;">
    <button onclick="filtrarProgramacaoPorData()" style="padding:8px 18px; background:#961c1c; color:white; border:none; border-radius:8px; font-size:14px;">Filtrar</button>
    <button onclick="abrirHistoricoProgramacao()" style="padding:8px 18px; background:#22304a; color:white; border:none; border-radius:8px; font-size:14px;">Ver Histórico</button>
</div>
<!-- Modal para histórico da programação semanal -->
<div id="historicoProgramacaoModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.7); z-index:9999; align-items:center; justify-content:center;">
  <div style="background:#fff; border-radius:18px; padding:32px 24px; max-width:750px; width:95vw; max-height:85vh; overflow:auto; position:relative; box-shadow:0 8px 32px #22304a22;">
    <button onclick="fecharHistoricoProgramacao()" style="position:absolute;top:12px;right:18px;background:#f44336;color:#fff;border:none;border-radius:50%;width:32px;height:32px;font-size:22px;cursor:pointer;">&times;</button>
    <h3 style="margin-bottom:18px; color:#22304a; text-align:center;">Histórico da Programação Semanal</h3>
    <div style="display:flex; flex-wrap:wrap; gap:16px; align-items:center; justify-content:center; margin-bottom:18px;">
      <input type="date" id="filtroHistoricoData" style="padding:8px; border-radius:8px; border:1px solid #ccc; font-size:15px; min-width:150px;">
      <select id="filtroHistoricoVeiculo" style="padding:8px; border-radius:8px; border:1px solid #ccc; font-size:15px; min-width:150px;">
        <option value="">Todos os Veículos</option>
        <option value="Veículo 16">Veículo 16</option>
        <option value="Veículo 14">Veículo 14</option>
        <option value="Veículo 12">Veículo 12</option>
        <option value="Veículo 10">Veículo 10</option>
        <option value="Veículo 8">Veículo 8</option>
        <option value="Veículo 18">Veículo 18</option>
      </select>
      <input type="text" id="filtroHistoricoCliente" placeholder="Buscar cliente/líder/ajudante" style="padding:8px; border-radius:8px; border:1px solid #ccc; font-size:15px; min-width:180px;">
      <button onclick="aplicarFiltroHistorico()" style="padding:8px 18px; background:#22304a; color:white; border:none; border-radius:8px; font-size:14px;">Filtrar</button>
      <button onclick="resetarFiltroHistorico()" style="padding:8px 18px; background:#aaa; color:white; border:none; border-radius:8px; font-size:14px;">Limpar</button>
      <button onclick="fecharHistoricoProgramacao()" style="padding:8px 18px; background:#961c1c; color:white; border:none; border-radius:8px; font-size:14px;">Voltar</button>
    </div>
    <div id="listaHistoricoProgramacao"></div>
  </div>
</div>
    <h2 style="text-align:center; color:#961c1c; font-size:28px; margin-bottom:20px;">Programação Semanal de Instalação</h2>
    <div style="background:#fff; padding:24px; border-radius:16px; box-shadow:0 4px 16px rgba(150,28,28,0.10); margin-bottom:32px;">
        <h3 style="color:#34495e; font-size:22px; margin-bottom:18px; font-weight:bold; text-align:center;">
            Programação de Veículos por Dia da Semana
        </h3>
        <div style="overflow-x:auto;">
            <table id="tabelaProgramacaoVeiculos">
                <thead>
                    <tr>
                        <th>Veículo</th>
                        <th>Segunda</th>
                        <th>Terça</th>
                        <th>Quarta</th>
                        <th>Quinta</th>
                        <th>Sexta</th>
                        <th>Sábado</th>
                    </tr>
                    <tr style="background-color: #f4f4f4; color: #333;">
                        <th>Data</th>
                        <td><input type="date" id="progSegundaData" onchange="atualizarDatasProgramacao('progSegundaData')"></td>
                        <td><input type="date" id="progTercaData" onchange="atualizarDatasProgramacao('progTercaData')"></td>
                        <td><input type="date" id="progQuartaData" onchange="atualizarDatasProgramacao('progQuartaData')"></td>
                        <td><input type="date" id="progQuintaData" onchange="atualizarDatasProgramacao('progQuintaData')"></td>
                        <td><input type="date" id="progSextaData" onchange="atualizarDatasProgramacao('progSextaData')"></td>
                        <td><input type="date" id="progSabadoData" onchange="atualizarDatasProgramacao('progSabadoData')"></td>
                    </tr>
                </thead>
                <tbody>
                    <!-- Linha Veículo 16 -->
                    <tr>
                        <td>Veículo 16</td>
                       <td>
    <div class="cell-content">
        <div class="cell-label">Cliente:</div>
        <div class="cell-edit" contenteditable="true"></div>
        <div class="cell-label lider">Líder de Instalação:</div>
        <div class="cell-edit" contenteditable="true"></div>
        <div class="cell-label ajudantes">Ajudantes:</div>
        <div class="cell-edit ajudantes" contenteditable="true"></div>
    <span class="info-icone"
      data-veiculo="Veículo 16"
      data-dia="Segunda"
      onclick="abrirModalInfo(this)"
      style="cursor:pointer; color:#2980b9; font-size:18px; margin-left:6px;"
      title="Mais informações">&#9432;</span></div>
</td>
                       <td>
    <div class="cell-content">
        <div class="cell-label">Cliente:</div>
        <div class="cell-edit" contenteditable="true"></div>
        <div class="cell-label lider">Líder de Instalação:</div>
        <div class="cell-edit" contenteditable="true"></div>
        <div class="cell-label ajudantes">Ajudantes:</div>
        <div class="cell-edit ajudantes" contenteditable="true"></div>
    <span class="info-icone"
      data-veiculo="Veículo 16"
      data-dia="Terça"
      onclick="abrirModalInfo(this)"
      style="cursor:pointer; color:#2980b9; font-size:18px; margin-left:6px;"
      title="Mais informações">&#9432;</span></div></div>
</td>
                        <td>
    <div class="cell-content">
        <div class="cell-label">Cliente:</div>
        <div class="cell-edit" contenteditable="true"></div>
        <div class="cell-label lider">Líder de Instalação:</div>
        <div class="cell-edit" contenteditable="true"></div>
        <div class="cell-label ajudantes">Ajudantes:</div>
        <div class="cell-edit ajudantes" contenteditable="true"></div>
    <span class="info-icone"
      data-veiculo="Veículo 16"
      data-dia="Quarta"
      onclick="abrirModalInfo(this)"
      style="cursor:pointer; color:#2980b9; font-size:18px; margin-left:6px;"
      title="Mais informações">&#9432;</span></div></div>
</td>
                       <td>
    <div class="cell-content">
        <div class="cell-label">Cliente:</div>
        <div class="cell-edit" contenteditable="true"></div>
        <div class="cell-label lider">Líder de Instalação:</div>
        <div class="cell-edit" contenteditable="true"></div>
        <div class="cell-label ajudantes">Ajudantes:</div>
        <div class="cell-edit ajudantes" contenteditable="true"></div>
    <span class="info-icone"
      data-veiculo="Veículo 16"
      data-dia="quinta"
      onclick="abrirModalInfo(this)"
      style="cursor:pointer; color:#2980b9; font-size:18px; margin-left:6px;"
      title="Mais informações">&#9432;</span></div></div>
</td>
                        <td>
    <div class="cell-content">
        <div class="cell-label">Cliente:</div>
        <div class="cell-edit" contenteditable="true"></div>
        <div class="cell-label lider">Líder de Instalação:</div>
        <div class="cell-edit" contenteditable="true"></div>
        <div class="cell-label ajudantes">Ajudantes:</div>
        <div class="cell-edit ajudantes" contenteditable="true"></div>
    <span class="info-icone"
      data-veiculo="Veículo 16"
      data-dia="sexta"
      onclick="abrirModalInfo(this)"
      style="cursor:pointer; color:#2980b9; font-size:18px; margin-left:6px;"
      title="Mais informações">&#9432;</span></div></div>
</td>
                        <td>
    <div class="cell-content">
        <div class="cell-label">Cliente:</div>
        <div class="cell-edit" contenteditable="true"></div>
        <div class="cell-label lider">Líder de Instalação:</div>
        <div class="cell-edit" contenteditable="true"></div>
        <div class="cell-label ajudantes">Ajudantes:</div>
        <div class="cell-edit ajudantes" contenteditable="true"></div>
   <span class="info-icone"
      data-veiculo="Veículo 16"
      data-dia="sabado"
      onclick="abrirModalInfo(this)"
      style="cursor:pointer; color:#2980b9; font-size:18px; margin-left:6px;"
      title="Mais informações">&#9432;</span></div> </div>
</td>
                    </tr>
                    <!-- Repita para os outros veículos -->
                  <tr>
    <td>Veículo 14</td>
    <td>
        <div class="cell-content">
            <div class="cell-label">Cliente:</div>
            <div class="cell-edit" contenteditable="true"></div>
            <div class="cell-label lider">Líder de Instalação:</div>
            <div class="cell-edit" contenteditable="true"></div>
            <div class="cell-label ajudantes">Ajudantes:</div>
            <div class="cell-edit ajudantes" contenteditable="true"></div>
        <span class="info-icone"
      data-veiculo="Veículo 14"
      data-dia="Segunda"
      onclick="abrirModalInfo(this)"
      style="cursor:pointer; color:#2980b9; font-size:18px; margin-left:6px;"
      title="Mais informações">&#9432;</span></div>
    </td>
    <td>
        <div class="cell-content">
            <div class="cell-label">Cliente:</div>
            <div class="cell-edit" contenteditable="true"></div>
            <div class="cell-label lider">Líder de Instalação:</div>
            <div class="cell-edit" contenteditable="true"></div>
            <div class="cell-label ajudantes">Ajudantes:</div>
            <div class="cell-edit ajudantes" contenteditable="true"></div>
        <span class="info-icone"
      data-veiculo="Veículo 14"
      data-dia="Terça"
      onclick="abrirModalInfo(this)"
      style="cursor:pointer; color:#2980b9; font-size:18px; margin-left:6px;"
      title="Mais informações">&#9432;</span></div>
    </td>
    <td>
        <div class="cell-content">
            <div class="cell-label">Cliente:</div>
            <div class="cell-edit" contenteditable="true"></div>
            <div class="cell-label lider">Líder de Instalação:</div>
            <div class="cell-edit" contenteditable="true"></div>
            <div class="cell-label ajudantes">Ajudantes:</div>
            <div class="cell-edit ajudantes" contenteditable="true"></div>
       <span class="info-icone"
      data-veiculo="Veículo 14"
      data-dia="Quarta"
      onclick="abrirModalInfo(this)"
      style="cursor:pointer; color:#2980b9; font-size:18px; margin-left:6px;"
      title="Mais informações">&#9432;</span> </div>
    </td>
    <td>
        <div class="cell-content">
            <div class="cell-label">Cliente:</div>
            <div class="cell-edit" contenteditable="true"></div>
            <div class="cell-label lider">Líder de Instalação:</div>
            <div class="cell-edit" contenteditable="true"></div>
            <div class="cell-label ajudantes">Ajudantes:</div>
            <div class="cell-edit ajudantes" contenteditable="true"></div>
        <span class="info-icone"
      data-veiculo="Veículo 14"
      data-dia="Quinta"
      onclick="abrirModalInfo(this)"
      style="cursor:pointer; color:#2980b9; font-size:18px; margin-left:6px;"
      title="Mais informações">&#9432;</span></div>
    </td>
    <td>
        <div class="cell-content">
            <div class="cell-label">Cliente:</div>
            <div class="cell-edit" contenteditable="true"></div>
            <div class="cell-label lider">Líder de Instalação:</div>
            <div class="cell-edit" contenteditable="true"></div>
            <div class="cell-label ajudantes">Ajudantes:</div>
            <div class="cell-edit ajudantes" contenteditable="true"></div>
       <span class="info-icone"
      data-veiculo="Veículo 14"
      data-dia="Sexta"
      onclick="abrirModalInfo(this)"
      style="cursor:pointer; color:#2980b9; font-size:18px; margin-left:6px;"
      title="Mais informações">&#9432;</span> </div>
    </td>
    <td>
        <div class="cell-content">
            <div class="cell-label">Cliente:</div>
            <div class="cell-edit" contenteditable="true"></div>
            <div class="cell-label lider">Líder de Instalação:</div>
            <div class="cell-edit" contenteditable="true"></div>
            <div class="cell-label ajudantes">Ajudantes:</div>
            <div class="cell-edit ajudantes" contenteditable="true"></div>
        <span class="info-icone"
      data-veiculo="Veículo 14"
      data-dia="sabado"
      onclick="abrirModalInfo(this)"
      style="cursor:pointer; color:#2980b9; font-size:18px; margin-left:6px;"
      title="Mais informações">&#9432;</span></div>
    </td>
</tr>
                    <tr>
                        <td>Veículo 12</td>
                        <td>
        <div class="cell-content">
            <div class="cell-label">Cliente:</div>
            <div class="cell-edit" contenteditable="true"></div>
            <div class="cell-label lider">Líder de Instalação:</div>
            <div class="cell-edit" contenteditable="true"></div>
            <div class="cell-label ajudantes">Ajudantes:</div>
            <div class="cell-edit ajudantes" contenteditable="true"></div>
        <span class="info-icone"
      data-veiculo="Veículo 12"
      data-dia="Segunda"
      onclick="abrirModalInfo(this)"
      style="cursor:pointer; color:#2980b9; font-size:18px; margin-left:6px;"
      title="Mais informações">&#9432;</span></div>
    </td>
    <td>
        <div class="cell-content">
            <div class="cell-label">Cliente:</div>
            <div class="cell-edit" contenteditable="true"></div>
            <div class="cell-label lider">Líder de Instalação:</div>
            <div class="cell-edit" contenteditable="true"></div>
            <div class="cell-label ajudantes">Ajudantes:</div>
            <div class="cell-edit ajudantes" contenteditable="true"></div>
           <span class="info-icone"
      data-veiculo="Veículo 12"
      data-dia="Terça"
      onclick="abrirModalInfo(this)"
      style="cursor:pointer; color:#2980b9; font-size:18px; margin-left:6px;"
      title="Mais informações">&#9432;</span></div>
    </td></div>
    </td>
    <td>
        <div class="cell-content">
            <div class="cell-label">Cliente:</div>
            <div class="cell-edit" contenteditable="true"></div>
            <div class="cell-label lider">Líder de Instalação:</div>
            <div class="cell-edit" contenteditable="true"></div>
            <div class="cell-label ajudantes">Ajudantes:</div>
            <div class="cell-edit ajudantes" contenteditable="true"></div>
           <span class="info-icone"
      data-veiculo="Veículo 12"
      data-dia="Quarta"
      onclick="abrirModalInfo(this)"
      style="cursor:pointer; color:#2980b9; font-size:18px; margin-left:6px;"
      title="Mais informações">&#9432;</span></div>
    </td></div>
    </td>
    <td>
        <div class="cell-content">
            <div class="cell-label">Cliente:</div>
            <div class="cell-edit" contenteditable="true"></div>
            <div class="cell-label lider">Líder de Instalação:</div>
            <div class="cell-edit" contenteditable="true"></div>
            <div class="cell-label ajudantes">Ajudantes:</div>
            <div class="cell-edit ajudantes" contenteditable="true"></div>
          <span class="info-icone"
      data-veiculo="Veículo 12"
      data-dia="Quinta"
      onclick="abrirModalInfo(this)"
      style="cursor:pointer; color:#2980b9; font-size:18px; margin-left:6px;"
      title="Mais informações">&#9432;</span></div>
    </td></div>
    </td>
    <td>
        <div class="cell-content">
            <div class="cell-label">Cliente:</div>
            <div class="cell-edit" contenteditable="true"></div>
            <div class="cell-label lider">Líder de Instalação:</div>
            <div class="cell-edit" contenteditable="true"></div>
            <div class="cell-label ajudantes">Ajudantes:</div>
            <div class="cell-edit ajudantes" contenteditable="true"></div>
          <span class="info-icone"
      data-veiculo="Veículo 12"
      data-dia="Sexta"
      onclick="abrirModalInfo(this)"
      style="cursor:pointer; color:#2980b9; font-size:18px; margin-left:6px;"
      title="Mais informações">&#9432;</span></div>
    </td></div>
    </td>
    <td>
        <div class="cell-content">
            <div class="cell-label">Cliente:</div>
            <div class="cell-edit" contenteditable="true"></div>
            <div class="cell-label lider">Líder de Instalação:</div>
            <div class="cell-edit" contenteditable="true"></div>
            <div class="cell-label ajudantes">Ajudantes:</div>
            <div class="cell-edit ajudantes" contenteditable="true"></div>
           <span class="info-icone"
      data-veiculo="Veículo 12"
      data-dia="sabado"
      onclick="abrirModalInfo(this)"
      style="cursor:pointer; color:#2980b9; font-size:18px; margin-left:6px;"
      title="Mais informações">&#9432;</span></div>
    </td></div>
    </td>
</tr>
                        <td>Veículo 10</td>
                        <td>
        <div class="cell-content">
            <div class="cell-label">Cliente:</div>
            <div class="cell-edit" contenteditable="true"></div>
            <div class="cell-label lider">Líder de Instalação:</div>
            <div class="cell-edit" contenteditable="true"></div>
            <div class="cell-label ajudantes">Ajudantes:</div>
            <div class="cell-edit ajudantes" contenteditable="true"></div>
          <span class="info-icone"
      data-veiculo="Veículo 10"
      data-dia="Segunda"
      onclick="abrirModalInfo(this)"
      style="cursor:pointer; color:#2980b9; font-size:18px; margin-left:6px;"
      title="Mais informações">&#9432;</span></div>
    </td></div>
    </td>
    <td>
        <div class="cell-content">
            <div class="cell-label">Cliente:</div>
            <div class="cell-edit" contenteditable="true"></div>
            <div class="cell-label lider">Líder de Instalação:</div>
            <div class="cell-edit" contenteditable="true"></div>
            <div class="cell-label ajudantes">Ajudantes:</div>
            <div class="cell-edit ajudantes" contenteditable="true"></div>
        <span class="info-icone"
      data-veiculo="Veículo 10"
      data-dia="Terça"
      onclick="abrirModalInfo(this)"
      style="cursor:pointer; color:#2980b9; font-size:18px; margin-left:6px;"
      title="Mais informações">&#9432;</span></div>
    </td></div>
    </td>
    <td>
        <div class="cell-content">
            <div class="cell-label">Cliente:</div>
            <div class="cell-edit" contenteditable="true"></div>
            <div class="cell-label lider">Líder de Instalação:</div>
            <div class="cell-edit" contenteditable="true"></div>
            <div class="cell-label ajudantes">Ajudantes:</div>
            <div class="cell-edit ajudantes" contenteditable="true"></div>
        <span class="info-icone"
      data-veiculo="Veículo 10"
      data-dia="quarta"
      onclick="abrirModalInfo(this)"
      style="cursor:pointer; color:#2980b9; font-size:18px; margin-left:6px;"
      title="Mais informações">&#9432;</span></div>
    </td> </div>
    </td>
    <td>
        <div class="cell-content">
            <div class="cell-label">Cliente:</div>
            <div class="cell-edit" contenteditable="true"></div>
            <div class="cell-label lider">Líder de Instalação:</div>
            <div class="cell-edit" contenteditable="true"></div>
            <div class="cell-label ajudantes">Ajudantes:</div>
            <div class="cell-edit ajudantes" contenteditable="true"></div>
        <span class="info-icone"
      data-veiculo="Veículo 10"
      data-dia="Quinta"
      onclick="abrirModalInfo(this)"
      style="cursor:pointer; color:#2980b9; font-size:18px; margin-left:6px;"
      title="Mais informações">&#9432;</span></div>
    </td></div>
    </td>
    <td>
        <div class="cell-content">
            <div class="cell-label">Cliente:</div>
            <div class="cell-edit" contenteditable="true"></div>
            <div class="cell-label lider">Líder de Instalação:</div>
            <div class="cell-edit" contenteditable="true"></div>
            <div class="cell-label ajudantes">Ajudantes:</div>
            <div class="cell-edit ajudantes" contenteditable="true"></div>
       <span class="info-icone"
      data-veiculo="Veículo 10"
      data-dia="sexta"
      onclick="abrirModalInfo(this)"
      style="cursor:pointer; color:#2980b9; font-size:18px; margin-left:6px;"
      title="Mais informações">&#9432;</span></div>
    </td></div>
    </td>
    <td>
        <div class="cell-content">
            <div class="cell-label">Cliente:</div>
            <div class="cell-edit" contenteditable="true"></div>
            <div class="cell-label lider">Líder de Instalação:</div>
            <div class="cell-edit" contenteditable="true"></div>
            <div class="cell-label ajudantes">Ajudantes:</div>
            <div class="cell-edit ajudantes" contenteditable="true"></div>
       <span class="info-icone"
      data-veiculo="Veículo 10"
      data-dia="sabado"
      onclick="abrirModalInfo(this)"
      style="cursor:pointer; color:#2980b9; font-size:18px; margin-left:6px;"
      title="Mais informações">&#9432;</span></div>
    </td></div>
    </td>
</tr>
                        <td>Veículo 8</td>
                        <td>
        <div class="cell-content">
            <div class="cell-label">Cliente:</div>
            <div class="cell-edit" contenteditable="true"></div>
            <div class="cell-label lider">Líder de Instalação:</div>
            <div class="cell-edit" contenteditable="true"></div>
            <div class="cell-label ajudantes">Ajudantes:</div>
            <div class="cell-edit ajudantes" contenteditable="true"></div>
        <span class="info-icone"
      data-veiculo="Veículo 8"
      data-dia="Segunda"
      onclick="abrirModalInfo(this)"
      style="cursor:pointer; color:#2980b9; font-size:18px; margin-left:6px;"
      title="Mais informações">&#9432;</span></div>
    </td></div>
    </td>
    <td>
        <div class="cell-content">
            <div class="cell-label">Cliente:</div>
            <div class="cell-edit" contenteditable="true"></div>
            <div class="cell-label lider">Líder de Instalação:</div>
            <div class="cell-edit" contenteditable="true"></div>
            <div class="cell-label ajudantes">Ajudantes:</div>
            <div class="cell-edit ajudantes" contenteditable="true"></div>
        <span class="info-icone"
      data-veiculo="Veículo 8"
      data-dia="Terça"
      onclick="abrirModalInfo(this)"
      style="cursor:pointer; color:#2980b9; font-size:18px; margin-left:6px;"
      title="Mais informações">&#9432;</span></div>
    </td>
</div>
    </td>
    <td>
        <div class="cell-content">
            <div class="cell-label">Cliente:</div>
            <div class="cell-edit" contenteditable="true"></div>
            <div class="cell-label lider">Líder de Instalação:</div>
            <div class="cell-edit" contenteditable="true"></div>
            <div class="cell-label ajudantes">Ajudantes:</div>
            <div class="cell-edit ajudantes" contenteditable="true"></div>
         <span class="info-icone"
      data-veiculo="Veículo 8"
      data-dia="Quarta"
      onclick="abrirModalInfo(this)"
      style="cursor:pointer; color:#2980b9; font-size:18px; margin-left:6px;"
      title="Mais informações">&#9432;</span></div>
    </td></div>
    </td>
    <td>
        <div class="cell-content">
            <div class="cell-label">Cliente:</div>
            <div class="cell-edit" contenteditable="true"></div>
            <div class="cell-label lider">Líder de Instalação:</div>
            <div class="cell-edit" contenteditable="true"></div>
            <div class="cell-label ajudantes">Ajudantes:</div>
            <div class="cell-edit ajudantes" contenteditable="true"></div>
         <span class="info-icone"
      data-veiculo="Veículo 8"
      data-dia="quinta"
      onclick="abrirModalInfo(this)"
      style="cursor:pointer; color:#2980b9; font-size:18px; margin-left:6px;"
      title="Mais informações">&#9432;</span></div>
    </td></div>
    </td>
    <td>
        <div class="cell-content">
            <div class="cell-label">Cliente:</div>
            <div class="cell-edit" contenteditable="true"></div>
            <div class="cell-label lider">Líder de Instalação:</div>
            <div class="cell-edit" contenteditable="true"></div>
            <div class="cell-label ajudantes">Ajudantes:</div>
            <div class="cell-edit ajudantes" contenteditable="true"></div>
       <span class="info-icone"
      data-veiculo="Veículo 8"
      data-dia="Sexta"
      onclick="abrirModalInfo(this)"
      style="cursor:pointer; color:#2980b9; font-size:18px; margin-left:6px;"
      title="Mais informações">&#9432;</span></div>
    </td></div>
    </td>
    <td>
        <div class="cell-content">
            <div class="cell-label">Cliente:</div>
            <div class="cell-edit" contenteditable="true"></div>
            <div class="cell-label lider">Líder de Instalação:</div>
            <div class="cell-edit" contenteditable="true"></div>
            <div class="cell-label ajudantes">Ajudantes:</div>
            <div class="cell-edit ajudantes" contenteditable="true"></div>
         <span class="info-icone"
      data-veiculo="Veículo 8"
      data-dia="sabado"
      onclick="abrirModalInfo(this)"
      style="cursor:pointer; color:#2980b9; font-size:18px; margin-left:6px;"
      title="Mais informações">&#9432;</span></div>
    </td></div>
    </td>
</tr>
                        <td>Veículo 18</td>
                        <td>
        <div class="cell-content">
            <div class="cell-label">Cliente:</div>
            <div class="cell-edit" contenteditable="true"></div>
            <div class="cell-label lider">Líder de Instalação:</div>
            <div class="cell-edit" contenteditable="true"></div>
            <div class="cell-label ajudantes">Ajudantes:</div>
            <div class="cell-edit ajudantes" contenteditable="true"></div>
         <span class="info-icone"
      data-veiculo="Veículo 18"
      data-dia="segunda"
      onclick="abrirModalInfo(this)"
      style="cursor:pointer; color:#2980b9; font-size:18px; margin-left:6px;"
      title="Mais informações">&#9432;</span></div>
    </td></div>
    </td>
    <td>
        <div class="cell-content">
            <div class="cell-label">Cliente:</div>
            <div class="cell-edit" contenteditable="true"></div>
            <div class="cell-label lider">Líder de Instalação:</div>
            <div class="cell-edit" contenteditable="true"></div>
            <div class="cell-label ajudantes">Ajudantes:</div>
            <div class="cell-edit ajudantes" contenteditable="true"></div>
         <span class="info-icone"
      data-veiculo="Veículo 18"
      data-dia="Terça"
      onclick="abrirModalInfo(this)"
      style="cursor:pointer; color:#2980b9; font-size:18px; margin-left:6px;"
      title="Mais informações">&#9432;</span></div>
    </td> </div>
    </td>
    <td>
        <div class="cell-content">
            <div class="cell-label">Cliente:</div>
            <div class="cell-edit" contenteditable="true"></div>
            <div class="cell-label lider">Líder de Instalação:</div>
            <div class="cell-edit" contenteditable="true"></div>
            <div class="cell-label ajudantes">Ajudantes:</div>
            <div class="cell-edit ajudantes" contenteditable="true"></div>
        <span class="info-icone"
      data-veiculo="Veículo 18"
      data-dia="Quarta"
      onclick="abrirModalInfo(this)"
      style="cursor:pointer; color:#2980b9; font-size:18px; margin-left:6px;"
      title="Mais informações">&#9432;</span></div>
    </td></div>
    </td>
    <td>
        <div class="cell-content">
            <div class="cell-label">Cliente:</div>
            <div class="cell-edit" contenteditable="true"></div>
            <div class="cell-label lider">Líder de Instalação:</div>
            <div class="cell-edit" contenteditable="true"></div>
            <div class="cell-label ajudantes">Ajudantes:</div>
            <div class="cell-edit ajudantes" contenteditable="true"></div>
        <span class="info-icone"
      data-veiculo="Veículo 18"
      data-dia="Quinta"
      onclick="abrirModalInfo(this)"
      style="cursor:pointer; color:#2980b9; font-size:18px; margin-left:6px;"
      title="Mais informações">&#9432;</span></div>
    </td> </div>
    </td>
    <td>
        <div class="cell-content">
            <div class="cell-label">Cliente:</div>
            <div class="cell-edit" contenteditable="true"></div>
            <div class="cell-label lider">Líder de Instalação:</div>
            <div class="cell-edit" contenteditable="true"></div>
            <div class="cell-label ajudantes">Ajudantes:</div>
            <div class="cell-edit ajudantes" contenteditable="true"></div>
        <span class="info-icone"
      data-veiculo="Veículo 18"
      data-dia="Sexta"
      onclick="abrirModalInfo(this)"
      style="cursor:pointer; color:#2980b9; font-size:18px; margin-left:6px;"
      title="Mais informações">&#9432;</span></div>
    </td></div>
    </td>
    <td>
        <div class="cell-content">
            <div class="cell-label">Cliente:</div>
            <div class="cell-edit" contenteditable="true"></div>
            <div class="cell-label lider">Líder de Instalação:</div>
            <div class="cell-edit" contenteditable="true"></div>
            <div class="cell-label ajudantes">Ajudantes:</div>
            <div class="cell-edit ajudantes" contenteditable="true"></div>
         <span class="info-icone"
      data-veiculo="Veículo 18"
      data-dia="sabado"
      onclick="abrirModalInfo(this)"
      style="cursor:pointer; color:#2980b9; font-size:18px; margin-left:6px;"
      title="Mais informações">&#9432;</span></div>
    </td></div>
    </td>
</tr>
                </tbody>
            </table>
        </div>
    </div>
    <button onclick="showScreen('paineisRotinaScreen')" style="margin-top:20px; padding:12px 20px; background-color:#961c1c; color:white; border:none; border-radius:8px; font-size:16px; cursor:pointer;">Voltar</button>
</div>
<!-- Modal aprimorado para informações extras -->
<!-- Modal aprimorado para informações extras -->
<div id="modalInfoTabela" style="display:none; position:fixed; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.25); z-index:9999; align-items:center; justify-content:center;">
  <div style="background:#fff; border-radius:18px; max-width:420px; margin:auto; padding:32px 28px 24px 28px; box-shadow:0 8px 32px #22304a33; position:relative; min-width:320px;">
    <button onclick="fecharModalInfo()" style="position:absolute; right:18px; top:14px; background:none; border:none; font-size:28px; color:#961c1c; cursor:pointer; line-height:1;">&times;</button>
    <h3 id="modalTituloInfo" style="margin-top:0; color:#22304a; font-size:22px; text-align:center;">Informações Extras</h3>
    <div style="margin-bottom:12px; color:#888; font-size:15px; text-align:center;" id="modalSubtituloInfo"></div>
    <label for="inputPrioridadeModal" style="font-size:15px; color:#34495e;">Prioridade:</label>
    <select id="inputPrioridadeModal" style="width:100%; border-radius:8px; border:1px solid #ccc; padding:7px; font-size:15px; margin-bottom:10px;">
      <option value="Normal">Normal</option>
      <option value="Alta">Alta</option>
      <option value="Crítica">Crítica</option>
    </select>
    <label for="inputInfoModal" style="font-size:15px; color:#34495e;">Nova Informação:</label>
    <textarea id="inputInfoModal" rows="4" placeholder="Digite aqui informações sobre faltas, manutenção, etc..." style="width:100%; border-radius:8px; border:1px solid #ccc; padding:10px; font-size:15px; resize:vertical; margin-bottom:10px;"></textarea>
    <button onclick="salvarInfoModal()" style="width:100%; background:#27ae60; color:#fff; border:none; border-radius:8px; padding:10px 0; font-size:16px; font-weight:bold; cursor:pointer; transition:background 0.2s;">Salvar Informação</button>
    <div id="feedbackInfoModal" style="margin-top:10px; color:#27ae60; text-align:center; font-size:14px; display:none;">Informação salva!</div>
    <hr style="margin:18px 0 10px 0; border:none; border-top:1px solid #eee;">
    <div style="font-size:15px; color:#34495e; margin-bottom:8px; font-weight:bold;">Informações Salvas:</div>
    <div id="visualizacaoInfoModal" style="background:#f8f8fa; border-radius:8px; min-height:40px; padding:10px; font-size:15px; color:#22304a; margin-bottom:8px;"></div>
    <div style="display:flex; align-items:center; gap:10px; margin-bottom:8px;">
      <label style="font-size:14px; color:#34495e;">
        <input type="checkbox" id="inputResolvidoModal" style="margin-right:5px;"> Marcar como resolvido
      </label>
      <span id="statusResolvidoModal" style="font-size:13px; color:#27ae60; display:none;">Resolvido!</span>
    </div>
    <div style="font-size:13px; color:#888; margin-top:8px;">
      <b>Histórico:</b>
      <ul id="historicoInfoModal" style="padding-left:18px; margin:4px 0 0 0; max-height:60px; overflow-y:auto;"></ul>
    </div>
  </div>
</div>
<script>
   // Salva as informações em memória (pode adaptar para backend/localStorage)
// Salva as informações em memória (pode adaptar para backend/localStorage)
const historicoInfos = {};
const infosExtras = {}; // { "Veículo 14-Segunda": { ... }, ... }
let celulaAtual = null;

function abrirModalInfo(icone) {
    const veiculo = icone.getAttribute('data-veiculo');
    const dia = icone.getAttribute('data-dia');
    celulaAtual = veiculo + '-' + dia;

    // Carrega informações específicas da célula
    const info = infosExtras[celulaAtual] || { texto: '', prioridade: 'Normal', resolvido: false };
    document.getElementById('inputInfoModal').value = '';
    document.getElementById('inputPrioridadeModal').value = info.prioridade || 'Normal';
    document.getElementById('visualizacaoInfoModal').innerText = info.texto || 'Nenhuma informação cadastrada.';
    document.getElementById('inputResolvidoModal').checked = !!info.resolvido;
    document.getElementById('statusResolvidoModal').style.display = info.resolvido ? 'inline' : 'none';
    document.getElementById('feedbackInfoModal').style.display = 'none';

    
    // Preenche histórico
    const hist = historicoInfos[celulaAtual] || [];
    const histEl = document.getElementById('historicoInfoModal');
    histEl.innerHTML = hist.length ? hist.map(h => `<li>${h}</li>`).join('') : '<li>Nenhum histórico.</li>';

    // Checkbox de resolvido
    document.getElementById('inputResolvidoModal').onchange = function() {
        if (!infosExtras[celulaAtual]) infosExtras[celulaAtual] = {};
        infosExtras[celulaAtual].resolvido = this.checked;
        document.getElementById('statusResolvidoModal').style.display = this.checked ? 'inline' : 'none';
        adicionarHistorico(`Marcado como ${this.checked ? 'resolvido' : 'não resolvido'}`);
    };

    document.getElementById('modalInfoTabela').style.display = 'flex';
}

function fecharModalInfo() {
    document.getElementById('modalInfoTabela').style.display = 'none';
}

async function salvarInfoModal() {
    const valor = document.getElementById('inputInfoModal').value.trim();
    const prioridade = document.getElementById('inputPrioridadeModal').value;
    const resolvido = document.getElementById('inputResolvidoModal').checked;
    if (celulaAtual && valor) {
        // Salva localmente usando a chave única
        infosExtras[celulaAtual] = { texto: valor, prioridade, resolvido };
        // Salva no backend
        await fetch('/api/informacoes-celula', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                celula: celulaAtual,
                texto: valor,
                prioridade,
                resolvido
            })
        });
        // Destaca a célula se for crítica
        destacarCelulaCritica(celulaAtual, prioridade);
        // Atualiza visualização
        document.getElementById('visualizacaoInfoModal').innerText = valor;
        document.getElementById('feedbackInfoModal').style.display = 'block';
        setTimeout(() => {
            document.getElementById('feedbackInfoModal').style.display = 'none';
        }, 1200);
        document.getElementById('inputInfoModal').value = '';
    }
}
function adicionarHistorico(texto) {
    if (!historicoInfos[celulaAtual]) historicoInfos[celulaAtual] = [];
    const data = new Date().toLocaleString('pt-BR');
    historicoInfos[celulaAtual].push(`${data}: ${texto}`);
    const histEl = document.getElementById('historicoInfoModal');
    histEl.innerHTML = historicoInfos[celulaAtual].map(h => `<li>${h}</li>`).join('');
}
function destacarCelulaCritica(celulaId, prioridade) {
    // Procura o ícone correspondente na tabela
    const icone = document.querySelector(`.info-icone[data-veiculo="${celulaId.split('-')[0]}"][data-dia="${celulaId.split('-')[1]}"]`);
    if (icone) {
        if (prioridade === 'Crítica') {
            icone.style.color = '#e74c3c'; // vermelho forte
            icone.style.animation = 'pulse 1s infinite alternate';
        } else if (prioridade === 'Alta') {
            icone.style.color = '#f39c12'; // laranja
            icone.style.animation = '';
        } else {
            icone.style.color = '#2980b9'; // azul padrão
            icone.style.animation = '';
        }
    }
}

// CSS para animação de destaque (adicione no <style>)
/*
@keyframes pulse {
    0% { transform: scale(1);}
    100% { transform: scale(1.2);}
}
*/
    // Salva a programação semanal no backend
// --- MELHORIA: Rastreamento automático por datas na Programação Semanal ---

// Salva a programação semanal no backend, associando cada célula à data da coluna
async function salvarProgramacaoSemanalBackend() {
    const datas = [
        document.getElementById('progSegundaData').value,
        document.getElementById('progTercaData').value,
        document.getElementById('progQuartaData').value,
        document.getElementById('progQuintaData').value,
        document.getElementById('progSextaData').value,
        document.getElementById('progSabadoData').value
    ];
    const veiculos = [
        "Veículo 16", "Veículo 14", "Veículo 12", "Veículo 10", "Veículo 8", "Veículo 18"
    ];
    const programacao = [];
    const linhas = document.querySelectorAll('#tabelaProgramacaoVeiculos tbody tr');
    veiculos.forEach((veiculo, vIdx) => {
        const linha = linhas[vIdx];
        for (let dIdx = 0; dIdx < datas.length; dIdx++) {
            const dataRef = datas[dIdx];
            if (!dataRef) continue;
            const celula = linha.cells[dIdx + 1];
            if (celula) {
                const edits = celula.querySelectorAll('.cell-edit');
                const cliente = edits[0]?.innerText || '';
                const lider = edits[1]?.innerText || '';
                const ajudantes = edits[2]?.innerText || '';
                if (cliente || lider || ajudantes) {
                    programacao.push({
                        veiculo,
                        data: dataRef,
                        cliente,
                        lider,
                        ajudantes
                    });
                }
            }
        }
    });

    if (programacao.length === 0) {
        alert('Preencha pelo menos um campo da programação para salvar.');
        return;
    }

    try {
        const res = await fetch('/api/programacao-semanal', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ programacao })
        });
        if (!res.ok) throw new Error();
        alert('Programação semanal salva no backend!');
    } catch (e) {
        alert('Erro ao salvar programação semanal!');
    }
}

// Ao mudar QUALQUER data da semana, limpa a tabela e carrega automaticamente a programação daquela semana (se houver)
function atualizarDatasProgramacao(id) {
    // IDs dos campos de data na ordem da semana
    const ids = [
        'progSegundaData',
        'progTercaData',
        'progQuartaData',
        'progQuintaData',
        'progSextaData',
        'progSabadoData'
    ];
    const idx = ids.indexOf(id);
    if (idx === -1) return;

    const dataBase = document.getElementById(id).value;
    if (!dataBase) return;

    // Preenche as datas seguintes automaticamente
    let data = new Date(dataBase);
    for (let i = idx + 1; i < ids.length; i++) {
        data.setDate(data.getDate() + 1);
        document.getElementById(ids[i]).value = data.toISOString().split('T')[0];
    }

    // Limpa a tabela
    limparTabelaProgramacao();

    // Carrega programação da semana (se houver) para a data da segunda-feira
    carregarProgramacaoPorSemana();
}


// Preenche a tabela de programação semanal com os dados recebidos

    function limparTabelaProgramacao() {
    const linhas = document.querySelectorAll('#tabelaProgramacaoVeiculos tbody tr');
    linhas.forEach(linha => {
        for (let i = 1; i <= 6; i++) {
            const celula = linha.cells[i];
            if (celula) {
                const edit1 = celula.querySelector('.cell-edit:nth-of-type(1)');
                const edit2 = celula.querySelector('.cell-edit:nth-of-type(2)');
                const editAj = celula.querySelector('.cell-edit.ajudantes');
                if (edit1) edit1.innerText = '';
                if (edit2) edit2.innerText = '';
                if (editAj) editAj.innerText = '';
            }
        }
    });
}

// Ao abrir a tela, se já houver uma data selecionada, carrega a programação correspondente
document.addEventListener('DOMContentLoaded', carregarProgramacaoPorSemana);

// Adiciona o evento para todos os campos de data da semana
['progSegundaData','progTercaData','progQuartaData','progQuintaData','progSextaData','progSabadoData'].forEach(id => {
    document.getElementById(id).addEventListener('change', function() {
        atualizarDatasProgramacao(id);
    });
});

// Variável global para armazenar o histórico carregado
let historicoProgramacaoCache = [];

async function abrirHistoricoProgramacao() {
    document.getElementById('historicoProgramacaoModal').style.display = 'flex';
    await carregarHistoricoProgramacao();
}

function fecharHistoricoProgramacao() {
    document.getElementById('historicoProgramacaoModal').style.display = 'none';
}
// ...código existente...
// ...código existente...

// Modal do histórico: mantém a tabela principal visível, só o modal aparece por cima
// O histórico agora serve para consulta, filtro e exclusão

async function carregarHistoricoProgramacao() {
    const lista = document.getElementById('listaHistoricoProgramacao');
    lista.innerHTML = '<p style="color:#888;">Carregando...</p>';
    try {
        const res = await fetch('/api/programacao-semanal/historico');
        const historico = await res.json();
        historicoProgramacaoCache = Array.isArray(historico) ? historico : [];
        exibirHistoricoFiltrado();
    } catch {
        lista.innerHTML = '<p style="color:#c00;">Erro ao carregar histórico.</p>';
    }
}

function aplicarFiltroHistorico() {
    exibirHistoricoFiltrado();
}
function resetarFiltroHistorico() {
    document.getElementById('filtroHistoricoData').value = '';
    document.getElementById('filtroHistoricoVeiculo').value = '';
    document.getElementById('filtroHistoricoCliente').value = '';
    exibirHistoricoFiltrado();
}

// Exibe o histórico filtrado e permite excluir ou carregar na tabela principal
function exibirHistoricoFiltrado() {
    const lista = document.getElementById('listaHistoricoProgramacao');
    const data = document.getElementById('filtroHistoricoData').value;
    const veiculo = document.getElementById('filtroHistoricoVeiculo').value;
    const busca = document.getElementById('filtroHistoricoCliente').value.trim().toLowerCase();

    let filtrado = historicoProgramacaoCache;
    if (data) filtrado = filtrado.filter(item => item.data === data);
    if (veiculo) filtrado = filtrado.filter(item => item.veiculo === veiculo);
    if (busca) {
        filtrado = filtrado.filter(item =>
            (item.cliente && item.cliente.toLowerCase().includes(busca)) ||
            (item.lider && item.lider.toLowerCase().includes(busca)) ||
            (item.ajudantes && item.ajudantes.toLowerCase().includes(busca))
        );
    }

    if (filtrado.length === 0) {
        lista.innerHTML = '<p style="color:#888; text-align:center;">Nenhum registro encontrado.</p>';
        return;
    }

    lista.innerHTML = '';
    filtrado.forEach(item => {
        const div = document.createElement('div');
        div.style = `
            border:2px solid #e3eafc;
            border-radius:14px;
            margin-bottom:14px;
            padding:18px 18px 14px 18px;
            background:linear-gradient(120deg,#f8f9fa 80%,#e3eafc 100%);
            position:relative;
            box-shadow:0 2px 12px #22304a11;
            transition:box-shadow 0.2s,border 0.2s;
            display:flex;
            flex-direction:column;
            gap:6px;
        `;
        div.innerHTML = `
            <div style="display:flex; flex-wrap:wrap; gap:18px; align-items:center; margin-bottom:4px;">
                <span style="font-size:15px; color:#34495e;"><strong>Data:</strong> ${item.data || '-'}</span>
                <span style="font-size:15px; color:#34495e;"><strong>Veículo:</strong> ${item.veiculo || '-'}</span>
            </div>
            <div style="margin-bottom:2px;">
                <span style="font-size:15px; color:#961c1c;"><strong>Cliente:</strong> ${item.cliente || '-'}</span>
            </div>
            <div style="margin-bottom:2px;">
                <span style="font-size:15px; color:#34495e;"><strong>Líder:</strong> ${item.lider || '-'}</span>
            </div>
            <div>
                <span style="font-size:15px; color:#34495e;"><strong>Ajudantes:</strong> ${item.ajudantes || '-'}</span>
            </div>
            <button onclick="excluirProgramacaoHistorico('${item.id}', this); event.stopPropagation();" style="position:absolute;top:14px;right:14px;background:#f44336;color:#fff;border:none;border-radius:50%;width:28px;height:28px;cursor:pointer;">&#128465;</button>
        `;
        lista.appendChild(div);
    });
}

// Botão para voltar do modal do histórico
function fecharHistoricoProgramacao() {
    document.getElementById('historicoProgramacaoModal').style.display = 'none';
}
function carregarProgramacaoPorSemana() {
    // Exemplo básico: busca a programação da semana da data selecionada
    const segunda = document.getElementById('progSegundaData').value;
    if (!segunda) return;
    fetch(`/api/programacao-semanal?data=${encodeURIComponent(segunda)}`)
        .then(res => res.json())
        .then(dados => {
            // Aqui você deve preencher a tabela com os dados recebidos
            // Exemplo: preencherTabelaProgramacao(dados.programacao);
        })
        .catch(() => {
            // Se não houver programação, a tabela já estará limpa
        });
}
// ...código existente...

// Função para excluir um registro do histórico da programação semanal
async function excluirProgramacaoHistorico(id, btn) {
    if (!confirm("Deseja realmente excluir este registro do histórico?")) return;
    btn.disabled = true;
    try {
        const res = await fetch(`/api/programacao-semanal/historico/${id}`, { method: 'DELETE' });
        if (!res.ok) throw new Error();
        // Remove visualmente o card do histórico
        btn.parentElement.remove();
        // Remove do cache local para atualizar os filtros sem recarregar tudo
        historicoProgramacaoCache = historicoProgramacaoCache.filter(item => item.id !== id);
    } catch {
        alert('Erro ao excluir registro!');
        btn.disabled = false;
    }
}

// ...código existente...

</script>
<div id="apontamentoProducaoScreen" class="screen">
    <h2 style="text-align:center; color:#961c1c; font-size:28px; margin-bottom:20px;">Apontamento de Produção</h2>
    <div style="background:#fff; padding:24px; border-radius:16px; box-shadow:0 4px 16px rgba(150,28,28,0.10); margin-bottom:32px;">
        <h3 style="color:#34495e; font-size:22px; margin-bottom:18px; font-weight:bold; text-align:center;">Produção Semanal</h3>
        <div style="overflow-x:auto;">
            <table id="tabelaApontamentoProducao" style="width:100%; border-collapse:collapse; text-align:center; font-size:16px; background:#fafbfc; border-radius:12px; box-shadow:0 2px 8px rgba(150,28,28,0.06);">
                <thead>
                    <tr style="background:linear-gradient(90deg,#961c1c 80%,#c0392b 100%); color:white;">
                        <th style="padding:14px 8px;">Etapa</th>
                        <th style="padding:14px 8px;">Segunda</th>
                        <th style="padding:14px 8px;">Terça</th>
                        <th style="padding:14px 8px;">Quarta</th>
                        <th style="padding:14px 8px;">Quinta</th>
                        <th style="padding:14px 8px;">Sexta</th>
                        <th style="padding:14px 8px;">Sábado</th>
                      
                        <tr style="background-color: #f4f4f4; color: #333;">
                            <th style="padding: 15px; font-weight: bold;">Data</th>
                            <td><input type="date" id="segundaData" onchange="atualizarDatasSemana('segundaData')" style="width:90%;padding:6px;border-radius:8px;border:1px solid #ccc;"></td>
                            <td><input type="date" id="tercaData" onchange="atualizarDatasSemana('tercaData')" style="width:90%;padding:6px;border-radius:8px;border:1px solid #ccc;"></td>
                            <td><input type="date" id="quartaData" onchange="atualizarDatasSemana('quartaData')" style="width:90%;padding:6px;border-radius:8px;border:1px solid #ccc;"></td>
                            <td><input type="date" id="quintaData" onchange="atualizarDatasSemana('quintaData')" style="width:90%;padding:6px;border-radius:8px;border:1px solid #ccc;"></td>
                            <td><input type="date" id="sextaData" onchange="atualizarDatasSemana('sextaData')" style="width:90%;padding:6px;border-radius:8px;border:1px solid #ccc;"></td>
                            <td><input type="date" id="sabadoData" onchange="atualizarDatasSemana('sabadoData')" style="width:90%;padding:6px;border-radius:8px;border:1px solid #ccc;"></td>
                        </tr>
        </thead>
                    <!-- 5 linhas para cada etapa -->
                    <tr>
                        <td style="background:#f4f4f4; font-weight:bold;">Separação</td>
                        <td>
                            <div contenteditable="true" style="border-bottom:1px solid #ccc; padding:4px;"></div>
                            <div contenteditable="true" style="border-bottom:1px solid #ccc; padding:4px;"></div>
                            <div contenteditable="true" style="padding:4px;"></div>
                        </td>
                        <td>
                            <div contenteditable="true" style="border-bottom:1px solid #ccc; padding:4px;"></div>
                            <div contenteditable="true" style="border-bottom:1px solid #ccc; padding:4px;"></div>
                            <div contenteditable="true" style="padding:4px;"></div>
                        </td>
                        <td>
                            <div contenteditable="true" style="border-bottom:1px solid #ccc; padding:4px;"></div>
                            <div contenteditable="true" style="border-bottom:1px solid #ccc; padding:4px;"></div>
                            <div contenteditable="true" style="padding:4px;"></div>
                        </td>
                        <td>
                            <div contenteditable="true" style="border-bottom:1px solid #ccc; padding:4px;"></div>
                            <div contenteditable="true" style="border-bottom:1px solid #ccc; padding:4px;"></div>
                            <div contenteditable="true" style="padding:4px;"></div>
                        </td>
                        <td>
                            <div contenteditable="true" style="border-bottom:1px solid #ccc; padding:4px;"></div>
                            <div contenteditable="true" style="border-bottom:1px solid #ccc; padding:4px;"></div>
                            <div contenteditable="true" style="padding:4px;"></div>
                        </td>
                        <td>
                            <div contenteditable="true" style="border-bottom:1px solid #ccc; padding:4px;"></div>
                            <div contenteditable="true" style="border-bottom:1px solid #ccc; padding:4px;"></div>
                            <div contenteditable="true" style="padding:4px;"></div>
                        </td>
                    </tr>
                    <tr>
                        <td style="background:#f4f4f4; font-weight:bold;">Corte</td>
                        <td><div contenteditable="true" style="border-bottom:1px solid #ccc; padding:4px;"></div><div contenteditable="true" style="border-bottom:1px solid #030303; padding:4px;"></div><div contenteditable="true" style="padding:4px;"></div></td>
                        <td><div contenteditable="true" style="border-bottom:1px solid #000000; padding:4px;"></div><div contenteditable="true" style="border-bottom:1px solid #ccc; padding:4px;"></div><div contenteditable="true" style="padding:4px;"></div></td>
                        <td><div contenteditable="true" style="border-bottom:1px solid #ccc; padding:4px;"></div><div contenteditable="true" style="border-bottom:1px solid #ccc; padding:4px;"></div><div contenteditable="true" style="padding:4px;"></div></td>
                        <td><div contenteditable="true" style="border-bottom:1px solid #ccc; padding:4px;"></div><div contenteditable="true" style="border-bottom:1px solid #ccc; padding:4px;"></div><div contenteditable="true" style="padding:4px;"></div></td>
                        <td><div contenteditable="true" style="border-bottom:1px solid #ccc; padding:4px;"></div><div contenteditable="true" style="border-bottom:1px solid #ccc; padding:4px;"></div><div contenteditable="true" style="padding:4px;"></div></td>
                        <td><div contenteditable="true" style="border-bottom:1px solid #ccc; padding:4px;"></div><div contenteditable="true" style="border-bottom:1px solid #ccc; padding:4px;"></div><div contenteditable="true" style="padding:4px;"></div></td>
                    </tr>
                    <tr>
                        <td style="background:#f4f4f4; font-weight:bold;">Usinagem</td>
                        <td><div contenteditable="true" style="border-bottom:1px solid #ccc; padding:4px;"></div><div contenteditable="true" style="border-bottom:1px solid #ccc; padding:4px;"></div><div contenteditable="true" style="padding:4px;"></div></td>
                        <td><div contenteditable="true" style="border-bottom:1px solid #ccc; padding:4px;"></div><div contenteditable="true" style="border-bottom:1px solid #ccc; padding:4px;"></div><div contenteditable="true" style="padding:4px;"></div></td>
                        <td><div contenteditable="true" style="border-bottom:1px solid #ccc; padding:4px;"></div><div contenteditable="true" style="border-bottom:1px solid #ccc; padding:4px;"></div><div contenteditable="true" style="padding:4px;"></div></td>
                        <td><div contenteditable="true" style="border-bottom:1px solid #ccc; padding:4px;"></div><div contenteditable="true" style="border-bottom:1px solid #ccc; padding:4px;"></div><div contenteditable="true" style="padding:4px;"></div></td>
                        <td><div contenteditable="true" style="border-bottom:1px solid #ccc; padding:4px;"></div><div contenteditable="true" style="border-bottom:1px solid #ccc; padding:4px;"></div><div contenteditable="true" style="padding:4px;"></div></td>
                        <td><div contenteditable="true" style="border-bottom:1px solid #ccc; padding:4px;"></div><div contenteditable="true" style="border-bottom:1px solid #ccc; padding:4px;"></div><div contenteditable="true" style="padding:4px;"></div></td>
                    </tr>
                    </tr>
                    <tr>
                        <td style="background:#f4f4f4; font-weight:bold;">Montagem</td>
                        <td><div contenteditable="true" style="border-bottom:1px solid #ccc; padding:4px;"></div><div contenteditable="true" style="border-bottom:1px solid #ccc; padding:4px;"></div><div contenteditable="true" style="padding:4px;"></div></td>
                        <td><div contenteditable="true" style="border-bottom:1px solid #ccc; padding:4px;"></div><div contenteditable="true" style="border-bottom:1px solid #ccc; padding:4px;"></div><div contenteditable="true" style="padding:4px;"></div></td>
                        <td><div contenteditable="true" style="border-bottom:1px solid #ccc; padding:4px;"></div><div contenteditable="true" style="border-bottom:1px solid #ccc; padding:4px;"></div><div contenteditable="true" style="padding:4px;"></div></td>
                        <td><div contenteditable="true" style="border-bottom:1px solid #ccc; padding:4px;"></div><div contenteditable="true" style="border-bottom:1px solid #ccc; padding:4px;"></div><div contenteditable="true" style="padding:4px;"></div></td>
                        <td><div contenteditable="true" style="border-bottom:1px solid #ccc; padding:4px;"></div><div contenteditable="true" style="border-bottom:1px solid #ccc; padding:4px;"></div><div contenteditable="true" style="padding:4px;"></div></td>
                        <td><div contenteditable="true" style="border-bottom:1px solid #ccc; padding:4px;"></div><div contenteditable="true" style="border-bottom:1px solid #ccc; padding:4px;"></div><div contenteditable="true" style="padding:4px;"></div></td>
                    </tr>
                    </tr>
                    <tr>
                        <td style="background:#f4f4f4; font-weight:bold;">Caixilho</td>
                        <td><div contenteditable="true" style="border-bottom:1px solid #ccc; padding:4px;"></div><div contenteditable="true" style="border-bottom:1px solid #ccc; padding:4px;"></div><div contenteditable="true" style="padding:4px;"></div></td>
                        <td><div contenteditable="true" style="border-bottom:1px solid #ccc; padding:4px;"></div><div contenteditable="true" style="border-bottom:1px solid #ccc; padding:4px;"></div><div contenteditable="true" style="padding:4px;"></div></td>
                        <td><div contenteditable="true" style="border-bottom:1px solid #ccc; padding:4px;"></div><div contenteditable="true" style="border-bottom:1px solid #ccc; padding:4px;"></div><div contenteditable="true" style="padding:4px;"></div></td>
                        <td><div contenteditable="true" style="border-bottom:1px solid #ccc; padding:4px;"></div><div contenteditable="true" style="border-bottom:1px solid #ccc; padding:4px;"></div><div contenteditable="true" style="padding:4px;"></div></td>
                        <td><div contenteditable="true" style="border-bottom:1px solid #ccc; padding:4px;"></div><div contenteditable="true" style="border-bottom:1px solid #ccc; padding:4px;"></div><div contenteditable="true" style="padding:4px;"></div></td>
                        <td><div contenteditable="true" style="border-bottom:1px solid #ccc; padding:4px;"></div><div contenteditable="true" style="border-bottom:1px solid #ccc; padding:4px;"></div><div contenteditable="true" style="padding:4px;"></div></td>
                    </tr>
                    </tr>
                </tbody>
            </table>
        </div>
        <div style="margin-top:18px; text-align:right;">
            <button onclick="salvarApontamentoProducao()" style="padding:10px 24px; background:#27ae60; color:white; border:none; border-radius:8px; font-size:16px; font-weight:bold;">Salvar</button>
            <button onclick="carregarApontamentoProducao()" style="padding:10px 24px; background:#3498db; color:white; border:none; border-radius:8px; font-size:16px; font-weight:bold;">Carregar</button>
        </div>
    </div>

    <!-- Pendências de Produção -->
    <div style="background:#fff; padding:24px; border-radius:16px; box-shadow:0 4px 16px rgba(150,28,28,0.10); margin-bottom:32px;">
        <h3 style="color:#042275; font-size:22px; margin-bottom:18px; font-weight:bold; text-align:center;">Pendências de Produção</h3>
        <div style="overflow-x:auto;">
            <table id="tabelaPendenciasProducao" style="width:100%; border-collapse:collapse; text-align:center; font-size:16px; background:#fafbfc; border-radius:12px; box-shadow:0 2px 8px rgba(150,28,28,0.06);">
                <thead>
                    <tr style="background:linear-gradient(90deg,#e67e22 80%,#f1c40f 100%); color:white;">
                        <th style="padding:14px 8px;">pendencias</th>
                        <th style="padding:14px 8px;">observaçoes</th>
                        <th style="padding:14px 8px;">segunda</th>
                        <th style="padding:14px 8px;">terça</th>
                        <th style="padding:14px 8px;">quarta</th>
                        <th style="padding:14px 8px;">quinta</th>
                        <th style="padding:14px 8px;">sexta</th>
                        <th style="padding:14px 8px;">sabado</th>
                        <tr style="background-color: #f4f4f4; color: #333;">
                            <th style="padding: 15px; font-weight: bold;">Data</th>
                            <td><input type="date" id="segundaData" onchange="atualizarDatasSemana('segundaData')" style="width:90%;padding:6px;border-radius:8px;border:1px solid #ccc;"></td>
                            <td><input type="date" id="tercaData" onchange="atualizarDatasSemana('tercaData')" style="width:90%;padding:6px;border-radius:8px;border:1px solid #ccc;"></td>
                            <td><input type="date" id="quartaData" onchange="atualizarDatasSemana('quartaData')" style="width:90%;padding:6px;border-radius:8px;border:1px solid #ccc;"></td>
                            <td><input type="date" id="quintaData" onchange="atualizarDatasSemana('quintaData')" style="width:90%;padding:6px;border-radius:8px;border:1px solid #ccc;"></td>
                            <td><input type="date" id="sextaData" onchange="atualizarDatasSemana('sextaData')" style="width:90%;padding:6px;border-radius:8px;border:1px solid #ccc;"></td>
                            <td><input type="date" id="sabadoData" onchange="atualizarDatasSemana('sabadoData')" style="width:90%;padding:6px;border-radius:8px;border:1px solid #ccc;"></td>
                        </tr>
                    </thead>
                    <!-- 3 linhas de exemplo -->
                    <tr>
                        <td style="background:#f4f4f4; font-weight:bold;">Obra</td>
                        <td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td>
                        <td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td>
                    </tr>
                    <tr>
                        <td style="background:#f4f4f4; font-weight:bold;">tipo</td>
                        <td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td>
                        <td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td>
                    </tr>
                    <tr>
                        <td style="background:#f4f4f4; font-weight:bold;">Obra</td>
                        <td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td>
                        <td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div style="margin-top:18px; display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:space-between;">
            <div style="display:flex; gap:10px; align-items:center;">
                <label for="filtroDataPendencia" style="font-size:16px;">Filtrar por Data:</label>
                <input type="date" id="filtroDataPendencia" style="padding:6px;border-radius:8px;border:1px solid #ccc;">
                <button onclick="filtrarPendenciasPorData()" style="padding:8px 18px; background:#961c1c; color:white; border:none; border-radius:8px; font-size:14px;">Filtrar</button>
                <button onclick="resetarFiltroPendencia()" style="padding:8px 18px; background:#3498db; color:white; border:none; border-radius:8px; font-size:14px;">Resetar</button>
            </div>
            <button onclick="salvarPendenciasProducao()" style="padding:10px 24px; background:#27ae60; color:white; border:none; border-radius:8px; font-size:16px; font-weight:bold;">Salvar Pendências</button>
            <button onclick="carregarPendenciasProducao()" style="padding:10px 24px; background:#f39c12; color:white; border:none; border-radius:8px; font-size:16px; font-weight:bold;">Ver Pendências Antigas</button>
        </div>
    </div>
    <button onclick="showScreen('paineisRotinaScreen')" style="margin-top:20px; padding:12px 20px; background-color:#961c1c; color:white; border:none; border-radius:8px; font-size:16px; cursor:pointer;">Voltar</button>
</div>

<script>
// Salvar e carregar Apontamento de Produção
function salvarApontamentoProducao() {
    const tabela = document.getElementById("tabelaApontamentoProducao").getElementsByTagName("tbody")[0];
    const linhas = tabela.getElementsByTagName("tr");
    const dados = [];
    for (let i = 0; i < linhas.length; i++) {
        const celulas = linhas[i].getElementsByTagName("td");
        const linha = [];
        for (let j = 0; j < celulas.length; j++) {
            linha.push(celulas[j].innerText);
        }
        dados.push(linha);
    }
    localStorage.setItem("apontamentoProducao", JSON.stringify(dados));
    alert("Apontamento de produção salvo!");
}
function carregarApontamentoProducao() {
    const dados = JSON.parse(localStorage.getItem("apontamentoProducao")) || [];
    const tabela = document.getElementById("tabelaApontamentoProducao").getElementsByTagName("tbody")[0];
    if (dados.length === 0) {
        alert("Nenhum dado salvo.");
        return;
    }
    for (let i = 0; i < tabela.rows.length; i++) {
        const celulas = tabela.rows[i].cells;
        for (let j = 0; j < celulas.length; j++) {
            celulas[j].innerText = dados[i][j] || "";
        }
    }
    alert("Apontamento carregado!");
}

// Pendências de Produção
function salvarPendenciasProducao() {
    const tabela = document.getElementById("tabelaPendenciasProducao").getElementsByTagName("tbody")[0];
    const linhas = tabela.getElementsByTagName("tr");
    const dados = [];
    for (let i = 0; i < linhas.length; i++) {
        const celulas = linhas[i].getElementsByTagName("td");
        const linha = [];
        for (let j = 0; j < celulas.length; j++) {
            if (celulas[j].querySelector("input")) {
                linha.push(celulas[j].querySelector("input").value);
            } else {
                linha.push(celulas[j].innerText);
            }
        }
        dados.push(linha);
    }
    localStorage.setItem("pendenciasProducao", JSON.stringify(dados));
    alert("Pendências salvas!");
}
function carregarPendenciasProducao() {
    const dados = JSON.parse(localStorage.getItem("pendenciasProducao")) || [];
    const tabela = document.getElementById("tabelaPendenciasProducao").getElementsByTagName("tbody")[0];
    if (dados.length === 0) {
        alert("Nenhuma pendência salva.");
        return;
    }
    for (let i = 0; i < tabela.rows.length; i++) {
        const celulas = tabela.rows[i].cells;
        for (let j = 0; j < celulas.length; j++) {
            if (celulas[j].querySelector("input")) {
                celulas[j].querySelector("input").value = dados[i][j] || "";
            } else {
                celulas[j].innerText = dados[i][j] || "";
            }
        }
    }
    alert("Pendências carregadas!");
}

// Filtrar pendências por data
function filtrarPendenciasPorData() {
    const filtro = document.getElementById("filtroDataPendencia").value;
    const tabela = document.getElementById("tabelaPendenciasProducao").getElementsByTagName("tbody")[0];
    for (let i = 0; i < tabela.rows.length; i++) {
        let encontrou = false;
        for (let j = 0; j < 8; j++) {
            const dataCell = tabela.rows[i].cells[j].querySelector("input");
            if (filtro && dataCell && dataCell.value === filtro) {
                encontrou = true;
            }
        }
        tabela.rows[i].style.display = (!filtro || encontrou) ? "" : "none";
    }
}
function resetarFiltroPendencia() {
    document.getElementById("filtroDataPendencia").value = "";
    filtrarPendenciasPorData();
}
</script>
<!-- ...restante do código... -->

<div id="statusProducaoScreen" class="screen">
    <h2 style="text-align: center; color: #961c1c; font-size: 28px; margin-bottom: 20px;">Status de Produção</h2>
    <div style="padding: 20px;">
        <!-- Primeira Parte da Tabela -->
        <table style="width: 100%; border-collapse: collapse; text-align: center; font-size: 16px; margin-bottom: 30px;">
            <table style="width: 100%; border-collapse: collapse; text-align: center; font-size: 16px; margin-bottom: 30px;">
                <thead>
                    <tr style="background-color: #961c1c; color: white;">
                        <th colspan="2" style="padding: 10px; border-right: 2px solid #fff;">Estágio</th>
                        <th style="padding: 10px;">Separação</th>
                        <th style="padding: 10px;">Corte</th>
                        <th style="padding: 10px;">Usinagem</th>
                        <th style="padding: 10px;">Montagem</th>
                        <th style="padding: 10px;">Caixilho</th>
                    </tr>
                  
                    
                </thead>
                <tbody>
                <tr>
                    <td rowspan="10" style="writing-mode: vertical-rl; transform: rotate(180deg); font-weight: bold; background-color: #961c1c; color: white; padding: 10px;">Ordem de Prioridade</td>
                    <td style="padding: 10px;">0</td>
                    <td contenteditable="true" style="padding: 10px; border: 1px solid #ddd;"></td>
                    <td contenteditable="true" style="padding: 10px; border: 1px solid #ddd;"></td>
                    <td contenteditable="true" style="padding: 10px; border: 1px solid #ddd;"></td>
                    <td contenteditable="true" style="padding: 10px; border: 1px solid #ddd;"></td>
                    <td contenteditable="true" style="padding: 10px; border: 1px solid #ddd;"></td>
                </tr>
                <tr>
                    <td style="padding: 10px;">1</td>
                    <td contenteditable="true" style="padding: 10px; border: 1px solid #ddd;"></td>
                    <td contenteditable="true" style="padding: 10px; border: 1px solid #ddd;"></td>
                    <td contenteditable="true" style="padding: 10px; border: 1px solid #ddd;"></td>
                    <td contenteditable="true" style="padding: 10px; border: 1px solid #ddd;"></td>
                    <td contenteditable="true" style="padding: 10px; border: 1px solid #ddd;"></td>
                </tr>
                <tr>
                    <td style="padding: 10px;">2</td>
                    <td contenteditable="true" style="padding: 10px; border: 1px solid #ddd;"></td>
                    <td contenteditable="true" style="padding: 10px; border: 1px solid #ddd;"></td>
                    <td contenteditable="true" style="padding: 10px; border: 1px solid #ddd;"></td>
                    <td contenteditable="true" style="padding: 10px; border: 1px solid #ddd;"></td>
                    <td contenteditable="true" style="padding: 10px; border: 1px solid #ddd;"></td>
                </tr>
                <tr>
                    <td style="padding: 10px;">3</td>
                    <td contenteditable="true" style="padding: 10px; border: 1px solid #ddd;"></td>
                    <td contenteditable="true" style="padding: 10px; border: 1px solid #ddd;"></td>
                    <td contenteditable="true" style="padding: 10px; border: 1px solid #ddd;"></td>
                    <td contenteditable="true" style="padding: 10px; border: 1px solid #ddd;"></td>
                    <td contenteditable="true" style="padding: 10px; border: 1px solid #ddd;"></td>
                </tr>
                <tr>
                    <td style="padding: 10px;">4</td>
                    <td contenteditable="true" style="padding: 10px; border: 1px solid #ddd;"></td>
                    <td contenteditable="true" style="padding: 10px; border: 1px solid #ddd;"></td>
                    <td contenteditable="true" style="padding: 10px; border: 1px solid #ddd;"></td>
                    <td contenteditable="true" style="padding: 10px; border: 1px solid #ddd;"></td>
                    <td contenteditable="true" style="padding: 10px; border: 1px solid #ddd;"></td>
                </tr>
                <tr>
                    <td style="padding: 10px;">5</td>
                    <td contenteditable="true" style="padding: 10px; border: 1px solid #ddd;"></td>
                    <td contenteditable="true" style="padding: 10px; border: 1px solid #ddd;"></td>
                    <td contenteditable="true" style="padding: 10px; border: 1px solid #ddd;"></td>
                    <td contenteditable="true" style="padding: 10px; border: 1px solid #ddd;"></td>
                    <td contenteditable="true" style="padding: 10px; border: 1px solid #ddd;"></td>
                </tr>
                <tr>
                    <td style="padding: 10px;">6</td>
                    <td contenteditable="true" style="padding: 10px; border: 1px solid #ddd;"></td>
                    <td contenteditable="true" style="padding: 10px; border: 1px solid #ddd;"></td>
                    <td contenteditable="true" style="padding: 10px; border: 1px solid #ddd;"></td>
                    <td contenteditable="true" style="padding: 10px; border: 1px solid #ddd;"></td>
                    <td contenteditable="true" style="padding: 10px; border: 1px solid #ddd;"></td>
                </tr>
                <tr>
                    <td style="padding: 10px;">7</td>
                    <td contenteditable="true" style="padding: 10px; border: 1px solid #ddd;"></td>
                    <td contenteditable="true" style="padding: 10px; border: 1px solid #ddd;"></td>
                    <td contenteditable="true" style="padding: 10px; border: 1px solid #ddd;"></td>
                    <td contenteditable="true" style="padding: 10px; border: 1px solid #ddd;"></td>
                    <td contenteditable="true" style="padding: 10px; border: 1px solid #ddd;"></td>
                </tr>
                <tr>
                    <td style="padding: 10px;">8</td>
                    <td contenteditable="true" style="padding: 10px; border: 1px solid #ddd;"></td>
                    <td contenteditable="true" style="padding: 10px; border: 1px solid #ddd;"></td>
                    <td contenteditable="true" style="padding: 10px; border: 1px solid #ddd;"></td>
                    <td contenteditable="true" style="padding: 10px; border: 1px solid #ddd;"></td>
                    <td contenteditable="true" style="padding: 10px; border: 1px solid #ddd;"></td>
                </tr>
                <tr>
                    <td style="padding: 10px;">9</td>
                    <td contenteditable="true" style="padding: 10px; border: 1px solid #ddd;"></td>
                    <td contenteditable="true" style="padding: 10px; border: 1px solid #ddd;"></td>
                    <td contenteditable="true" style="padding: 10px; border: 1px solid #ddd;"></td>
                    <td contenteditable="true" style="padding: 10px; border: 1px solid #ddd;"></td>
                    <td contenteditable="true" style="padding: 10px; border: 1px solid #ddd;"></td>
                </tr>
            </tbody>
        </table>
    </div>

        <div style="margin: 20px 0; text-align: center;">
            <button onclick="salvarDadosTabela()" style="padding: 10px 20px; background-color: #4CAF50; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer;">Salvar Dados</button>
            <button onclick="carregarDadosTabela()" style="padding: 10px 20px; background-color: #3498DB; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer;">Carregar Dados</button>
            <input type="date" id="dataInicial" style="padding: 10px; border: 1px solid #ccc; border-radius: 8px; font-size: 16px;">
            <button onclick="preencherDatasAutomaticamente()" style="padding: 10px 20px; background-color: #FF9800; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer;">Preencher Datas</button>
        </div>

<div style="margin-top: 40px; margin-bottom: 40px;">
    <h2 style="
        text-align: center;
        background: linear-gradient(90deg, #961c1c 80%, #c0392b 100%);
        color: white;
        padding: 18px 0 18px 0;
        border-radius: 16px 16px 0 0;
        font-size: 28px;
        letter-spacing: 1px;
        box-shadow: 0 4px 16px rgba(150,28,28,0.10);
        margin: 0;
    ">
        Ordens de Produção Finalizadas
    </h2>
    <div style="overflow-x:auto; border-radius:12px; box-shadow:0 2px 12px #22304a11; margin-bottom:24px;">
      <table id="tabelaOPFinalizadas" style="width:100%; border-collapse:collapse; font-size:15px;">
        <thead style="background:#22304a; color:#fff;">
          <tr>
            <th style="padding:12px; border:1px solid #ccc;">Nº OP</th>
            <th style="border:1px solid #ccc;">Cliente</th>
            <th style="border:1px solid #ccc;">Produto</th>
            <th style="border:1px solid #ccc;">Data Finalização</th>
            <th style="border:1px solid #ccc;">Status</th>
            <th style="border:1px solid #ccc;">Ações</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td style="border:1px solid #ccc;">001</td>
            <td style="border:1px solid #ccc;" contenteditable="true">Cliente Exemplo</td>
            <td style="border:1px solid #ccc;" contenteditable="true">Produto X</td>
            <td style="border:1px solid #ccc;" contenteditable="true">20/06/2025</td>
            <td style="border:1px solid #ccc;" contenteditable="true">Entregue</td>
            <td style="border:1px solid #ccc;">
              <button onclick="salvarLinha(this)">Salvar</button>
              <button onclick="removerLinha(this)">Remover</button>
            </td>
          </tr>
          <!-- Outras linhas -->
        </tbody>
      </table>
    </div>
    <button onclick="adicionarLinhaOP()" style="background:#27ae60; color:#fff; border:none; border-radius:8px; padding:8px 16px; margin-bottom:12px;">Adicionar Linha</button>
<input type="text" id="buscaOPFinalizadas" placeholder="Buscar por cliente ou produto..." style="margin-bottom:12px; padding:8px; border-radius:8px; border:1px solid #ccc; width:220px;">
    <button onclick="exportarOPFinalizadasExcel()" style="background:#27ae60; color:#fff; border:none; border-radius:8px; padding:8px 16px; margin-left:8px;">Exportar Excel</button>
</div>

               
</div> 
<div id="chegadaMateriaPrimaScreen" class="screen">
    <h2 style="text-align: center; color: #961c1c; font-size: 28px; margin-bottom: 20px;">Chegada de Matéria-Prima para Semana</h2>
    <div style="padding: 20px;">
        <!-- Tabela de Chegada de Matéria-Prima -->
        <table style="width: 100%; border-collapse: collapse; text-align: center; font-size: 16px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); background-color: white; border-radius: 12px; overflow: hidden;">
            <thead>
                <tr style="background-color: #961c1c; color: white;">
                    <th style="padding: 15px; font-weight: bold;">Item</th>
                    <th style="padding: 15px; font-weight: bold;">Clientes</th>
                    <th style="padding: 15px; font-weight: bold;">Segunda</th>
                    <th style="padding: 15px; font-weight: bold;">Terça</th>
                    <th style="padding: 15px; font-weight: bold;">Quarta</th>
                    <th style="padding: 15px; font-weight: bold;">Quinta</th>
                    <th style="padding: 15px; font-weight: bold;">Sexta</th>
                </tr>
            <tr style="background-color: #f4f4f4; color: #333;">
                <th style="padding: 15px; font-weight: bold;">Data</th>
                <td></td>
                <td>
                    <input type="date" id="segundaData" onchange="atualizarDatas('segundaData')" style="width: calc(100% - 20px); padding: 8px; border: 1px solid #ccc; border-radius: 8px; font-size: 14px;">
                </td>
                <td>
                    <input type="date" id="tercaData" onchange="atualizarDatas('tercaData')" style="width: calc(100% - 20px); padding: 8px; border: 1px solid #ccc; border-radius: 8px; font-size: 14px;">
                </td>
                <td>
                    <input type="date" id="quartaData" onchange="atualizarDatas('quartaData')" style="width: calc(100% - 20px); padding: 8px; border: 1px solid #ccc; border-radius: 8px; font-size: 14px;">
                </td>
                <td>
                    <input type="date" id="quintaData" onchange="atualizarDatas('quintaData')" style="width: calc(100% - 20px); padding: 8px; border: 1px solid #ccc; border-radius: 8px; font-size: 14px;">
                </td>
                <td>
                    <input type="date" id="sextaData" onchange="atualizarDatas('sextaData')" style="width: calc(100% - 20px); padding: 8px; border: 1px solid #ccc; border-radius: 8px; font-size: 14px;">
                </td>
            </tr>
        </thead>
        <div style="margin-bottom: 20px; padding: 10px; background-color: #f9f9f9; border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);">
            <h3 style="margin-bottom: 10px; color: #333;">Filtrar Tabela</h3>
            <div style="display: flex; gap: 10px; align-items: center;">
                <label for="filtroItem" style="font-size: 16px;">Item:</label>
                <select id="filtroItem" style="padding: 8px; border: 1px solid #ccc; border-radius: 8px; font-size: 14px;">
                    <option value="">Todos</option>
                    <option value="Vidros">Vidros</option>
                    <option value="Perfis">Perfis</option>
                    <option value="Acessórios">Acessórios</option>
                </select>
        
                <label for="filtroDia" style="font-size: 16px;">Dia:</label>
                <select id="filtroDia" style="padding: 8px; border: 1px solid #ccc; border-radius: 8px; font-size: 14px;">
                    <option value="">Todos</option>
                    <option value="Segunda">Segunda</option>
                    <option value="Terça">Terça</option>
                    <option value="Quarta">Quarta</option>
                    <option value="Quinta">Quinta</option>
                    <option value="Sexta">Sexta</option>
                </select>
        
                <button onclick="filtrarTabela()" style="padding: 10px 20px; background-color: #961c1c; color: white; border: none; border-radius: 8px; font-size: 14px; cursor: pointer;">Filtrar</button>
                <button onclick="resetarFiltro()" style="padding: 10px 20px; background-color: #3498db; color: white; border: none; border-radius: 8px; font-size: 14px; cursor: pointer;">Resetar</button>
            </div>
        </div>
        
            <tbody id="tabelaChegadaMateriaPrima">
                <tr>
                        <div contenteditable="true" style="padding: 5px;"></div>
                    </td>
                    <td style="padding: 15px; border: 1px solid #ddd;">
                        <div contenteditable="true" style="border-bottom: 1px solid #ccc; padding: 5px;"></div>
                        <div contenteditable="true" style="border-bottom: 1px solid #ccc; padding: 5px;"></div>
                        <div contenteditable="true" style="padding: 5px;"></div>
                    </td>
                    <td style="padding: 15px; border: 1px solid #ddd;">
                        <div contenteditable="true" style="border-bottom: 1px solid #ccc; padding: 5px;"></div>
                        <div contenteditable="true" style="border-bottom: 1px solid #ccc; padding: 5px;"></div>
                        <div contenteditable="true" style="padding: 5px;"></div>
                    </td>
                    <td style="padding: 15px; border: 1px solid #ddd;">
                        <div contenteditable="true" style="border-bottom: 1px solid #ccc; padding: 5px;"></div>
                        <div contenteditable="true" style="border-bottom: 1px solid #ccc; padding: 5px;"></div>
                        <div contenteditable="true" style="padding: 5px;"></div>
                    </td>
                </tr>
                    <td style="padding: 15px; border: 1px solid #ddd;">Perfis</td>
                    <td style="padding: 15px; border: 1px solid #ddd;">
                        <div contenteditable="true" style="border-bottom: 1px solid #ccc; padding: 5px;"></div>
                        <div contenteditable="true" style="border-bottom: 1px solid #ccc; padding: 5px;"></div>
                        <div contenteditable="true" style="padding: 5px;"></div>
                    </td>
                    <td style="padding: 15px; border: 1px solid #ddd;">
                        <div contenteditable="true" style="border-bottom: 1px solid #ccc; padding: 5px;"></div>
                        <div contenteditable="true" style="border-bottom: 1px solid #ccc; padding: 5px;"></div>
                        <div contenteditable="true" style="padding: 5px;"></div>
                    </td>
                    <td style="padding: 15px; border: 1px solid #ddd;">
                        <div contenteditable="true" style="border-bottom: 1px solid #ccc; padding: 5px;"></div>
                        <div contenteditable="true" style="border-bottom: 1px solid #ccc; padding: 5px;"></div>
                        <div contenteditable="true" style="padding: 5px;"></div>
                    </td>
                    <td style="padding: 15px; border: 1px solid #ddd;">
                        <div contenteditable="true" style="border-bottom: 1px solid #ccc; padding: 5px;"></div>
                        <div contenteditable="true" style="border-bottom: 1px solid #ccc; padding: 5px;"></div>
                        <div contenteditable="true" style="padding: 5px;"></div>
                    </td>
                    <td style="padding: 15px; border: 1px solid #ddd;">
                        <div contenteditable="true" style="border-bottom: 1px solid #ccc; padding: 5px;"></div>
                        <div contenteditable="true" style="border-bottom: 1px solid #ccc; padding: 5px;"></div>
                        <div contenteditable="true" style="padding: 5px;"></div>
                    </td>
                    <td style="padding: 15px; border: 1px solid #ddd;">
                        <div contenteditable="true" style="border-bottom: 1px solid #ccc; padding: 5px;"></div>
                        <div contenteditable="true" style="border-bottom: 1px solid #ccc; padding: 5px;"></div>
                        <div contenteditable="true" style="padding: 5px;"></div>
                    </td>
                </tr>
                    <td style="padding: 15px; border: 1px solid #ddd;">Acessórios</td>
                    <td style="padding: 15px; border: 1px solid #ddd;">
                        <div contenteditable="true" style="border-bottom: 1px solid #ccc; padding: 5px;"></div>
                        <div contenteditable="true" style="border-bottom: 1px solid #ccc; padding: 5px;"></div>
                        <div contenteditable="true" style="padding: 5px;"></div>
                    </td>
                    <td style="padding: 15px; border: 1px solid #ddd;">
                        <div contenteditable="true" style="border-bottom: 1px solid #ccc; padding: 5px;"></div>
                        <div contenteditable="true" style="border-bottom: 1px solid #ccc; padding: 5px;"></div>
                        <div contenteditable="true" style="padding: 5px;"></div>
                    </td>
                    <td style="padding: 15px; border: 1px solid #ddd;">
                        <div contenteditable="true" style="border-bottom: 1px solid #ccc; padding: 5px;"></div>
                        <div contenteditable="true" style="border-bottom: 1px solid #ccc; padding: 5px;"></div>
                        <div contenteditable="true" style="padding: 5px;"></div>
                    </td>
                    <td style="padding: 15px; border: 1px solid #ddd;">
                        <div contenteditable="true" style="border-bottom: 1px solid #ccc; padding: 5px;"></div>
                        <div contenteditable="true" style="border-bottom: 1px solid #ccc; padding: 5px;"></div>
                        <div contenteditable="true" style="padding: 5px;"></div>
                    </td>
                    <td style="padding: 15px; border: 1px solid #ddd;">
                        <div contenteditable="true" style="border-bottom: 1px solid #ccc; padding: 5px;"></div>
                        <div contenteditable="true" style="border-bottom: 1px solid #ccc; padding: 5px;"></div>
                        <div contenteditable="true" style="padding: 5px;"></div>
                    </td>
                    <td style="padding: 15px; border: 1px solid #ddd;">
                        <div contenteditable="true" style="border-bottom: 1px solid #ccc; padding: 5px;"></div>
                        <div contenteditable="true" style="border-bottom: 1px solid #ccc; padding: 5px;"></div>
                        <div contenteditable="true" style="padding: 5px;"></div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
    <button onclick="showScreen('paineisRotinaScreen')" style="margin-top: 20px; padding: 12px 20px; background-color: #961c1c; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer;">Voltar</button>
  
</div>
<style>
#tabelaOPFinalizadas th, #tabelaOPFinalizadas td {
    border: 1px solid #ccc;
}
</style>
<script>
    function atualizarDatas(id) {
        const dataInicial = document.getElementById(id).value;
        if (!dataInicial) {
            alert("Por favor, insira uma data válida.");
            return;
        }

        const data = new Date(dataInicial);
        const idsDias = ["segundaData", "tercaData", "quartaData", "quintaData", "sextaData"];
        const indexInicial = idsDias.indexOf(id);

        // Atualiza as datas subsequentes
        for (let i = indexInicial + 1; i < idsDias.length; i++) {
            const novaData = new Date(data);
            novaData.setDate(data.getDate() + (i - indexInicial));
            document.getElementById(idsDias[i]).value = novaData.toISOString().split("T")[0];
        }
    }


    function filtrarTabela() {
        const filtroItem = document.getElementById("filtroItem").value.toLowerCase();
        const filtroDia = document.getElementById("filtroDia").value.toLowerCase();
        const tabela = document.getElementById("tabelaChegadaMateriaPrima");
        const linhas = tabela.getElementsByTagName("tr");

        for (let i = 0; i < linhas.length; i++) {
            const colunas = linhas[i].getElementsByTagName("td");
            if (colunas.length > 0) {
                const item = colunas[0].innerText.toLowerCase();
                const dias = {
                    segunda: colunas[2]?.innerText.toLowerCase(),
                    terça: colunas[3]?.innerText.toLowerCase(),
                    quarta: colunas[4]?.innerText.toLowerCase(),
                    quinta: colunas[5]?.innerText.toLowerCase(),
                    sexta: colunas[6]?.innerText.toLowerCase(),
                };

                const itemMatch = !filtroItem || item.includes(filtroItem);
                const diaMatch = !filtroDia || dias[filtroDia];

                if (itemMatch && diaMatch) {
                    linhas[i].style.display = "";
                } else {
                    linhas[i].style.display = "none";
                }
            }
        }
    }

    function resetarFiltro() {
        document.getElementById("filtroItem").value = "";
        document.getElementById("filtroDia").value = "";
        filtrarTabela();
    }
    
    

    // Função para salvar os dados da tabela no localStorage
    function salvarDadosTabela() {
        const tabela = document.querySelector("#statusProducaoScreen table tbody");
        const linhas = tabela.querySelectorAll("tr");
        const dados = [];

        linhas.forEach((linha) => {
            const colunas = linha.querySelectorAll("td");
            const linhaDados = Array.from(colunas).map((coluna) => coluna.innerText.trim());
            dados.push(linhaDados);
        });

        localStorage.setItem("dadosTabelaProducao", JSON.stringify(dados));
        alert("Dados salvos com sucesso!");
    }

    // Função para carregar os dados salvos no localStorage
    function carregarDadosTabela() {
        const tabela = document.querySelector("#statusProducaoScreen table tbody");
        const dados = JSON.parse(localStorage.getItem("dadosTabelaProducao")) || [];

        tabela.innerHTML = ""; // Limpa a tabela antes de carregar os dados

        dados.forEach((linhaDados) => {
            const linha = document.createElement("tr");
            linhaDados.forEach((dado) => {
                const coluna = document.createElement("td");
                coluna.contentEditable = "true";
                coluna.style.padding = "10px";
                coluna.style.border = "1px solid #ddd";
                coluna.innerText = dado;
                linha.appendChild(coluna);
            });
            tabela.appendChild(linha);
        });

        alert("Dados carregados com sucesso!");
    }

    // Função para preencher as datas automaticamente
    function preencherDatasAutomaticamente() {
        const dataInicialInput = document.getElementById("dataInicial");
        const tabela = document.querySelector("#statusProducaoScreen table tbody");

        if (!dataInicialInput.value) {
            alert("Por favor, insira uma data inicial.");
            return;
        }

        const dataInicial = new Date(dataInicialInput.value);

        tabela.querySelectorAll("tr").forEach((linha, index) => {
            const colunaData = linha.querySelector("td:nth-child(2)"); // Supondo que a segunda coluna seja de datas
            if (colunaData) {
                const novaData = new Date(dataInicial);
                novaData.setDate(dataInicial.getDate() + index); // Incrementa os dias com base no índice da linha
                colunaData.innerText = novaData.toISOString().split("T")[0];
            }
        });

        alert("Datas preenchidas automaticamente!");
    }
async function carregarOPFinalizadas() {
    const tbody = document.querySelector('#tabelaOPFinalizadas tbody');
    const busca = document.getElementById('buscaOPFinalizadas').value.toLowerCase();
    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; color:#888;">Carregando...</td></tr>';
    try {
        const res = await fetch('/api/op/finalizadas');
        let ops = await res.json();
        if (busca) {
            ops = ops.filter(op =>
                (op.cliente || '').toLowerCase().includes(busca) ||
                (op.produto || '').toLowerCase().includes(busca)
            );
        }
        if (!ops.length) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; color:#888;">Nenhuma OP encontrada.</td></tr>';
            return;
        }
        tbody.innerHTML = ops.map(op => `
            <tr style="background:${op.status==='Entregue'?'#eafbe6':'#fff'};">
                <td style="padding:10px 6px;">${op.numero}</td>
                <td>${op.cliente}</td>
                <td>${op.produto}</td>
                <td>${op.dataFinalizacao ? new Date(op.dataFinalizacao).toLocaleDateString('pt-BR') : '-'}</td>
                <td>
                  <span style="color:${op.status==='Entregue'?'#27ae60':'#34495e'}; font-weight:bold;">
                    ${op.status}
                  </span>
                </td>
                <td>
                  <button onclick="verDetalhesOP('${op.id}')" style="background:#22304a; color:#fff; border:none; border-radius:6px; padding:4px 10px; cursor:pointer;">Detalhes</button>
                </td>
            </tr>
        `).join('');
    } catch {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; color:#c00;">Erro ao carregar dados.</td></tr>';
    }
}
document.getElementById('buscaOPFinalizadas').addEventListener('input', carregarOPFinalizadas);
carregarOPFinalizadas();
    function exportarOPFinalizadasExcel() {
    const table = document.getElementById('tabelaOPFinalizadas');
    let csv = '';
    for (let row of table.rows) {
        let rowData = [];
        for (let cell of row.cells) {
            rowData.push('"' + cell.innerText.replace(/"/g, '""') + '"');
        }
        csv += rowData.join(';') + '\n';
    }
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'op_finalizadas.csv';
    a.click();
    URL.revokeObjectURL(url);
}
function verDetalhesOP(opId) {
    // Implemente um modal para mostrar todos os detalhes da OP selecionada
    alert('Detalhes da OP: ' + opId);
}
function adicionarLinhaOP() {
    const tabela = document.getElementById('tabelaOPFinalizadas').getElementsByTagName('tbody')[0];
    const novaLinha = tabela.insertRow();
    novaLinha.innerHTML = `
        <td style="border:1px solid #ccc;" contenteditable="true"></td>
        <td style="border:1px solid #ccc;" contenteditable="true"></td>
        <td style="border:1px solid #ccc;" contenteditable="true"></td>
        <td style="border:1px solid #ccc;" contenteditable="true"></td>
        <td style="border:1px solid #ccc;" contenteditable="true"></td>
        <td style="border:1px solid #ccc;">
            <button onclick="salvarLinha(this)">Salvar</button>
            <button onclick="removerLinha(this)">Remover</button>
        </td>
    `;
}

function removerLinha(btn) {
    const row = btn.parentNode.parentNode;
    row.parentNode.removeChild(row);
}

function salvarLinha(btn) {
    // Aqui você pode implementar o salvamento (ex: enviar para API ou localStorage)
    alert('Linha salva!');
}
</script>
<!-- Adicione este bloco após o último <div class="screen"> do seu HTML -->
<div id="vendasScreen" class="screen">
    <h2 style="text-align:center; color:#961c1c; font-size:28px; margin-bottom:20px;">Dashboard de Vendas</h2>
    <div style="display:flex; flex-wrap:wrap; gap:24px; justify-content:center; margin-bottom:32px;">
        <div style="flex:1 1 180px; min-width:180px; background:#fff; border-radius:12px; box-shadow:0 2px 8px #961c1c22; padding:24px; text-align:center;">
            <h3 style="color:#34495e; font-size:18px;">Clientes Registrados</h3>
            <div id="totalClientes" style="font-size:32px; color:#961c1c; font-weight:bold;">0</div>
        </div>
        <div style="flex:1 1 180px; min-width:180px; background:#fff; border-radius:12px; box-shadow:0 2px 8px #22304a22; padding:24px; text-align:center;">
            <h3 style="color:#34495e; font-size:18px;">Em Prospecção</h3>
            <div id="totalProspec" style="font-size:32px; color:#22304a; font-weight:bold;">0</div>
        </div>
        <div style="flex:1 1 180px; min-width:180px; background:#fff; border-radius:12px; box-shadow:0 2px 8px #27ae6022; padding:24px; text-align:center;">
            <h3 style="color:#34495e; font-size:18px;">Vendedores</h3>
            <div id="totalVendedores" style="font-size:32px; color:#27ae60; font-weight:bold;">0</div>
        </div>
    </div>
    
  <!-- Botão flutuante para abrir o modal -->
<button id="btnMiniOrcamento" onclick="abrirPainelOrcamentoDireto()" title="Gestão de Orçamentos"
    style="position:fixed; bottom:32px; right:32px; z-index:9999; background:#1F3695; color:#fff; border:none; border-radius:50%; width:56px; height:56px; box-shadow:0 4px 16px #1F369544; font-size:28px; display:flex; align-items:center; justify-content:center; cursor:pointer; transition:background 0.2s;">
    <span style="font-size:32px; line-height:1;">&#128179;</span>
</button>

<!-- Modal do Painel de Orçamentos -->
<div id="modalPainelOrcamentoDireto" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.65); z-index:9999; align-items:center; justify-content:center;">
  <div style="background:#f8f9fa; border-radius:16px; box-shadow:0 2px 24px #1F369544; padding:32px 24px; max-width:600px; width:95vw; max-height:90vh; overflow:auto; position:relative; animation:fadeIn 0.5s;">
    <button onclick="fecharPainelOrcamentoDireto()" style="position:absolute;top:18px;right:18px;background:#f44336;color:#fff;border:none;border-radius:50%;width:36px;height:36px;font-size:22px;cursor:pointer;">&times;</button>
    <div style="margin-bottom:18px; text-align:center;">
        <label for="clienteOrcamentoDireto" style="font-weight:bold; color:#1F3695;">Cliente:</label>
        <input type="text" id="buscaClienteOrcamentoDireto" placeholder="Buscar cliente..." style="padding:8px; border-radius:8px; border:1px solid #ccc; font-size:15px; min-width:220px; margin-bottom:8px;">
        <select id="clienteOrcamentoDireto" style="padding:8px; border-radius:8px; border:1px solid #ccc; font-size:15px; min-width:220px;">
            <option value="">Selecione o cliente</option>
        </select>
    </div>
    <div id="dadosClienteOrcamentoDireto" style="margin: 12px auto 18px auto; max-width: 420px; background: #f7f9fb; border-radius: 10px; box-shadow: 0 2px 8px #1F369522; padding: 14px 18px; display: none;">
        <div id="infoClienteOrcamentoDireto" style="color:#34495e; font-size:15px;"></div>
    </div>
    <h2 style="color:#1F3695; text-align:center; margin-bottom:18px;">Gestão de Estágios do Orçamento</h2>
    <div id="painelOrcamentoEstagiosDireto" style="display:flex; flex-wrap:wrap; gap:18px; justify-content:center; margin-bottom:24px;"></div>
    <div style="text-align:center; margin-bottom:24px;">
        <button onclick="adicionarEstagioOrcamentoDireto()" style="padding:10px 22px; background:#1F3695; color:#fff; border:none; border-radius:8px; font-size:16px; font-weight:bold; transition:background 0.2s;">+ Novo Estágio</button>
    </div>
    <div id="fecharOrcamentoAreaDireto" style="display:none; background:#eafbe6; border-radius:12px; padding:18px; margin-bottom:24px; animation: fadeIn 0.7s;">
        <h4 style="color:#27ae60;">Fechar Orçamento</h4>
        <label>Tipologias (separe por vírgula):</label>
        <input type="text" id="tipologiasOrcamentoDireto" placeholder="Ex: Porta, Janela, Fachada" style="margin-bottom:8px;">
        <label>O que foi vendido:</label>
        <textarea id="vendidoOrcamentoDireto" rows="3" placeholder="Descreva o que foi vendido ao cliente" style="margin-bottom:8px;"></textarea>
        <button onclick="salvarFechamentoOrcamentoDireto()" style="padding:8px 18px; background:#27ae60; color:white; border:none; border-radius:8px; font-size:15px;">Salvar Fechamento</button>
    </div>
    <div id="orcamentoResumoFinalDireto" style="display:none; background:#dff0d8; border-radius:12px; padding:18px; margin-bottom:24px; animation: fadeIn 0.7s;"></div>
  </div>
</div>
<!-- Adicione este bloco ao final do seu HTML, antes do </body> -->
<div id="modalDetalhesFinanceiro" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.65); z-index:10000; align-items:center; justify-content:center;">
  <div id="boxDetalhesFinanceiro" style="background:#fff; border-radius:18px; padding:28px 18px 22px 18px; max-width:340px; width:92vw; max-height:80vh; overflow:auto; position:relative; box-shadow:0 8px 32px #27ae6022; animation:fadeInDetalhe 0.6s;">
    <button onclick="fecharModalDetalhesFinanceiro()" style="position:absolute;top:10px;right:10px;background:#f44336;color:#fff;border:none;border-radius:50%;width:28px;height:28px;font-size:18px;cursor:pointer;">&times;</button>
    <h4 id="tituloDetalhesFinanceiro" style="color:#27ae60; text-align:center; margin-bottom:10px; font-size:19px; letter-spacing:1px;">Detalhes</h4>
    <div id="conteudoDetalhesFinanceiro" style="font-size:13px;"></div>
  </div>
</div>
<style>
@keyframes fadeInDetalhe {
  from { opacity:0; transform:scale(0.92);}
  to { opacity:1; transform:scale(1);}
}
#modalDetalhesFinanceiro {
  display: none;
  align-items: center !important;
  justify-content: center !important;
}
#modalDetalhesFinanceiro[style*="display: flex"] {
  display: flex !important;
}
#boxDetalhesFinanceiro .estagio-animado {
  opacity: 0;
  transform: translateY(30px) scale(0.98);
  animation: estagioFadeIn 0.5s forwards;
}
#boxDetalhesFinanceiro .estagio-animado:nth-child(1) { animation-delay: 0.05s;}
#boxDetalhesFinanceiro .estagio-animado:nth-child(2) { animation-delay: 0.12s;}
#boxDetalhesFinanceiro .estagio-animado:nth-child(3) { animation-delay: 0.19s;}
#boxDetalhesFinanceiro .estagio-animado:nth-child(4) { animation-delay: 0.26s;}
#boxDetalhesFinanceiro .estagio-animado:nth-child(5) { animation-delay: 0.33s;}
#boxDetalhesFinanceiro .estagio-animado:nth-child(6) { animation-delay: 0.40s;}
@keyframes estagioFadeIn {
  to { opacity:1; transform:translateY(0) scale(1);}
}
#boxDetalhesFinanceiro .estagio-animado {
  background: linear-gradient(90deg,#eafbe6 80%,#fff 100%);
  border-left: 5px solid #27ae60;
  border-radius: 8px;
  margin-bottom: 10px;
  padding: 10px 12px;
  box-shadow: 0 2px 8px #27ae6011;
  position: relative;
  transition: box-shadow 0.2s;
}
#boxDetalhesFinanceiro .estagio-animado.perda {
  border-left: 5px solid #c00;
  background: linear-gradient(90deg,#ffeaea 80%,#fff 100%);
}
#boxDetalhesFinanceiro .estagio-animado.aberto {
  border-left: 5px solid #f39c12;
  background: linear-gradient(90deg,#fffbe6 80%,#fff 100%);
}
#boxDetalhesFinanceiro .valor-animado {
  font-size: 16px;
  font-weight: bold;
  color: #27ae60;
  float: right;
  margin-left: 8px;
  letter-spacing: 1px;
  animation: valorPulse 0.7s infinite alternate;
}
#boxDetalhesFinanceiro .valor-animado.perda { color: #c00; }
#boxDetalhesFinanceiro .valor-animado.aberto { color: #f39c12; }
@keyframes valorPulse {
  0% { filter: brightness(1);}
  100% { filter: brightness(1.25);}
}
</style>

<style>
#modalPainelOrcamentoDireto {
    display: none;
    align-items: center;
    justify-content: center;
}
#modalPainelOrcamentoDireto.active {
    display: flex !important;
}
</style>
<!-- Adicione logo após o botão do orçamento, dentro de #vendasScreen -->
<button id="btnMiniDashFinanceiro" onclick="abrirDashFinanceiro()" title="Dashboard Financeiro"
    style="position:fixed; bottom:100px; right:32px; z-index:9999; background:#27ae60; color:#fff; border:none; border-radius:50%; width:56px; height:56px; box-shadow:0 4px 16px #27ae6044; font-size:28px; display:flex; align-items:center; justify-content:center; cursor:pointer; transition:background 0.2s;">
    <span style="font-size:32px; line-height:1;">&#128200;</span>
</button>

<div id="modalDashFinanceiro" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.65); z-index:9999; align-items:center; justify-content:center;">
    <div style="background:#fff; border-radius:18px; padding:36px 28px; max-width:440px; width:95vw; max-height:90vh; overflow:auto; position:relative; box-shadow:0 8px 32px #27ae6022; animation:fadeIn 0.6s;">
        <button onclick="fecharDashFinanceiro()" style="position:absolute;top:18px;right:18px;background:#f44336;color:#fff;border:none;border-radius:50%;width:36px;height:36px;font-size:22px;cursor:pointer;">&times;</button>
        <h2 style="color:#27ae60; text-align:center; margin-bottom:18px;">Dashboard Financeiro</h2>
        <div>
            <div id="abasDashFinanceiro" style="display:flex;gap:8px;margin-bottom:18px;justify-content:center;">
                <button id="abaDashFinanceiroResumo" style="padding:8px 18px; background:#27ae60; color:#fff; border:none; border-radius:8px; font-size:15px; font-weight:bold; cursor:pointer;">Resumo Financeiro</button>
                <button id="abaDashFinanceiroEstagios" style="padding:8px 18px; background:#22304a; color:#fff; border:none; border-radius:8px; font-size:15px; font-weight:bold; cursor:pointer;">Gestão de Estágios</button>
            </div>
        
          <div id="conteudoDashFinanceiroResumo">
            <div style="margin:24px 0 0 0; display:flex; flex-direction:column; align-items:center;">
                <div style="width:180px; height:180px; margin-bottom:8px; position:relative;">
                    <canvas id="graficoFinanceiro" width="180" height="180"></canvas>
                    <div id="graficoFinanceiroLabels" style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;pointer-events:none;">
                        <!-- Valores centrais serão inseridos via JS -->
                    </div>
                </div>
                
    <div id="graficoFinanceiroLegenda" style="display:flex; gap:12px; justify-content:center; margin-top:2px; flex-wrap:wrap; font-size:13px;">
        <div style="display:flex;align-items:center;gap:4px;">
            <span style="display:inline-block;width:14px;height:14px;background:#27ae60;border-radius:3px;"></span>
            Ganhos
        </div>
        <div style="display:flex;align-items:center;gap:4px;">
            <span style="display:inline-block;width:14px;height:14px;background:#c00;border-radius:3px;"></span>
            Perdas
        </div>
        <div style="display:flex;align-items:center;gap:4px;">
            <span style="display:inline-block;width:14px;height:14px;background:#f39c12;border-radius:3px;"></span>
            Abertos
        </div>
    </div>
</div>
<div id="listaAbertosFinanceiro" style="margin-top:18px; background:linear-gradient(120deg,#eafbe6 60%,#fffbe6 100%); border-radius:16px; padding:18px; max-height:260px; overflow:auto; box-shadow:0 2px 12px #27ae6011;">
    <div style="display:flex; gap:12px; justify-content:space-between; align-items:center; margin-bottom:18px;">
        <div style="flex:1; background:#eafbe6; border-radius:10px; padding:14px; text-align:center; box-shadow:0 2px 8px #27ae6011;">
            <span style="font-size:15px; color:#27ae60; font-weight:600; letter-spacing:1px;">Ganhos</span>
            <div style="font-size:22px; color:#27ae60; font-weight:bold; margin-top:4px;" id="valorGanhos">R$ 0,00</div>
            <div style="font-size:12px; color:#34495e; margin-top:2px;">Clientes fechados</div>
        </div>
        <div style="flex:1; background:#ffeaea; border-radius:10px; padding:14px; text-align:center; box-shadow:0 2px 8px #c001;">
            <span style="font-size:15px; color:#c00; font-weight:600; letter-spacing:1px;">Perdas</span>
            <div style="font-size:22px; color:#c00; font-weight:bold; margin-top:4px;" id="valorPerdas">R$ 0,00</div>
            <div style="font-size:12px; color:#34495e; margin-top:2px;">Diferença entre início e fechamento</div>
        </div>
        <div style="flex:1; background:#fffbe6; border-radius:10px; padding:14px; text-align:center; box-shadow:0 2px 8px #f39c1211;">
            <span style="font-size:15px; color:#f39c12; font-weight:600; letter-spacing:1px;">Abertos</span>
            <div style="font-size:22px; color:#f39c12; font-weight:bold; margin-top:4px;" id="valorAbertos">R$ 0,00</div>
            <div style="font-size:12px; color:#34495e; margin-top:2px;">Orçamentos em andamento</div>
        </div>
    </div>
    <!-- Substitua o bloco de "Detalhes dos Clientes" por este novo bloco com filtros -->
<div style="margin-bottom:10px; display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:space-between;">
    <span style="font-size:16px; color:#34495e; font-weight:600;">Detalhes dos Clientes</span>
    <div style="display:flex; gap:8px; align-items:center;">
        <label for="filtroMesFinanceiro" style="font-size:13px; color:#34495e;">Mês:</label>
        <select id="filtroMesFinanceiro" style="padding:4px 8px; border-radius:6px; border:1px solid #ccc; font-size:13px;">
            <option value="">Todos</option>
            <option value="1">Janeiro</option>
            <option value="2">Fevereiro</option>
            <option value="3">Março</option>
            <option value="4">Abril</option>
            <option value="5">Maio</option>
            <option value="6">Junho</option>
            <option value="7">Julho</option>
            <option value="8">Agosto</option>
            <option value="9">Setembro</option>
            <option value="10">Outubro</option>
            <option value="11">Novembro</option>
            <option value="12">Dezembro</option>
        </select>
        <label for="filtroAnoFinanceiro" style="font-size:13px; color:#34495e;">Ano:</label>
        <select id="filtroAnoFinanceiro" style="padding:4px 8px; border-radius:6px; border:1px solid #ccc; font-size:13px;">
            <option value="">Todos</option>
        </select>
        <button onclick="aplicarFiltroFinanceiro()" style="padding:4px 12px; background:#27ae60; color:#fff; border:none; border-radius:6px; font-size:13px;">Filtrar</button>
        <button onclick="resetarFiltroFinanceiro()" style="padding:4px 12px; background:#888; color:#fff; border:none; border-radius:6px; font-size:13px;">Limpar</button>
    </div>
</div>
<div id="detalhesFinanceiroCards"></div>
</div>
<!-- Conteúdo da aba Gestão de Estágios -->
       
        
    </div>
</div>
  </div>
</div>
<!-- Modal de Detalhes Financeiros -->
<div id="modalDetalhesFinanceiro" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.65); z-index:10000; align-items:center; justify-content:center;">
  <div id="boxDetalhesFinanceiro" style="background:#fff; border-radius:18px; padding:28px 18px 22px 18px; max-width:340px; width:92vw; max-height:80vh; overflow:auto; position:relative; box-shadow:0 8px 32px #27ae6022; animation:fadeInDetalhe 0.6s;">
    <button onclick="fecharModalDetalhesFinanceiro()" style="position:absolute;top:10px;right:10px;background:#f44336;color:#fff;border:none;border-radius:50%;width:28px;height:28px;font-size:18px;cursor:pointer;">&times;</button>
    <h4 id="tituloDetalhesFinanceiro" style="color:#27ae60; text-align:center; margin-bottom:10px; font-size:19px; letter-spacing:1px;">Detalhes</h4>
    <div id="conteudoDetalhesFinanceiro" style="font-size:13px;"></div>
  </div>
</div>
<style>
    @keyframes fadeInDetalhe {
  from { opacity:0; transform:scale(0.92);}
  to { opacity:1; transform:scale(1);}
}
#modalDetalhesFinanceiro {
  display: none;
  align-items: center !important;
  justify-content: center !important;
}
#modalDetalhesFinanceiro[style*="display: flex"] {
  display: flex !important;
}
#boxDetalhesFinanceiro .estagio-animado {
  opacity: 0;
  transform: translateY(30px) scale(0.98);
  animation: estagioFadeIn 0.5s forwards;
}
#boxDetalhesFinanceiro .estagio-animado:nth-child(1) { animation-delay: 0.05s;}
#boxDetalhesFinanceiro .estagio-animado:nth-child(2) { animation-delay: 0.12s;}
#boxDetalhesFinanceiro .estagio-animado:nth-child(3) { animation-delay: 0.19s;}
#boxDetalhesFinanceiro .estagio-animado:nth-child(4) { animation-delay: 0.26s;}
#boxDetalhesFinanceiro .estagio-animado:nth-child(5) { animation-delay: 0.33s;}
#boxDetalhesFinanceiro .estagio-animado:nth-child(6) { animation-delay: 0.40s;}
@keyframes estagioFadeIn {
  to { opacity:1; transform:translateY(0) scale(1);}
}
#boxDetalhesFinanceiro .estagio-animado {
  background: linear-gradient(90deg,#eafbe6 80%,#fff 100%);
  border-left: 5px solid #27ae60;
  border-radius: 8px;
  margin-bottom: 10px;
  padding: 10px 12px;
  box-shadow: 0 2px 8px #27ae6011;
  position: relative;
  transition: box-shadow 0.2s;
}
#boxDetalhesFinanceiro .estagio-animado.perda {
  border-left: 5px solid #c00;
  background: linear-gradient(90deg,#ffeaea 80%,#fff 100%);
}
#boxDetalhesFinanceiro .estagio-animado.aberto {
  border-left: 5px solid #f39c12;
  background: linear-gradient(90deg,#fffbe6 80%,#fff 100%);
}
#boxDetalhesFinanceiro .valor-animado {
  font-size: 16px;
  font-weight: bold;
  color: #27ae60;
  float: right;
  margin-left: 8px;
  letter-spacing: 1px;
  animation: valorPulse 0.7s infinite alternate;
}
#boxDetalhesFinanceiro .valor-animado.perda { color: #c00; }
#boxDetalhesFinanceiro .valor-animado.aberto { color: #f39c12; }
@keyframes valorPulse {
  0% { filter: brightness(1);}
  100% { filter: brightness(1.25);}
}
    #painelOrcamentoEstagios .estagio-orcamento {
        background: linear-gradient(90deg,#e3eafc 80%,#fff 100%);
        border:2px solid #1F3695;
        border-radius:12px;
        padding:16px 18px;
        min-width:220px;
        margin-bottom:8px;
        position:relative;
        box-shadow:0 2px 8px #1F369522;
        transition:box-shadow 0.2s, transform 0.2s;
        animation: fadeIn 0.5s;
    }
    #painelOrcamentoEstagios .estagio-orcamento:hover {
        box-shadow:0 4px 16px #1F369544;
        transform:scale(1.03);
    }
    #painelOrcamentoEstagios .remover-estagio {
        position:absolute; top:10px; right:10px; background:#f44336; color:#fff; border:none; border-radius:50%; width:28px; height:28px; font-size:16px; cursor:pointer;
        transition:background 0.2s;
    }
    #painelOrcamentoEstagios .remover-estagio:hover { background:#c00; }
    @keyframes fadeIn { from { opacity:0; transform:translateY(20px);} to { opacity:1; transform:translateY(0);} }
    /* ...existing code... */
#painelOrcamentoEstagiosDireto .estagio-orcamento {
    transition: box-shadow 0.2s, border 0.2s, background 0.2s;
    cursor: grab;
}
#painelOrcamentoEstagiosDireto .estagio-orcamento:active {
    box-shadow: 0 4px 16px #1F369544;
    background: #f7f9fb;
}
#painelOrcamentoEstagiosDireto input, #painelOrcamentoEstagiosDireto textarea {
    font-size: 14px;
}
</style>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
    // ...existing code...
function abrirDashFinanceiro() {
    document.getElementById('modalDashFinanceiro').style.display = 'flex';
    carregarDashFinanceiro();
    document.getElementById('btnMiniDashFinanceiro').style.display = 'none';
}
function fecharDashFinanceiro() {
    document.getElementById('modalDashFinanceiro').style.display = 'none';
    document.getElementById('btnMiniDashFinanceiro').style.display = 'flex';
}
// Substitua a função carregarDashFinanceiro por esta versão melhorada
async function carregarDashFinanceiro(usandoFiltro = false) {
    const clientes = await fetch('/api/clientes').then(r => r.json()).catch(() => []);
    // Preencher anos no filtro ao abrir o modal
    if (!usandoFiltro) preencherAnosFinanceiro(clientes);

    // Filtros
    const mesFiltro = Number(document.getElementById('filtroMesFinanceiro')?.value) || null;
    const anoFiltro = Number(document.getElementById('filtroAnoFinanceiro')?.value) || null;

    let ganhos = 0, perdas = 0, abertos = 0;
    let listaAbertos = [];
    let listaGanhos = [];
    let listaPerdas = [];

    // Função para checar se o cliente entra no filtro (usando dataCadastro)
    function clienteNoFiltro(cliente) {
        if (!mesFiltro && !anoFiltro) return true;
        if (!cliente.dataCadastro) return false;
        const dataRef = new Date(cliente.dataCadastro);
        if (mesFiltro && (dataRef.getMonth() + 1) !== mesFiltro) return false;
        if (anoFiltro && dataRef.getFullYear() !== anoFiltro) return false;
        return true;
    }

    clientes.forEach(c => {
        if (!clienteNoFiltro(c)) return;
        if (Array.isArray(c.progressoEstagios)) {
            // Ganhos
            if (c.status === 'Fechado') {
                let valorTotal = 0;
                c.progressoEstagios.forEach(e => {
                    if (e.valor && !isNaN(Number(e.valor))) {
                        valorTotal += Number(e.valor);
                    }
                });
                if (valorTotal > 0) {
                    ganhos += valorTotal;
                    listaGanhos.push({
                        ...c,
                        valor: valorTotal,
                        prospec: c.progressoEstagios.filter(e => e.nome && e.nome.toLowerCase().includes('prospec'))
                    });
                }
            }
            // Perdas
            if (c.status === 'Fechado' && c.progressoEstagios.length > 1) {
                const valorInicial = Number(c.progressoEstagios[0].valor) || 0;
                const valorFinal = Number(c.progressoEstagios[c.progressoEstagios.length - 1].valor) || 0;
                if (valorFinal < valorInicial) {
                    const perda = valorInicial - valorFinal;
                    if (perda > 0) {
                        perdas += perda;
                        listaPerdas.push({
                            ...c,
                            valorInicial,
                            valorFinal,
                            perda,
                            prospec: c.progressoEstagios.filter(e => e.nome && e.nome.toLowerCase().includes('prospec'))
                        });
                    }
                }
            }
            // Abertos
            if (c.status !== 'Fechado' && c.status !== 'Perdido') {
                let valorTotal = 0;
                c.progressoEstagios.forEach(e => {
                    if (e.valor && !isNaN(Number(e.valor))) {
                        valorTotal += Number(e.valor);
                    }
                });
                if (valorTotal > 0) {
                    abertos += valorTotal;
                    listaAbertos.push({
                        ...c,
                        valor: valorTotal,
                        prospec: c.progressoEstagios.filter(e => e.nome && e.nome.toLowerCase().includes('prospec'))
                    });
                }
            }
        }
    });

    animarValor('valorGanhos', ganhos, '#27ae60');
    animarValor('valorPerdas', perdas, '#c00');
    animarValor('valorAbertos', abertos, '#f39c12');
    desenharGraficoFinanceiro(ganhos, perdas, abertos);


    // Cards detalhados
   const detalhesDiv = document.getElementById('detalhesFinanceiroCards');
    detalhesDiv.innerHTML = `
        <div style="margin-bottom:8px; font-size:15px; color:#27ae60; font-weight:600; display:flex; align-items:center; gap:8px;">
            <span style="width:22px; height:22px; display:inline-block; vertical-align:middle;">
                <svg viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="10" fill="#eafbe6"/><path d="M7 13l3 3 7-7" stroke="#27ae60" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </span>
            Ganhos (Fechados)
        </div>
        ${listaGanhos.length === 0 ? '<span style="color:#888;">Nenhum ganho registrado.</span>' :
            listaGanhos.map(c => `
                <div style="margin:6px 0; border-left:5px solid #27ae60; background:#f8fff8; border-radius:8px; padding:8px 10px; box-shadow:0 1px 4px #27ae6011; display:grid; grid-template-columns:18px 1fr auto; align-items:center; gap:8px;">
                    <span style="width:18px; height:18px; display:inline-block; vertical-align:middle;">
                        <svg viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="10" fill="#eafbe6"/><path d="M7 13l3 3 7-7" stroke="#27ae60" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>
                    </span>
                    <div style="min-width:0;">
                        <span style="color:#34495e; font-weight:bold; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${c.nome}</span>
                        <span style="color:#888; font-size:12px; display:block;">${c.email ? ' ('+c.email+')' : ''}${c.telefone ? ' | ' + c.telefone : ''}</span>
                        <div style="font-size:12px; color:#22304a; margin-top:2px;">
                            <b>Prospecção:</b> ${c.prospec && c.prospec.length ? c.prospec.map(e => e.nome).join(', ') : 'N/A'}
                        </div>
                        <div style="font-size:11px; color:#888; margin-top:2px;">
                            <b>Cadastro:</b> ${c.dataCadastro ? new Date(c.dataCadastro).toLocaleDateString('pt-BR') : '-'}
                        </div>
                    </div>
                    <div style="display:flex; flex-direction:column; align-items:flex-end; gap:4px;">
                        <span style="color:#27ae60; font-weight:bold; font-size:15px; min-width:90px; text-align:right;">R$ ${c.valor.toLocaleString('pt-BR', {minimumFractionDigits:2})}</span>
                        <button
                            onclick="abrirDetalhesFinanceiro(
                                encodeURIComponent(JSON.stringify(c.progressoEstagios)),
                                '${c.nome.replace(/'/g,"\\'")}',
                                undefined, undefined, ''
                            )"
                            title="Ver origem"
                            style="background:#27ae60; color:#fff; border:none; border-radius:6px; padding:2px 8px; font-size:13px; cursor:pointer;">
                            <span style="width:16px; height:16px; display:inline-block; vertical-align:middle;">
                                <svg viewBox="0 0 24 24" fill="none"><circle cx="11" cy="11" r="8" stroke="#fff" stroke-width="2"/><line x1="16" y1="16" x2="21" y2="21" stroke="#fff" stroke-width="2" stroke-linecap="round"/></svg>
                            </span>
                        </button>
                    </div>
                </div>
            `).join('')}
        <div style="margin:12px 0 8px 0; font-size:15px; color:#c00; font-weight:600; display:flex; align-items:center; gap:8px;">
            <span style="width:22px; height:22px; display:inline-block; vertical-align:middle;">
                <svg viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="10" fill="#ffeaea"/><path d="M8 8l8 8M16 8l-8 8" stroke="#c00" stroke-width="2" stroke-linecap="round"/></svg>
            </span>
            Perdas (Comparativo)
        </div>
        ${listaPerdas.length === 0 ? '<span style="color:#888;">Nenhuma perda registrada.</span>' :
            listaPerdas.map(c => `
                <div style="margin:6px 0; border-left:5px solid #c00; background:#fff6f6; border-radius:8px; padding:8px 10px; box-shadow:0 1px 4px #c001; display:grid; grid-template-columns:18px 1fr auto; align-items:center; gap:8px;">
                    <span style="width:18px; height:18px; display:inline-block; vertical-align:middle;">
                        <svg viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="10" fill="#ffeaea"/><path d="M8 8l8 8M16 8l-8 8" stroke="#c00" stroke-width="2" stroke-linecap="round"/></svg>
                    </span>
                    <div style="min-width:0;">
                        <span style="color:#34495e; font-weight:bold; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${c.nome}</span>
                        <span style="color:#888; font-size:12px; display:block;">${c.email ? ' ('+c.email+')' : ''}${c.telefone ? ' | ' + c.telefone : ''}</span>
                        <div style="font-size:12px; color:#22304a; margin-top:2px;">
                            <b>Prospecção:</b> ${c.prospec && c.prospec.length ? c.prospec.map(e => e.nome).join(', ') : 'N/A'}
                        </div>
                        <div style="font-size:11px; color:#888; margin-top:2px;">
                            <b>Cadastro:</b> ${c.dataCadastro ? new Date(c.dataCadastro).toLocaleDateString('pt-BR') : '-'}
                        </div>
                    </div>
                    <div style="display:flex; flex-direction:column; align-items:flex-end; gap:4px;">
                        <span style="color:#c00; font-weight:bold; font-size:15px; min-width:90px; text-align:right;">-R$ ${c.perda.toLocaleString('pt-BR', {minimumFractionDigits:2})}</span>
                        <button
                            onclick="abrirDetalhesFinanceiro(
                                encodeURIComponent(JSON.stringify(c.progressoEstagios)),
                                '${c.nome.replace(/'/g,"\\'")}',
                                ${typeof c.valorInicial !== 'undefined' ? c.valorInicial : 'undefined'},
                                ${typeof c.valorFinal !== 'undefined' ? c.valorFinal : 'undefined'},
                                'perda'
                            )"
                            title="Ver origem"
                            style="background:#c00; color:#fff; border:none; border-radius:6px; padding:2px 8px; font-size:13px; cursor:pointer;">
                            <span style="width:16px; height:16px; display:inline-block; vertical-align:middle;">
                                <svg viewBox="0 0 24 24" fill="none"><circle cx="11" cy="11" r="8" stroke="#fff" stroke-width="2"/><line x1="16" y1="16" x2="21" y2="21" stroke="#fff" stroke-width="2" stroke-linecap="round"/></svg>
                            </span>
                        </button>
                    </div>
                </div>
            `).join('')}
        <div style="margin:12px 0 8px 0; font-size:15px; color:#f39c12; font-weight:600; display:flex; align-items:center; gap:8px;">
            <span style="width:22px; height:22px; display:inline-block; vertical-align:middle;">
                <svg viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="10" fill="#fffbe6"/><path d="M12 6v6l4 2" stroke="#f39c12" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </span>
            Abertos
        </div>
        ${listaAbertos.length === 0 ? '<span style="color:#888;">Nenhum orçamento em aberto com valor registrado.</span>' :
            listaAbertos.map(c => `
                <div style="margin:6px 0; border-left:5px solid #f39c12; background:#fffbe6; border-radius:8px; padding:8px 10px; box-shadow:0 1px 4px #f39c1211; display:grid; grid-template-columns:18px 1fr auto; align-items:center; gap:8px;">
                    <span style="width:18px; height:18px; display:inline-block; vertical-align:middle;">
                        <svg viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="10" fill="#fffbe6"/><path d="M12 6v6l4 2" stroke="#f39c12" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                    </span>
                    <div style="min-width:0;">
                        <span style="color:#34495e; font-weight:bold; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${c.nome}</span>
                        <span style="color:#888; font-size:12px; display:block;">${c.email ? ' ('+c.email+')' : ''}${c.telefone ? ' | ' + c.telefone : ''}</span>
                        <div style="font-size:12px; color:#22304a; margin-top:2px;">
                            <b>Prospecção:</b> ${c.prospec && c.prospec.length ? c.prospec.map(e => e.nome).join(', ') : 'N/A'}
                        </div>
                        <div style="font-size:11px; color:#888; margin-top:2px;">
                            <b>Cadastro:</b> ${c.dataCadastro ? new Date(c.dataCadastro).toLocaleDateString('pt-BR') : '-'}
                        </div>
                    </div>
                    <div style="display:flex; flex-direction:column; align-items:flex-end; gap:4px;">
                        <span style="color:#f39c12; font-weight:bold; font-size:15px; min-width:90px; text-align:right;">R$ ${c.valor.toLocaleString('pt-BR', {minimumFractionDigits:2})}</span>
                        <button
                            onclick="abrirDetalhesFinanceiro(
                                encodeURIComponent(JSON.stringify(c.progressoEstagios)),
                                '${c.nome.replace(/'/g,"\\'")}',
                                ${typeof c.valorInicial !== 'undefined' ? c.valorInicial : 'undefined'},
                                ${typeof c.valorFinal !== 'undefined' ? c.valorFinal : 'undefined'},
                                'aberto'
                            )"
                            title="Ver origem"
                            style="background:#f39c12; color:#fff; border:none; border-radius:6px; padding:2px 8px; font-size:13px; cursor:pointer;">
                            <span style="width:16px; height:16px; display:inline-block; vertical-align:middle;">
                                <svg viewBox="0 0 24 24" fill="none"><circle cx="11" cy="11" r="8" stroke="#fff" stroke-width="2"/><line x1="16" y1="16" x2="21" y2="21" stroke="#fff" stroke-width="2" stroke-linecap="round"/></svg>
                            </span>
                        </button>
                    </div>
                </div>
            `).join('')}
    `;
}
// Torna as funções globais para o HTML acessar
window.aplicarFiltroFinanceiro = function() {
    carregarDashFinanceiro(true);
};
window.resetarFiltroFinanceiro = function() {
    document.getElementById('filtroMesFinanceiro').value = '';
    document.getElementById('filtroAnoFinanceiro').value = '';
    carregarDashFinanceiro(true);
};
window.abrirDetalhesFinanceiro = function(estagiosStr, nome, valorInicial, valorFinal, tipo) {
    let estagios;
    try {
        estagios = JSON.parse(decodeURIComponent(estagiosStr));
    } catch { estagios = []; }
    let html = `<div style="margin-bottom:8px;"><strong>Cliente:</strong> ${nome}</div>`;
    if (typeof valorInicial !== 'undefined' && typeof valorFinal !== 'undefined') {
        html += `<div style="margin-bottom:8px;">
            <strong>Valor inicial:</strong> R$ ${Number(valorInicial).toLocaleString('pt-BR', {minimumFractionDigits:2})}<br>
            <strong>Valor final:</strong> R$ ${Number(valorFinal).toLocaleString('pt-BR', {minimumFractionDigits:2})}
        </div>`;
    }
    html += `<div style="margin-bottom:8px;"><strong>Estágios financeiros:</strong></div>`;
    html += estagios.map((e, idx) => `
        <div class="estagio-animado${tipo ? ' '+tipo : ''}" style="animation-delay:${0.08*idx}s;">
            <span style="font-weight:bold; color:#34495e;">${e.nome}</span>
            <span class="valor-animado${tipo ? ' '+tipo : ''}">R$ ${Number(e.valor||0).toLocaleString('pt-BR', {minimumFractionDigits:2})}</span>
            <div style="font-size:12px; color:#888;">${e.obs ? e.obs : ''}</div>
        </div>
    `).join('');
    document.getElementById('tituloDetalhesFinanceiro').innerText = `Detalhes de ${nome}`;
    document.getElementById('conteudoDetalhesFinanceiro').innerHTML = html;
    document.getElementById('modalDetalhesFinanceiro').style.display = 'flex';
};
window.fecharModalDetalhesFinanceiro = function() {
    document.getElementById('modalDetalhesFinanceiro').style.display = 'none';
};
// Substitua a função desenharGraficoFinanceiro por esta versão, que garante que o gráfico e os valores centrais sejam exibidos corretamente:

function desenharGraficoFinanceiro(ganhos, perdas, abertos = 0) {
    if (window.graficoFinanceiroObj) window.graficoFinanceiroObj.destroy();
    const ctx = document.getElementById('graficoFinanceiro').getContext('2d');
    window.graficoFinanceiroObj = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Ganhos', 'Perdas', 'Abertos'],
            datasets: [{
                data: [ganhos, perdas, abertos],
                backgroundColor: ['#27ae60', '#c00', '#f39c12'],
                borderWidth: 0
            }]
        },
        options: {
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.parsed || 0;
                            return `${label}: R$ ${Number(value).toLocaleString('pt-BR', {minimumFractionDigits:2})}`;
                        }
                    }
                }
            },
            cutout: '70%',
            responsive: false
        }
    });

    // Mostra os valores centrais no gráfico
    const total = ganhos + perdas + abertos;
    let html = '';
    if (total > 0) {
        html = `
            <div style="font-size:15px;color:#34495e;font-weight:600;">Total</div>
            <div style="font-size:18px;color:#1F3695;font-weight:bold;">R$ ${total.toLocaleString('pt-BR', {minimumFractionDigits:2})}</div>
        `;
    } else {
        html = `<div style="font-size:13px;color:#888;">Sem dados</div>`;
    }
    const labelsDiv = document.getElementById('graficoFinanceiroLabels');
    if (labelsDiv) labelsDiv.innerHTML = html;
}
// Garanta que a função animarValor está correta e sendo chamada após desenharGraficoFinanceiro:

function animarValor(id, valorFinal, cor) {
    const el = document.getElementById(id);
    let atual = 0;
    const incremento = Math.max(valorFinal / 40, 1);
    el.style.color = cor;
    function animar() {
        atual += incremento;
        if (atual >= valorFinal) atual = valorFinal;
        el.textContent = 'R$ ' + atual.toLocaleString('pt-BR', {minimumFractionDigits:2});
        if (atual < valorFinal) requestAnimationFrame(animar);
    }
    animar();
}


function preencherAnosFinanceiro(clientes) {
    const selectAno = document.getElementById('filtroAnoFinanceiro');
    if (!selectAno) return;
    const anos = new Set();
    clientes.forEach(c => {
        if (c.dataCadastro) {
            const ano = new Date(c.dataCadastro).getFullYear();
            if (!isNaN(ano)) anos.add(ano);
        }
    });
    const anosArray = Array.from(anos).sort((a, b) => b - a);
    selectAno.innerHTML = '<option value="">Todos</option>' +
        anosArray.map(ano => `<option value="${ano}">${ano}</option>`).join('');
}
// Coloque este JS no final do seu arquivo ou após carregarDashFinanceiro
window.abrirDetalhesFinanceiro = function(estagiosStr, nome, valorInicial, valorFinal, tipo) {
    let estagios;
    try {
        estagios = JSON.parse(decodeURIComponent(estagiosStr));
    } catch { estagios = []; }
    let html = `<div style="margin-bottom:8px;"><strong>Cliente:</strong> ${nome}</div>`;
    if (typeof valorInicial !== 'undefined' && typeof valorFinal !== 'undefined') {
        html += `<div style="margin-bottom:8px;">
            <strong>Valor inicial:</strong> R$ ${Number(valorInicial).toLocaleString('pt-BR', {minimumFractionDigits:2})}<br>
            <strong>Valor final:</strong> R$ ${Number(valorFinal).toLocaleString('pt-BR', {minimumFractionDigits:2})}
        </div>`;
    }
    html += `<div style="margin-bottom:8px;"><strong>Estágios financeiros:</strong></div>`;
    html += estagios.map((e, idx) => `
        <div class="estagio-animado${tipo ? ' '+tipo : ''}" style="animation-delay:${0.08*idx}s;">
            <span style="font-weight:bold; color:#34495e;">${e.nome}</span>
            <span class="valor-animado${tipo ? ' '+tipo : ''}">R$ ${Number(e.valor||0).toLocaleString('pt-BR', {minimumFractionDigits:2})}</span>
            <div style="font-size:12px; color:#888;">${e.obs ? e.obs : ''}</div>
        </div>
    `).join('');
    document.getElementById('tituloDetalhesFinanceiro').innerText = `Detalhes de ${nome}`;
    document.getElementById('conteudoDetalhesFinanceiro').innerHTML = html;
    document.getElementById('modalDetalhesFinanceiro').style.display = 'flex';
    
};
// Troca de abas do Dashboard Financeiro (corrigido)
document.addEventListener('DOMContentLoaded', function () {
    const btnResumo = document.getElementById('abaDashFinanceiroResumo');
    const btnEstagios = document.getElementById('abaDashFinanceiroEstagios');
    const conteudoResumo = document.getElementById('conteudoDashFinanceiroResumo');
    const conteudoEstagios = document.getElementById('conteudoDashFinanceiroEstagios');
    if (btnResumo && btnEstagios && conteudoResumo && conteudoEstagios) {
        btnResumo.onclick = function () {
            btnResumo.style.background = '#27ae60';
            btnEstagios.style.background = '#22304a';
            conteudoResumo.style.display = '';
            conteudoEstagios.style.display = 'none';
        };
        btnEstagios.onclick = function () {
            btnResumo.style.background = '#22304a';
            btnEstagios.style.background = '#27ae60';
            conteudoResumo.style.display = 'none';
            conteudoEstagios.style.display = '';
            if (typeof carregarDashFinanceiroEstagios === 'function') carregarDashFinanceiroEstagios();
        };
    }
});
// --- Gráfico exclusivo para Gestão de Estágios do Orçamento ---
async function carregarDashFinanceiroEstagios() {
    // Busca todos os clientes
    const clientes = await fetch('/api/clientes').then(r => r.json()).catch(() => []);
    // ...existing code...
let totalEstagios = 0;
let estagiosDetalhados = [];

clientes.forEach(c => {
    // Aqui, busque os estágios do orçamento fechado
    if (Array.isArray(c.orcamentosFechados)) {
        c.orcamentosFechados.forEach(orc => {
            if (Array.isArray(orc.estagios)) {
                orc.estagios.forEach(e => {
                    if (e.valor && !isNaN(Number(e.valor))) {
                        totalEstagios += Number(e.valor);
                        estagiosDetalhados.push({
                            nome: e.nome,
                            valor: Number(e.valor),
                            cliente: c.nome,
                            obs: e.obs || ''
                        });
                    }
                });
            }
        });
    }
});

    // Desenha o gráfico doughnut exclusivo dos estágios
    if (window.graficoFinanceiroEstagiosObj) window.graficoFinanceiroEstagiosObj.destroy();
    const ctx = document.getElementById('graficoFinanceiroEstagios').getContext('2d');
    window.graficoFinanceiroEstagiosObj = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Valor Total dos Estágios'],
            datasets: [{
                data: [totalEstagios],
                backgroundColor: ['#1F3695'],
                borderWidth: 0
            }]
        },
        options: {
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const value = context.parsed || 0;
                            return `Total: R$ ${Number(value).toLocaleString('pt-BR', {minimumFractionDigits:2})}`;
                        }
                    }
                }
            },
            cutout: '70%',
            responsive: false
        }
    });

    // Valor central no gráfico
    document.getElementById('graficoFinanceiroEstagiosLabels').innerHTML = `
        <div style="font-size:15px;color:#34495e;font-weight:600;">Total Estágios</div>
        <div style="font-size:18px;color:#1F3695;font-weight:bold;">R$ ${totalEstagios.toLocaleString('pt-BR', {minimumFractionDigits:2})}</div>
    `;

   if (estagiosDetalhados.length === 0) {
    document.getElementById('detalhesEstagiosFinanceiro').innerHTML = '<span style="color:#888;">Nenhum estágio registrado.</span>';
} else {
    // Agrupa por cliente
    const porCliente = {};
    estagiosDetalhados.forEach(e => {
        if (!porCliente[e.cliente]) porCliente[e.cliente] = [];
        porCliente[e.cliente].push(e);
    });
    document.getElementById('detalhesEstagiosFinanceiro').innerHTML = Object.entries(porCliente).map(([cliente, estagios]) => `
        <div style="margin-bottom:10px; border-bottom:1px solid #eee; padding-bottom:6px;">
            <div style="font-weight:bold; color:#1F3695; margin-bottom:4px;">${cliente}</div>
            ${estagios.map(e => `
                <div style="margin:4px 0 4px 12px; border-left:4px solid #1F3695; background:#f7f9fb; border-radius:6px; padding:6px 10px;">
                    <strong>${e.nome}</strong> - R$ ${e.valor.toLocaleString('pt-BR', {minimumFractionDigits:2})}
                    <div style="font-size:12px;color:#888;">${e.obs ? e.obs : ''}</div>
                </div>
            `).join('')}
        </div>
    `).join('');
}
}

function fecharModalDetalhesFinanceiro() {
    document.getElementById('modalDetalhesFinanceiro').style.display = 'none';
}
  function abrirPainelOrcamentoDireto() {
    document.getElementById('modalPainelOrcamentoDireto').style.display = 'flex';
    document.getElementById('btnMiniOrcamento').style.display = 'none';
}
function fecharPainelOrcamentoDireto() {
    document.getElementById('modalPainelOrcamentoDireto').style.display = 'none';
    document.getElementById('btnMiniOrcamento').style.display = 'flex';
}
// ... Painel de Orçamentos Direto na tela de vendas ...
let estagiosOrcamentoDireto = [
    { nome: "Recebido", descricao: "Orçamento recebido do cliente.", valor: "", obs: "", concluido: false },
    { nome: "Em análise", descricao: "Análise técnica e comercial.", valor: "", obs: "", concluido: false },
    { nome: "Enviado", descricao: "Orçamento enviado ao cliente.", valor: "", obs: "", concluido: false }
];
let orcamentoFechadoDireto = null;

// ...existing code...
function renderizarEstagiosOrcamentoDireto() {
    const painel = document.getElementById('painelOrcamentoEstagiosDireto');
    const total = estagiosOrcamentoDireto.length;
    const concluidos = estagiosOrcamentoDireto.filter(e => e.concluido).length;
    painel.innerHTML = `
        <div style="margin-bottom:18px;">
            <div style="height:8px; background:#eee; border-radius:6px; overflow:hidden; margin-bottom:8px;">
                <div style="width:${(concluidos/total)*100}%; background:#27ae60; height:100%; transition:width 0.4s;"></div>
            </div>
            <span style="font-size:13px; color:#34495e;">${concluidos} de ${total} estágios concluídos</span>
        </div>
        ${estagiosOrcamentoDireto.map((e, idx) => `
        <div class="estagio-orcamento" style="
            border-color:${e.concluido?'#27ae60':'#1F3695'};
            background:${e.concluido?'linear-gradient(90deg,#eafbe6 80%,#fff 100%)':'#fff'};
            box-shadow:0 2px 8px ${e.concluido?'#27ae6011':'#1F369511'};
            margin-bottom:14px;
            position:relative;
            ">
            <div style="display:flex; align-items:center; gap:8px;">
                <strong style="color:${e.concluido?'#27ae60':'#1F3695'}; font-size:17px; flex:1;">
                    <span contenteditable="true" onblur="editarNomeEstagioDireto(${idx}, this.innerText)" style="outline:none; border-bottom:1px dashed #ccc; min-width:60px;">${e.nome}</span>
                </strong>
                <span style="font-size:13px; color:#888;">${e.concluido ? 'Concluído' : 'Pendente'}</span>
                <button onclick="duplicarEstagioOrcamentoDireto(${idx})" title="Duplicar estágio" style="background:#eee; border:none; border-radius:6px; padding:2px 8px; margin-left:6px; cursor:pointer;">&#x2398;</button>
                <button class="remover-estagio" onclick="removerEstagioOrcamentoDireto(${idx})" title="Remover estágio">&times;</button>
            </div>
            <div style="color:#34495e; font-size:15px; margin-top:6px;">
                <span contenteditable="true" onblur="editarDescricaoEstagioDireto(${idx}, this.innerText)" style="outline:none; border-bottom:1px dashed #ccc; min-width:60px;">${e.descricao}</span>
            </div>
            <div style="margin-top:10px; display:flex; gap:8px; align-items:center;">
                <input type="number" min="0" step="0.01" placeholder="Valor (R$)" value="${e.valor || ''}" 
                    onchange="atualizarValorEstagioDireto(${idx}, this.value)" style="width:90px; border-radius:6px; border:1px solid #ccc; padding:4px;">
                <input type="text" placeholder="Observação" value="${e.obs || ''}" 
                    onchange="atualizarObsEstagioDireto(${idx}, this.value)" style="flex:1; border-radius:6px; border:1px solid #ccc; padding:4px;">
            </div>
            <div style="margin-top:10px; display:flex; gap:8px; align-items:center;">
                <input type="date" value="${e.dataInicio || ''}" onchange="atualizarDataInicioEstagioDireto(${idx}, this.value)" style="border-radius:6px; border:1px solid #ccc; padding:4px;">
                <label style="font-size:13px; color:#888;">Início</label>
                <input type="date" value="${e.dataFim || ''}" onchange="atualizarDataFimEstagioDireto(${idx}, this.value)" style="border-radius:6px; border:1px solid #ccc; padding:4px;">
                <label style="font-size:13px; color:#888;">Conclusão</label>
            </div>
            <div style="margin-top:10px;">
                <button onclick="concluirEstagioOrcamentoDireto(${idx})" style="padding:6px 14px; background:${e.concluido?'#27ae60':'#1F3695'}; color:#fff; border:none; border-radius:8px; font-size:14px; font-weight:bold; margin-right:8px;">
                    ${e.concluido ? 'Concluído' : 'Concluir'}
                </button>
                ${idx === estagiosOrcamentoDireto.length-1 ? `<button onclick="abrirFecharOrcamentoDireto()" style="padding:6px 14px; background:#27ae60; color:#fff; border:none; border-radius:8px; font-size:14px; font-weight:bold;">Fechar Orçamento</button>` : ''}
            </div>
        </div>
        `).join('')}
    `;
    document.getElementById('fecharOrcamentoAreaDireto').style.display = 'none';
    document.getElementById('orcamentoResumoFinalDireto').style.display = 'none';
}

// Funções extras para edição inline e duplicação:
function editarNomeEstagioDireto(idx, novoNome) {
    estagiosOrcamentoDireto[idx].nome = novoNome;
}
function editarDescricaoEstagioDireto(idx, novaDesc) {
    estagiosOrcamentoDireto[idx].descricao = novaDesc;
}
function atualizarDataInicioEstagioDireto(idx, data) {
    estagiosOrcamentoDireto[idx].dataInicio = data;
}
function atualizarDataFimEstagioDireto(idx, data) {
    estagiosOrcamentoDireto[idx].dataFim = data;
}
function duplicarEstagioOrcamentoDireto(idx) {
    const copia = { ...estagiosOrcamentoDireto[idx], nome: estagiosOrcamentoDireto[idx].nome + ' (Cópia)' };
    estagiosOrcamentoDireto.splice(idx+1, 0, copia);
    renderizarEstagiosOrcamentoDireto();
}
function atualizarValorEstagioDireto(idx, valor) {
    estagiosOrcamentoDireto[idx].valor = valor;
}
function atualizarObsEstagioDireto(idx, obs) {
    estagiosOrcamentoDireto[idx].obs = obs;
}
function adicionarEstagioOrcamentoDireto() {
    const nome = prompt("Nome do novo estágio:");
    if (!nome) return;
    const descricao = prompt("Descrição do estágio:");
    estagiosOrcamentoDireto.push({ nome, descricao: descricao || '', valor: "", obs: "", concluido: false });
    renderizarEstagiosOrcamentoDireto();
}
function removerEstagioOrcamentoDireto(idx) {
    if (!confirm("Remover este estágio?")) return;
    estagiosOrcamentoDireto.splice(idx,1);
    renderizarEstagiosOrcamentoDireto();
}
function concluirEstagioOrcamentoDireto(idx) {
    estagiosOrcamentoDireto[idx].concluido = true;
    renderizarEstagiosOrcamentoDireto();
}
/*2. Drag & Drop dos estágios do orçamento direto */
document.addEventListener('DOMContentLoaded', function() {
    const painel = document.getElementById('painelOrcamentoEstagiosDireto');
    if (painel) {
        Sortable.create(painel, {
            animation: 150,
            handle: '.estagio-orcamento',
            onEnd: function (evt) {
                const moved = estagiosOrcamentoDireto.splice(evt.oldIndex-1, 1)[0];
                estagiosOrcamentoDireto.splice(evt.newIndex-1, 0, moved);
                renderizarEstagiosOrcamentoDireto();
            }
        });
    }
});
function abrirFecharOrcamentoDireto() {
    document.getElementById('fecharOrcamentoAreaDireto').style.display = 'block';
    document.getElementById('orcamentoResumoFinalDireto').style.display = 'none';
}
/* 3. Salvar orçamento fechado no backend */
async function salvarFechamentoOrcamentoDireto() {
    const clienteId = document.getElementById('clienteOrcamentoDireto').value;
    const tipologias = document.getElementById('tipologiasOrcamentoDireto').value.trim();
    const vendido = document.getElementById('vendidoOrcamentoDireto').value.trim();
    if (!clienteId) {
        alert('Selecione o cliente para vincular o orçamento!');
        return;
    }
    if (!tipologias || !vendido) {
        alert('Preencha as tipologias e o que foi vendido!');
        return;
    }
    orcamentoFechadoDireto = { tipologias, vendido, data: new Date().toLocaleString() };
    document.getElementById('fecharOrcamentoAreaDireto').style.display = 'none';
    document.getElementById('orcamentoResumoFinalDireto').style.display = 'block';
    document.getElementById('orcamentoResumoFinalDireto').innerHTML = `
        <h4 style="color:#27ae60;">Orçamento Fechado!</h4>
        <p><strong>Cliente:</strong> ${document.getElementById('clienteOrcamentoDireto').selectedOptions[0].textContent}</p>
        <p><strong>Tipologias:</strong> ${orcamentoFechadoDireto.tipologias}</p>
        <p><strong>O que foi vendido:</strong> ${orcamentoFechadoDireto.vendido}</p>
        <p style="color:#888; font-size:13px;">Fechado em: ${orcamentoFechadoDireto.data}</p>
        <button onclick="exportarOrcamentoPDF()" style="margin-top:10px;padding:8px 18px;background:#22304a;color:white;border:none;border-radius:8px;font-size:15px;">Exportar PDF</button>
    `;
    // Salva no backend
    try {
        await fetch(`/api/clientes/${clienteId}/orcamento-fechado`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                estagios: estagiosOrcamentoDireto,
                tipologias,
                vendido
            })
        });
        // Notificação automática
        if (Notification && Notification.permission === "granted") {
            new Notification("Orçamento fechado com sucesso!");
        } else if (Notification && Notification.permission !== "denied") {
            Notification.requestPermission().then(permission => {
                if (permission === "granted") new Notification("Orçamento fechado com sucesso!");
            });
        }
    } catch {
        alert('Erro ao salvar orçamento no backend!');
    }
}
document.addEventListener('DOMContentLoaded', function() {
    renderizarEstagiosOrcamentoDireto();
});
function normalizarTexto(str) {
    return (str || '').normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase();
}

// ...código existente...
let todosClientesOrcamentoDireto = [];
async function carregarClientesOrcamentoDireto() {
    const select = document.getElementById('clienteOrcamentoDireto');
    const busca = normalizarTexto(document.getElementById('buscaClienteOrcamentoDireto')?.value || '');
    if (!select) return;
    select.innerHTML = '<option value="">Selecione o cliente</option>';
    try {
        const res = await fetch('/api/clientes');
        const clientes = await res.json();
        console.log('Clientes recebidos:', clientes); // <-- ADICIONE ESTA LINHA
        todosClientesOrcamentoDireto = clientes.filter(c => !c.orcamentoFechado);
        console.log('Clientes sem orçamento fechado:', todosClientesOrcamentoDireto); // <-- ADICIONE ESTA LINHA
        const filtrados = todosClientesOrcamentoDireto.filter(c => {
            if (!busca) return true;
            return (
                normalizarTexto(c.nome || '').includes(busca) ||
                normalizarTexto(c.email || '').includes(busca) ||
                normalizarTexto(c.telefone || '').includes(busca) ||
                normalizarTexto(c.enderecoObra || '').includes(busca) ||
                normalizarTexto(c.grupoObra || '').includes(busca) ||
                normalizarTexto(c.vendedor || '').includes(busca)
            );
        });
        console.log('Clientes filtrados:', filtrados); // <-- ADICIONE ESTA LINHA
        if (filtrados.length === 0) {
            select.innerHTML = '<option value="">Nenhum cliente encontrado</option>';
            return;
        }
        filtrados.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c.id;
            opt.textContent = `${c.nome} ${c.email ? `(${c.email})` : ''} ${c.telefone ? `- ${c.telefone}` : ''} ${c.grupoObra ? `- ${c.grupoObra}` : ''}`;
            select.appendChild(opt);
        });
    } catch {
        select.innerHTML = '<option value="">Erro ao carregar clientes</option>';
    }
}
/* 4. Histórico de orçamentos fechados por cliente */
async function mostrarHistoricoOrcamentosCliente(clienteId) {
    const res = await fetch(`/api/clientes/${clienteId}`);
    const cliente = await res.json();
    if (!cliente || !cliente.orcamentosFechados || !cliente.orcamentosFechados.length) {
        alert('Nenhum orçamento fechado para este cliente.');
        return;
    }
    let html = `<h4>Histórico de Orçamentos Fechados</h4>`;
    cliente.orcamentosFechados.forEach((o, idx) => {
        html += `
            <div style="border:1px solid #ccc; border-radius:8px; padding:10px; margin-bottom:8px; background:#f9f9f9;">
                <strong>Data:</strong> ${o.data || '-'}<br>
                <strong>Tipologias:</strong> ${o.tipologias || '-'}<br>
                <strong>Vendido:</strong> ${o.vendido || '-'}<br>
                <strong>Estágios:</strong> ${Array.isArray(o.estagios) ? o.estagios.map(e => e.nome).join(', ') : '-'}
            </div>
        `;
    });
    // Exibe em um modal simples
    const modal = document.createElement('div');
    modal.style = "position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.65);z-index:9999;display:flex;align-items:center;justify-content:center;";
    modal.innerHTML = `<div style="background:#fff;border-radius:14px;padding:32px 24px;max-width:600px;width:95vw;max-height:90vh;overflow:auto;position:relative;">
        <button onclick="this.parentElement.parentElement.remove()" style="position:absolute;top:12px;right:18px;background:#f44336;color:#fff;border:none;border-radius:50%;width:32px;height:32px;font-size:22px;cursor:pointer;">&times;</button>
        ${html}
    </div>`;
    document.body.appendChild(modal);
}
/* 5. Exportar orçamento em PDF */
// Substitua sua função exportarOrcamentoPDF por esta versão aprimorada
function exportarOrcamentoPDF() {
    const doc = new window.jspdf.jsPDF();
    const logoUrl = '/alumisantosslogo.png';

    const addLogoAndSave = (logoDataUrl) => {
        // Logo e título
        if (logoDataUrl) {
            doc.addImage(logoDataUrl, 'PNG', 12, 10, 32, 18);
        }
        doc.setFontSize(16);
        doc.setTextColor(30, 30, 30);
        doc.setFont('helvetica', 'bold');
        doc.text("Orçamento - Gerenciamento de Vendas", 55, 22);

        // Data de emissão
        doc.setFontSize(10);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(90, 90, 90);
        doc.text(`Data de emissão: ${new Date().toLocaleDateString('pt-BR')}`, 55, 29);

        // Linha divisória
        doc.setDrawColor(80, 80, 80);
        doc.setLineWidth(0.5);
        doc.line(10, 36, 200, 36);

        // Dados do Cliente
        doc.setFontSize(12);
        doc.setTextColor(30, 30, 30);
        doc.setFont('helvetica', 'bold');
        doc.text("Cliente:", 12, 46);
        doc.setFont('helvetica', 'normal');
        doc.text(document.getElementById('clienteOrcamentoDireto').selectedOptions[0].textContent, 38, 46);
        doc.text(`Tipologias: ${orcamentoFechadoDireto.tipologias}`, 12, 54);
        doc.text(`O que foi vendido: ${orcamentoFechadoDireto.vendido}`, 12, 62);

        // Título dos estágios
        let y = 74;
        doc.setDrawColor(80, 80, 80);
        doc.setLineWidth(0.4);
        doc.setFontSize(12);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(30, 30, 30);
        doc.text("Estágios do Orçamento", 12, y);

        y += 6;

        estagiosOrcamentoDireto.forEach((e, idx) => {
            // Divisória para separar cada estágio
            doc.setDrawColor(180, 180, 180);
            doc.setLineWidth(0.2);
            doc.line(12, y, 198, y);

            y += 4;
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(11.5);
            doc.setTextColor(30, 30, 30);
            doc.text(`${idx + 1}. ${e.nome}`, 16, y);

            doc.setFont('helvetica', 'normal');
            doc.setFontSize(10.5);
            doc.setTextColor(80, 80, 80);
            doc.text(`Descrição: ${e.descricao || '-'}`, 16, y + 6);

            doc.setTextColor(30, 30, 30);
            doc.text(`Valor: R$ ${e.valor || '0,00'}`, 120, y);

            doc.setTextColor(120, 120, 120);
            doc.text(`Obs: ${e.obs || '-'}`, 120, y + 6);

            // Se houver datas, exibe
            if (e.dataInicio || e.dataFim) {
                doc.setFontSize(9.5);
                doc.setTextColor(100, 100, 100);
                doc.text(`Início: ${e.dataInicio || '-'}`, 16, y + 12);
                doc.text(`Conclusão: ${e.dataFim || '-'}`, 60, y + 12);
                y += 6;
            }

            y += 14;
            if (y > 265) { doc.addPage(); y = 20; }
        });

        // Rodapé discreto
        doc.setDrawColor(200, 200, 200);
        doc.setLineWidth(0.5);
        doc.line(10, 285, 200, 285);
        doc.setFontSize(9);
        doc.setTextColor(120, 120, 120);
        doc.text("Gerado automaticamente pelo sistema Gerenciamento de Obras", 12, 292);

        doc.save("orcamento.pdf");
    };

    // Carrega o logo como base64 e chama addLogoAndSave
    const img = new window.Image();
    img.crossOrigin = "Anonymous";
    img.onload = function () {
        const canvas = document.createElement('canvas');
        canvas.width = img.width; canvas.height = img.height;
        canvas.getContext('2d').drawImage(img, 0, 0);
        const dataUrl = canvas.toDataURL('image/png');
        addLogoAndSave(dataUrl);
    };
    img.onerror = function () {
        addLogoAndSave('');
    };
    img.src = logoUrl;
}
/* 6. Notificação automática ao concluir todos os estágios */
function concluirEstagioOrcamentoDireto(idx) {
    estagiosOrcamentoDireto[idx].concluido = true;
    renderizarEstagiosOrcamentoDireto();
    if (estagiosOrcamentoDireto.every(e => e.concluido)) {
        if (Notification && Notification.permission === "granted") {
            new Notification("Todos os estágios do orçamento foram concluídos!");
        } else if (Notification && Notification.permission !== "denied") {
            Notification.requestPermission().then(permission => {
                if (permission === "granted") new Notification("Todos os estágios do orçamento foram concluídos!");
            });
        }
    }
}

// Função para excluir
async function excluirOrcamentoFechado(clienteId, idx, btn) {
    if (!confirm('Tem certeza que deseja excluir este orçamento do histórico?')) return;
    btn.disabled = true;
    await fetch(`/api/clientes/${clienteId}/orcamentos-fechados/${idx}`, { method: 'DELETE' });
    alert('Orçamento excluído!');
    document.querySelector('.modal-historico-orcamentos')?.remove();
    mostrarHistoricoOrcamentosCliente(clienteId);
}
async function editarOrcamentoFechado(clienteId, idx) {
    const tipologias = prompt('Nova tipologia:');
    const vendido = prompt('Novo vendido:');
    if (!tipologias || !vendido) return;
    await fetch(`/api/clientes/${clienteId}/orcamentos-fechados/${idx}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ tipologias, vendido })
    });
    alert('Orçamento editado!');
    document.querySelector('.modal-historico-orcamentos')?.remove();
    mostrarHistoricoOrcamentosCliente(clienteId);
}
// Mostra dados do cliente selecionado no painel de orçamento direto
document.getElementById('clienteOrcamentoDireto').addEventListener('change', function() {
    const id = this.value;
    const cliente = todosClientesOrcamentoDireto.find(c => c.id === id);
    const div = document.getElementById('dadosClienteOrcamentoDireto');
    if (!cliente) {
        div.style.display = 'none';
        return;
    }
    div.innerHTML = `
        <strong>Nome:</strong> ${cliente.nome}<br>
        <strong>Email:</strong> ${cliente.email || '-'}<br>
        <strong>Telefone:</strong> ${cliente.telefone || '-'}<br>
        <strong>Endereço:</strong> ${cliente.enderecoObra || '-'}<br>
        <strong>Grupo:</strong> ${cliente.grupoObra || '-'}<br>
        <strong>Vendedor:</strong> ${cliente.vendedor || '-'}
    `;
    div.style.display = 'block';
});
// Busca automática ao digitar (com debounce)
let buscaTimeout;
document.getElementById('buscaClienteOrcamentoDireto').addEventListener('input', function() {
    clearTimeout(buscaTimeout);
    buscaTimeout = setTimeout(carregarClientesOrcamentoDireto, 250);
});
// Carrega clientes ao abrir o painel
document.addEventListener('DOMContentLoaded', carregarClientesOrcamentoDireto);

// UX: Foca no campo de busca ao abrir o modal de orçamento
function abrirPainelOrcamentoDireto() {
    document.getElementById('modalPainelOrcamentoDireto').style.display = 'flex';
    document.getElementById('btnMiniOrcamento').style.display = 'none';
    setTimeout(() => document.getElementById('buscaClienteOrcamentoDireto').focus(), 200);
}
// Melhoria: permite pressionar Enter para selecionar o primeiro cliente encontrado
document.getElementById('buscaClienteOrcamentoDireto').addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
        const select = document.getElementById('clienteOrcamentoDireto');
        if (select.options.length > 1) {
            select.selectedIndex = 1;
            select.dispatchEvent(new Event('change'));
        }
    }
});

// Chame ao abrir o painel de orçamento ou ao carregar a tela de vendas
document.addEventListener('DOMContentLoaded', carregarClientesOrcamentoDireto);
</script>
    <div style="display:flex; flex-wrap:wrap; gap:12px; justify-content:center; margin-bottom:24px;">
      <button onclick="abrirModalCadastroCliente()" style="padding:12px 20px; background:#961c1c; color:white; border:none; border-radius:8px; font-size:16px;">Cadastro de Clientes</button>
        <button onclick="mostrarSubVendas('clientesRegistrados')" style="padding:12px 20px; background:#22304a; color:white; border:none; border-radius:8px; font-size:16px;">Clientes Registrados</button>
        <button onclick="mostrarSubVendas('prospeccao')" style="padding:12px 20px; background:#f39c12; color:white; border:none; border-radius:8px; font-size:16px;">Estágio de Prospecção</button>
        <button onclick="mostrarSubVendas('resumoClientes')" style="padding:12px 20px; background:#27ae60; color:white; border:none; border-radius:8px; font-size:16px;">Resumo de Clientes e Gestao de Vendedores</button>
        
    </div>
   <!-- Dentro do bloco #subVendasCadastroCliente, logo após os campos já existentes -->
<!-- Adicione os campos ao formulário de cadastro de clientes -->
<div id="modalCadastroCliente" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.65); z-index:10000; align-items:center; justify-content:center;">
  <div style="background:#fff; border-radius:18px; padding:36px 28px; max-width:420px; width:95vw; max-height:90vh; overflow:auto; position:relative; box-shadow:0 8px 32px #961c1c22; animation:fadeIn 0.6s;">
    <button onclick="fecharModalCadastroCliente()" style="position:absolute;top:18px;right:18px;background:#f44336;color:#fff;border:none;border-radius:50%;width:36px;height:36px;font-size:22px;cursor:pointer;">&times;</button>
   <div style="display:flex;gap:12px;flex-wrap:wrap;">
  <fieldset style="flex:1;min-width:180px;border:none;">
    <legend style="font-weight:bold;color:#22304a;">Dados do Cliente</legend>
   <!-- Exemplo de bloco com divisórias verticais -->
<div style="display: flex; align-items: flex-end; gap: 0; margin-bottom: 12px;">
  <div style="flex:1;">
    <label for="nomeCliente" style="font-size:14px;color:#22304a;">Nome do Cliente *</label>
    <input type="text" id="nomeCliente" placeholder="Nome do Cliente *" style="margin-bottom:0;">
  </div>
  <div style="width:1px; height:38px; background:#e0e0e0; margin:0 12px;"></div>
  <div style="flex:1;">
    <label for="telefoneCliente" style="font-size:14px;color:#22304a;">Telefone *</label>
    <input type="text" id="telefoneCliente" placeholder="Telefone *" style="margin-bottom:0;">
  </div>
</div>
    <input type="text" id="emailCliente" placeholder="E-mail" style="margin-bottom:8px;">
    <input type="date" id="dataCadastroCliente" placeholder="Data de Cadastro" style="margin-bottom:8px;">
  </fieldset>
  <fieldset style="flex:1;min-width:180px;border:none;">
    <legend style="font-weight:bold;color:#22304a;">Dados da Obra</legend>
    <div style="display: flex; align-items: flex-end; gap: 0; margin-bottom: 12px;">
  <div style="flex:1;">
    <label for="arquitetoObra" style="font-size:14px;color:#22304a;">Arquiteto</label>
    <input type="text" id="arquitetoObra" placeholder="Arquiteto da Obra" style="margin-bottom:0;">
  </div>
  <div style="width:1px; height:38px; background:#e0e0e0; margin:0 12px;"></div>
  <div style="flex:1;">
    <label for="contatoArquiteto" style="font-size:14px;color:#22304a;">Contato Arquiteto</label>
    <input type="text" id="contatoArquiteto" placeholder="Contato do Arquiteto" style="margin-bottom:0;">
  </div>
</div>
<!-- Bloco de campos lado a lado com divisória -->
<div style="display: flex; align-items: flex-end; gap: 0; margin-bottom: 12px;">
  <div style="flex:1;">
    <label for="responsavelObra" style="font-size:14px;color:#22304a;">Responsável pela Obra</label>
    <input type="text" id="responsavelObra" placeholder="Responsável pela Obra" style="margin-bottom:0;">
  </div>
  <div style="width:1px; height:38px; background:#e0e0e0; margin:0 12px;"></div>
  <div style="flex:1;">
    <label for="telefoneresponsavelObra" style="font-size:14px;color:#22304a;">Telefone do Responsável</label>
    <input type="text" id="telefoneresponsavelObra" placeholder="Telefone do Responsável" style="margin-bottom:0;">
  </div>
</div>

    <input type="text" id="enderecoObra" placeholder="Endereço da Obra *" style="margin-bottom:8px;">
    <select id="grupoObra" style="margin-bottom:8px;">
      <option value="">Selecione o Grupo (Cidade, Bairro ou Condomínio)</option>
    </select>
    <select id="vendedorResponsavel" style="margin-bottom:8px;">
      <option value="">Selecione o Vendedor</option>
    </select>
  </fieldset>
  <button onclick="toggleAccordion('blocoObs')" style="width:100%;text-align:left;">Observações &#9660;</button>
<div id="blocoObs" style="display:none; padding:10px 0;">
  <textarea id="obsCliente" placeholder="Observações..."></textarea>
  <input type="file" id="anexoObsCliente" multiple style="margin-top:8px;">
</div>
</div>
    <div style="display:flex; gap:8px; margin-bottom:8px;">
      <button onclick="abrirMenuCadastroGrupo()" style="flex:1; background:#22304a; color:#fff; border:none; border-radius:8px; font-size:15px; padding:8px;">Cadastrar Grupo</button>
      <button onclick="atualizarSelectGrupos()" style="flex:1; background:#27ae60; color:#fff; border:none; border-radius:8px; font-size:15px; padding:8px;">Atualizar Grupos</button>
    </div>
    <button onclick="salvarCliente()" style="padding:12px 0; background:#27ae60; color:white; border:none; border-radius:8px; font-size:17px; width:100%; font-weight:bold; margin-top:8px;display:flex;align-items:center;justify-content:center;gap:8px;">
  <img src="https://img.icons8.com/ios-filled/24/ffffff/save.png" style="vertical-align:middle;">Salvar Cliente
</button>
  </div>
</div>
<!-- No HTML -->
<button onclick="abrirMenuCadastroGrupo()">Cadastrar Novo Grupo</button>

<div id="modalCadastroGrupo" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.65); z-index:9999; align-items:center; justify-content:center;">
  <div style="background:#fff; border-radius:14px; padding:32px 24px; max-width:400px; width:95vw; position:relative;">
    <button onclick="fecharMenuCadastroGrupo()" style="position:absolute;top:12px;right:18px;background:#f44336;color:#fff;border:none;border-radius:50%;width:32px;height:32px;font-size:22px;cursor:pointer;">&times;</button>
    <h3 style="color:#34495e; text-align:center; margin-bottom:18px;">Cadastrar Novo Grupo</h3>
    <input type="text" id="novoGrupoNome" placeholder="Cidade, Bairro ou Condomínio" style="margin-bottom:12px; width:100%; border-radius:8px; border:1px solid #ccc; font-size:15px;">
    <button onclick="salvarGrupo()" style="padding:10px 20px; background:#27ae60; color:white; border:none; border-radius:8px; font-size:16px; width:100%;">Salvar Grupo</button>
    <div id="listaGruposCadastrados" style="margin-top:18px; max-height:120px; overflow-y:auto;"></div>
  </div>
</div>

<div id="subVendasClientesRegistrados" class="subvendas" style="display:none;">
    <h3 style="color:#22304a;">Clientes Registrados</h3>
    <input type="text" id="filtroCliente" placeholder="Buscar cliente..." style="margin-bottom:10px;">
    <button onclick="listarClientes()" style="margin-bottom:10px; padding:6px 16px; background:#961c1c; color:white; border:none; border-radius:8px;">Buscar</button>
    <div id="listaClientes"></div>
    <div id="painelCliente" style="display:none;"></div>
    <button onclick="voltarParaClientesRegistrados()" style="margin-bottom:18px; padding:10px 20px; background:#961c1c; color:white; border:none; border-radius:8px; font-size:16px;">Voltar</button>
    <h2 style="color:#961c1c; text-align:center; margin-bottom:18px;">Painel do Cliente</h2>
</div>
<!-- Substitua o conteúdo do modalDetalhesCliente pelo abaixo -->
<div id="modalDetalhesCliente" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(34,48,74,0.80); z-index:10000; align-items:center; justify-content:center;">
  <div style="background:#fff; border-radius:18px; padding:0; max-width:750px; width:97vw; max-height:92vh; overflow:auto; position:relative; box-shadow:0 8px 32px #22304a33; animation:fadeIn 0.6s;">
    <button onclick="fecharModalDetalhesCliente()" style="position:absolute;top:18px;right:18px;background:#f44336;color:#fff;border:none;border-radius:50%;width:36px;height:36px;font-size:22px;cursor:pointer;z-index:10;">&times;</button>
    <div style="padding:32px 28px 0 28px;">
      <h2 id="tituloModalCliente" style="color:#22304a; text-align:center; margin-bottom:0; font-size:2rem;">Detalhes do Cliente</h2>
      <div id="abasClienteModal" style="display:flex; gap:8px; margin:24px 0 0 0; justify-content:center;">
        <button class="aba-cliente-modal ativa" onclick="abrirAbaClienteModal('dados')">Dados</button>
        <button class="aba-cliente-modal" onclick="abrirAbaClienteModal('observacoes')">Observações</button>
        <button class="aba-cliente-modal" onclick="abrirAbaClienteModal('anexos')">Anexos</button>
        <button class="aba-cliente-modal" onclick="abrirAbaClienteModal('orcamentos')">Orçamentos</button>
        <button class="aba-cliente-modal" onclick="abrirAbaClienteModal('visitas')">Visitas</button>
      </div>
    </div>
    <div id="conteudoModalCliente" style="padding:24px 28px 28px 28px;"></div>
  </div>
</div>
<style>

.aba-cliente-modal {
  background: #f7f9fb;
  border: none;
  border-radius: 8px 8px 0 0;
  padding: 10px 22px;
  font-size: 16px;
  color: #34495e;
  font-weight: 600;
  cursor: pointer;
  transition: background 0.2s, color 0.2s;
  margin-bottom: -2px;
  border-bottom: 2px solid transparent;
}
.aba-cliente-modal.ativa {
  background: #22304a;
  color: #fff;
  border-bottom: 2px solid #27ae60;
}
@media (max-width:600px) {
  #modalDetalhesCliente > div { padding:0 !important; }
  #conteudoModalCliente { padding:16px 6vw 18px 6vw !important; }
  .aba-cliente-modal { font-size:14px; padding:8px 8px; }
}
</style>
</div>
    <div id="subVendasProspeccao" class="subvendas" style="display:none;">
        <h3 style="color:#f39c12;">Estágio de Prospecção</h3>
        <div id="listaProspeccao"></div>
    </div>

</div>
    <div id="subVendasResumoClientes" class="subvendas" style="display:none;">
        <h3 style="color:#27ae60;">Resumo Total de Clientes</h3>
      <!-- Adicione dentro de #subVendasResumoClientes, substituindo o conteúdo antigo -->
<div style="display:flex; flex-wrap:wrap; gap:18px; justify-content:center; margin-bottom:24px;">
    <div onclick="abrirModalObrasProspec()" style="cursor:pointer; background:#fff; border-radius:10px; box-shadow:0 2px 8px #f39c1222; padding:18px; min-width:140px; text-align:center; transition:box-shadow 0.2s;">
        <strong>Prospecção:</strong><br>
        <span style="font-size:22px; color:#f39c12;" id="prospecCountResumo"></span>
    </div>
    <div onclick="abrirModalTotalClientes()" style="cursor:pointer; background:#fff; border-radius:10px; box-shadow:0 2px 8px #27ae6022; padding:18px; min-width:140px; text-align:center; transition:box-shadow 0.2s;">
        <strong>Total:</strong><br>
        <span style="font-size:22px; color:#961c1c;" id="totalCountResumo"></span>
    </div>
    <div onclick="abrirModalFechados()" style="cursor:pointer; background:#fff; border-radius:10px; box-shadow:0 2px 8px #27ae6022; padding:18px; min-width:140px; text-align:center; transition:box-shadow 0.2s;">
        <strong>Fechado:</strong><br>
        <span style="font-size:22px; color:#27ae60;" id="fechadoCountResumo"></span>
    </div>
</div>
<!-- Modal Prospecção -->
<div id="modalObrasProspec" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.65); z-index:9999; align-items:center; justify-content:center;">
  <div style="background:#fff; border-radius:14px; padding:32px 24px; max-width:700px; width:95vw; max-height:90vh; overflow:auto; position:relative;">
    <button onclick="fecharModalObrasProspec()" style="position:absolute;top:12px;right:18px;background:#f44336;color:#fff;border:none;border-radius:50%;width:32px;height:32px;font-size:22px;cursor:pointer;">&times;</button>
    <h3 style="color:#f39c12; text-align:center; margin-bottom:18px;">Obras em Prospecção</h3>
    <div id="listaObrasProspec"></div>
  </div>
</div>

<!-- Modal Total -->
<div id="modalTotalClientes" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.65); z-index:9999; align-items:center; justify-content:center;">
  <div style="background:#fff; border-radius:14px; padding:32px 24px; max-width:700px; width:95vw; max-height:90vh; overflow:auto; position:relative;">
    <button onclick="fecharModalTotalClientes()" style="position:absolute;top:12px;right:18px;background:#f44336;color:#fff;border:none;border-radius:50%;width:32px;height:32px;font-size:22px;cursor:pointer;">&times;</button>
    <h3 style="color:#961c1c; text-align:center; margin-bottom:18px;">Clientes e Prazo para Fechamento</h3>
    <div id="listaTotalClientes"></div>
  </div>
</div>

<!-- Modal Fechados -->
<div id="modalFechados" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.65); z-index:9999; align-items:center; justify-content:center;">
  <div style="background:#fff; border-radius:14px; padding:32px 24px; max-width:700px; width:95vw; max-height:90vh; overflow:auto; position:relative;">
    <button onclick="fecharModalFechados()" style="position:absolute;top:12px;right:18px;background:#f44336;color:#fff;border:none;border-radius:50%;width:32px;height:32px;font-size:22px;cursor:pointer;">&times;</button>
    <h3 style="color:#27ae60; text-align:center; margin-bottom:18px;">Clientes Fechados</h3>
    <div id="dashFechados"></div>
    <div id="listaFechados"></div>
  </div>
</div>

 <div id="painelVendedores" style="margin-top:40px; background:#f8f9fa; border-radius:12px; box-shadow:0 2px 8px #2980b922; padding:24px;">
    <h2 style="color:#2980b9; margin-bottom:18px;">Gestão de Vendedores</h2>
    <div style="display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end;">
        <input type="text" id="nomeVendedor" placeholder="Nome do Vendedor" style="margin-bottom:0; flex:1;">
        <button onclick="adicionarVendedor()" style="padding:10px 20px; background:#27ae60; color:white; border:none; border-radius:8px; font-size:16px;">Adicionar Vendedor</button>
    </div>
    <div id="listaVendedores" style="margin-top:24px;"></div>
  

<!-- Troque o painel por um modal -->
<div id="modalPainelVendedor" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.65); z-index:9999; align-items:center; justify-content:center;">
  <div style="background:#fff; border-radius:12px; box-shadow:0 2px 8px #2980b922; padding:24px; margin-top:18px; max-width:700px; width:95vw; max-height:90vh; overflow:auto; position:relative;">
    <button onclick="fecharPainelVendedor()" style="position:absolute;top:12px;right:18px;background:#f44336;color:#fff;border:none;border-radius:8px;padding:6px 16px;font-size:15px;">Fechar</button>
    <h3 id="nomePainelVendedor" style="color:#2980b9; margin-bottom:10px;"></h3>
    <div id="resumoPainelVendedor"></div>
    <h4 style="color:#34495e; margin-top:18px;">Obras Vinculadas</h4>
    <div id="obrasPainelVendedor"></div>
  </div>
</div>
<!-- Modal de visitas por obra/cliente -->
<div id="modalVisitasObra" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.65); z-index:9999; align-items:center; justify-content:center;">
  <div style="background:#fff; border-radius:14px; padding:32px 24px; max-width:500px; width:95vw; max-height:90vh; overflow:auto; position:relative;">
    <button onclick="fecharModalVisitas()" style="position:absolute;top:12px;right:18px;background:#f44336;color:#fff;border:none;border-radius:50%;width:32px;height:32px;font-size:22px;cursor:pointer;">&times;</button>
    <h3 style="color:#34495e; text-align:center; margin-bottom:18px;">Visitas à Obra</h3>
    <div id="listaVisitasObra"></div>
    <h4 style="margin-top:18px;">Registrar Nova Visita</h4>
    <input type="date" id="dataVisitaObra" style="margin-bottom:8px;">
    <input type="text" id="motivoVisitaObra" placeholder="Motivo da visita" style="margin-bottom:8px;">
    <button onclick="salvarVisitaObra()" style="padding:8px 18px; background:#27ae60; color:white; border:none; border-radius:8px; font-size:15px;">Salvar Visita</button>
  </div>
</div>

<style>/* ...existing code... */
.input-erro {
  border: 2px solid #e74c3c !important;
  background: #fff0f0 !important;
}
    #modalCadastroCliente > div {
  box-shadow: 0 8px 32px #22304a22;
  border: 2px solid #961c1c22;
}@media (max-width: 600px) {
  .linha-divisoria {
    flex-direction: column !important;
  }
  .linha-divisoria > div[style*="width:1px"] {
    display: none !important;
  }
}
/* Adicione ao seu CSS global */
.linha-divisoria {
  display: flex;
  align-items: flex-end;
  gap: 0;
  margin-bottom: 12px;
}
.linha-divisoria > div {
  flex: 1;
}
.divisor-vertical {
  width: 1px;
  height: 38px;
  background: #e0e0e0;
  margin: 0 12px;
}
@media (max-width: 600px) {
  .linha-divisoria {
    flex-direction: column !important;
  }
  .divisor-vertical {
    display: none !important;
  }
}
</style>
<script>
    
function mostrarSubVendas(sub) {
    document.querySelectorAll('.subvendas').forEach(div => div.style.display = 'none');
    if (sub === 'cadastroCliente') atualizarSelectVendedores();
    if (sub === 'clientesRegistrados') listarClientes();
    if (sub === 'prospeccao') listarProspeccao();
    if (sub === 'resumoClientes') atualizarResumoClientes();
    if (sub === 'vendedores') listarVendedores();
    document.getElementById('subVendas' + capitalize(sub)).style.display = 'block';
}
function capitalize(str) {
    return str.charAt(0).toUpperCase() + str.slice(1);
}
function abrirModalCadastroCliente() {
    document.getElementById('modalCadastroCliente').style.display = 'flex';
    atualizarSelectVendedores();
    atualizarSelectGrupos();
    // Preenche data de cadastro com hoje, se vazio
    const dataInput = document.getElementById('dataCadastroCliente');
    if (!dataInput.value) {
      const hoje = new Date();
      dataInput.value = hoje.toISOString().split('T')[0];
    }
}
function toggleAccordion(id) {
  const el = document.getElementById(id);
  el.style.display = el.style.display === 'none' ? 'block' : 'none';
}
function fecharModalCadastroCliente() {
    document.getElementById('modalCadastroCliente').style.display = 'none';
}
// ...existing code...
// Máscara de telefone (formato brasileiro)
document.getElementById('telefoneCliente').addEventListener('input', function(e) {
  let v = e.target.value.replace(/\D/g, '');
  v = v.replace(/^(\d{2})(\d)/g, '($1) $2');
  v = v.replace(/(\d{5})(\d)/, '$1-$2');
  e.target.value = v.slice(0, 15);
});
// Cadastro de clientes (backend)
// ...existing code...
async function salvarCliente() {
    // Limpa erros anteriores
    ['nomeCliente','telefoneCliente','vendedorResponsavel','grupoObra','enderecoObra'].forEach(id => {
      document.getElementById(id).classList.remove('input-erro');
    });

    const nome = document.getElementById('nomeCliente').value.trim();
    const email = document.getElementById('emailCliente').value.trim();
    const telefone = document.getElementById('telefoneCliente').value.trim();
    const arquiteto = document.getElementById('arquitetoObra').value.trim();
    const contatoArquiteto = document.getElementById('contatoArquiteto').value.trim();
    const responsavelObra = document.getElementById('responsavelObra').value.trim();
    const telefoneresponsavelObra = document.getElementById('telefoneresponsavelObra').value.trim();
    const grupoObra = document.getElementById('grupoObra').value;
    const enderecoObra = document.getElementById('enderecoObra').value.trim();
    const vendedor = document.getElementById('vendedorResponsavel').value;

    let erro = false;
    if (!nome) { document.getElementById('nomeCliente').classList.add('input-erro'); erro = true; }
    if (!telefone) { document.getElementById('telefoneCliente').classList.add('input-erro'); erro = true; }
    if (!vendedor) { document.getElementById('vendedorResponsavel').classList.add('input-erro'); erro = true; }
    if (!grupoObra) { document.getElementById('grupoObra').classList.add('input-erro'); erro = true; }
    if (!enderecoObra) { document.getElementById('enderecoObra').classList.add('input-erro'); erro = true; }
    if (erro) {
      alert('Preencha todos os campos obrigatórios!');
      return;
    }

    // ...restante do código...

    try {
        const res = await fetch('/api/clientes', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
        nome,
        email,
        telefone,
        arquiteto,
        contatoArquiteto,
        responsavelObra,
        telefoneresponsavelObra,
        grupoObra,
        enderecoObra,
        vendedor,
        status: 'Prospecção',
        dataCadastro: document.getElementById('dataCadastroCliente').value
    })
});
        if (!res.ok) throw new Error();
        alert('Cliente cadastrado!');
        document.getElementById('nomeCliente').value = '';
        document.getElementById('emailCliente').value = '';
        document.getElementById('telefoneCliente').value = '';
        document.getElementById('arquitetoObra').value = '';
        document.getElementById('contatoArquiteto').value = '';
        document.getElementById('responsavelObra').value = '';
        document.getElementById('telefoneresponsavelObra').value = '';
        document.getElementById('vendedorResponsavel').value = '';
        atualizarDashVendas();
        carregarClientesOrcamentoDireto();
    } catch {
        alert('Erro ao cadastrar cliente!');
    }
}

async function salvarObsClienteComAnexo(clienteId) {
  const texto = document.getElementById('obsCliente').value.trim();
  const arquivos = document.getElementById('anexoObsCliente').files;
  if (!texto && arquivos.length === 0) {
    alert('Digite a observação ou anexe um arquivo!');
    return;
  }
  const formData = new FormData();
  formData.append('texto', texto);
  for (const file of arquivos) formData.append('anexos', file);
  await fetch(`/api/clientes/${clienteId}/observacoes`, { method: 'POST', body: formData });
  document.getElementById('obsCliente').value = '';
  document.getElementById('anexoObsCliente').value = '';
  // Atualize a lista de observações
}
function abrirMenuCadastroGrupo() {
    const modal = document.getElementById('modalCadastroGrupo');
    if (modal) {
        modal.style.display = 'flex';
        listarGrupos();
    }
}
function fecharMenuCadastroGrupo() {
    const modal = document.getElementById('modalCadastroGrupo');
    if (modal) modal.style.display = 'none';
}
// Substitua listarGrupos e atualizarSelectGrupos por:
async function listarGrupos() {
    const lista = document.getElementById('listaGruposCadastrados');
    try {
        const res = await fetch('/api/grupos');
        const grupos = await res.json();
        if (!grupos.length) {
            lista.innerHTML = '<p style="color:#888;">Nenhum grupo cadastrado.</p>';
            return;
        }
        lista.innerHTML = grupos.map(g => `<div style="padding:6px 0; border-bottom:1px solid #eee;">${g.nome}</div>`).join('');
    } catch {
        lista.innerHTML = '<p style="color:#c00;">Erro ao carregar grupos.</p>';
    }
}
async function atualizarSelectGrupos() {
    const select = document.getElementById('grupoObra');
    try {
        const res = await fetch('/api/grupos');
        const grupos = await res.json();
        select.innerHTML = '<option value="">Selecione o Grupo (Cidade, Bairro ou Condomínio)</option>';
        grupos.forEach(g => {
            const opt = document.createElement('option');
            opt.value = g.nome;
            opt.textContent = g.nome;
            select.appendChild(opt);
        });
    } catch {
        select.innerHTML = '<option value="">Erro ao carregar grupos</option>';
    }
}
async function salvarGrupo() {
    const nome = document.getElementById('novoGrupoNome').value.trim();
    if (!nome) {
        alert('Digite o nome do grupo!');
        return;
    }
    try {
        const res = await fetch('/api/grupos', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ nome })
        });
        if (!res.ok) throw new Error();
        document.getElementById('novoGrupoNome').value = '';
        listarGrupos();
        atualizarSelectGrupos();
    } catch {
        alert('Erro ao cadastrar grupo!');
    }
}
async function listarGrupos() {
    const lista = document.getElementById('listaGruposCadastrados');
    try {
        const res = await fetch('/api/grupos');
        const grupos = await res.json();
        if (!grupos.length) {
            lista.innerHTML = '<p style="color:#888;">Nenhum grupo cadastrado.</p>';
            return;
        }
        lista.innerHTML = grupos.map(g => `
            <div style="padding:6px 0; border-bottom:1px solid #eee; display:flex; align-items:center; justify-content:space-between;">
                <span>${g.nome}</span>
                <button onclick="excluirGrupo('${g.id}')" style="background:#f44336; color:#fff; border:none; border-radius:6px; padding:4px 10px; margin-left:10px; font-size:13px; cursor:pointer;">Excluir</button>
            </div>
        `).join('');
    } catch {
        lista.innerHTML = '<p style="color:#c00;">Erro ao carregar grupos.</p>';
    }
}
async function excluirGrupo(id) {
    if (!confirm('Deseja realmente excluir este grupo?')) return;
    try {
        const res = await fetch(`/api/grupos/${id}`, { method: 'DELETE' });
        if (!res.ok) throw new Error();
        listarGrupos();
        atualizarSelectGrupos();
        alert('Grupo excluído!');
    } catch {
        alert('Erro ao excluir grupo!');
    }
}
// Listar clientes registrados (backend) com ícone de exclusão e clique para abrir painel
async function listarClientes() {
    const filtro = document.getElementById('filtroCliente')?.value?.toLowerCase() || '';
    const lista = document.getElementById('listaClientes');
    lista.innerHTML = '';
    try {
        const res = await fetch('/api/clientes');
        const clientes = await res.json();
        const filtrados = clientes.filter(c => c.nome.toLowerCase().includes(filtro));
        if (filtrados.length === 0) {
            lista.innerHTML = '<p style="color:#888;">Nenhum cliente encontrado.</p>';
            return;
        }
        filtrados.forEach((c) => {
    lista.innerHTML += `
        <div style="border:1px solid #ccc; border-radius:8px; padding:10px; margin-bottom:8px; background:#f9f9f9; position:relative; cursor:pointer;" onclick="abrirModalDetalhesCliente('${c.id}')">
            <strong>${c.nome}</strong> <br>
            <span style="color:#34495e;">${c.email} | ${c.telefone}</span><br>
            <span style="color:#2980b9;">Vendedor: ${c.vendedor}</span><br>
            <span style="color:#f39c12;">Status: ${c.status}</span>
            <button onclick="event.stopPropagation(); excluirCliente('${c.id}', this);" title="Excluir cliente" style="position:absolute;top:10px;right:10px;background:#f44336;color:#fff;border:none;border-radius:50%;width:28px;height:28px;cursor:pointer;display:flex;align-items:center;justify-content:center;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="3 6 5 6 21 6"/>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"/>
                    <line x1="10" y1="11" x2="10" y2="17"/>
                    <line x1="14" y1="11" x2="14" y2="17"/>
                </svg>
            </button>
        </div>
    `;
});
    } catch {
        lista.innerHTML = '<p style="color:#c00;">Erro ao carregar clientes.</p>';
    }
}

async function excluirCliente(id, btn) {
    if (!confirm("Deseja realmente excluir este cliente?")) return;
    btn.disabled = true;
    try {
        const res = await fetch(`/api/clientes/${id}`, { method: 'DELETE' });
        if (!res.ok) throw new Error();
        listarClientes(); // Atualiza a lista após exclusão
        atualizarDashVendas();
    } catch {
        alert('Erro ao excluir cliente!');
        btn.disabled = false;
    }
}
let clienteModalAtual = null;

async function abrirModalDetalhesCliente(id) {
    const modal = document.getElementById('modalDetalhesCliente');
    modal.style.display = 'flex';
    document.getElementById('conteudoModalCliente').innerHTML = '<div style="color:#888; text-align:center;">Carregando...</div>';
    try {
        const res = await fetch(`/api/clientes/${id}`);
        const cliente = await res.json();
        if (!cliente || cliente.error) {
            document.getElementById('conteudoModalCliente').innerHTML = '<p style="color:#c00;">Cliente não encontrado.</p>';
            return;
        }
        clienteModalAtual = cliente;
        document.getElementById('resumoClienteModal').innerHTML = `
            <b>Status:</b> <span style="color:${cliente.status==='Fechado'?'#27ae60':cliente.status==='Prospecção'?'#f39c12':'#34495e'}">${cliente.status || '-'}</span> |
            <b>Vendedor:</b> ${cliente.vendedor || '-'} |
            <b>Grupo:</b> ${cliente.grupoObra || '-'}
        `;
        abrirAbaClienteModal('dados');
    } catch {
        document.getElementById('conteudoModalCliente').innerHTML = '<p style="color:#c00;">Erro ao carregar dados do cliente.</p>';
    }
}

function fecharModalDetalhesCliente() {
    document.getElementById('modalDetalhesCliente').style.display = 'none';
    clienteModalAtual = null;
}
function abrirAbaClienteModal(aba) {
    document.querySelectorAll('.aba-cliente-modal').forEach(btn => btn.classList.remove('ativa'));
    const idx = ['dados','observacoes','anexos','orcamentos','visitas','historico'].indexOf(aba);
    if (idx >= 0) document.querySelectorAll('.aba-cliente-modal')[idx].classList.add('ativa');
    if (!clienteModalAtual) return;
    if (aba === 'dados') {
        document.getElementById('conteudoModalCliente').innerHTML = `
            <div style="display:flex; flex-wrap:wrap; gap:18px; margin-bottom:18px;">
                <div style="flex:1; min-width:180px;">
                    <strong>Nome:</strong> ${clienteModalAtual.nome}<br>
                    <strong>E-mail:</strong> <span style="cursor:pointer;color:#2980b9;" onclick="copiarTexto('${clienteModalAtual.email}')">${clienteModalAtual.email || '-'}</span><br>
                    <strong>Telefone:</strong> <span style="cursor:pointer;color:#2980b9;" onclick="copiarTexto('${clienteModalAtual.telefone}')">${clienteModalAtual.telefone || '-'}</span><br>
                    <strong>Vendedor:</strong> ${clienteModalAtual.vendedor || '-'}<br>
                    <strong>Status:</strong> <span style="color:${clienteModalAtual.status==='Fechado'?'#27ae60':clienteModalAtual.status==='Prospecção'?'#f39c12':'#34495e'}; font-weight:bold;">${clienteModalAtual.status || '-'}</span><br>
                    <strong>Grupo:</strong> ${clienteModalAtual.grupoObra || '-'}<br>
                    <strong>Endereço:</strong> ${clienteModalAtual.enderecoObra || '-'}
                </div>
                <div style="flex:1; min-width:180px;">
                    <strong>Arquiteto:</strong> ${clienteModalAtual.arquiteto || '-'}<br>
                    <strong>Contato Arquiteto:</strong> ${clienteModalAtual.contatoArquiteto || '-'}<br>
                    <strong>Responsável Obra:</strong> ${clienteModalAtual.responsavelObra || '-'}<br>
                    <strong>Telefone Resp. Obra:</strong> ${clienteModalAtual.telefoneresponsavelObra || '-'}<br>
                    <strong>Data Cadastro:</strong> ${clienteModalAtual.dataCadastro ? new Date(clienteModalAtual.dataCadastro).toLocaleDateString('pt-BR') : '-'}
                </div>
            </div>
        `;
    }
    if (aba === 'observacoes') {
        document.getElementById('conteudoModalCliente').innerHTML = `
            <h4 style="color:#34495e;">Observações</h4>
            <div id="observacoesModalCliente" style="margin-bottom:8px;"></div>
            <textarea id="novaObsModalCliente" placeholder="Adicionar observação..." style="width:100%; border-radius:8px; border:1px solid #ccc; font-size:15px; margin-bottom:8px;"></textarea>
            <button onclick="salvarObsModalCliente('${clienteModalAtual.id}')" style="padding:8px 18px; background:#27ae60; color:white; border:none; border-radius:8px; font-size:15px;">Salvar Observação</button>
        `;
        carregarObservacoesModalCliente(clienteModalAtual.id);
    }
    if (aba === 'anexos') {
        document.getElementById('conteudoModalCliente').innerHTML = `
            <h4 style="color:#34495e;">Anexos</h4>
            <input type="file" id="anexoModalClienteInput" multiple style="margin-bottom:10px;">
            <button onclick="salvarAnexoModalCliente('${clienteModalAtual.id}')" style="padding:8px 18px; background:#22304a; color:white; border:none; border-radius:8px; font-size:15px;">Adicionar Anexo</button>
            <div id="anexosModalCliente" style="margin-top:10px;"></div>
        `;
        carregarAnexosModalCliente(clienteModalAtual.id);
    }
    if (aba === 'orcamentos') {
        document.getElementById('conteudoModalCliente').innerHTML = `<div id="historicoOrcamentosCliente" style="min-height:80px;">Carregando...</div>`;
        carregarHistoricoOrcamentosCliente(clienteModalAtual.id);
    }
    if (aba === 'visitas') {
        document.getElementById('conteudoModalCliente').innerHTML = `
            <div id="historicoVisitasCliente" style="min-height:80px;">Carregando...</div>
            <h4 style="margin-top:18px;">Registrar Nova Visita</h4>
            <input type="date" id="dataVisitaObraModal" style="margin-bottom:8px;">
            <input type="text" id="motivoVisitaObraModal" placeholder="Motivo da visita" style="margin-bottom:8px;">
            <button onclick="salvarVisitaObraModal()" style="padding:8px 18px; background:#27ae60; color:white; border:none; border-radius:8px; font-size:15px;">Salvar Visita</button>
        `;
        carregarVisitasClienteModal(clienteModalAtual.id);
    }
    if (aba === 'historico') {
        document.getElementById('conteudoModalCliente').innerHTML = `
            <h4 style="color:#34495e;">Histórico Completo</h4>
            <div id="historicoCompletoCliente" style="margin-bottom:8px;">Carregando...</div>
        `;
        carregarHistoricoCompletoCliente(clienteModalAtual.id);
    }
}

// Copiar info rápida
function copiarTexto(texto) {
    if (!texto) return;
    navigator.clipboard.writeText(texto);
    alert('Copiado: ' + texto);
}
function copiarInfoClienteModal() {
    if (!clienteModalAtual) return;
    const info = `
Nome: ${clienteModalAtual.nome}
E-mail: ${clienteModalAtual.email}
Telefone: ${clienteModalAtual.telefone}
Vendedor: ${clienteModalAtual.vendedor}
Status: ${clienteModalAtual.status}
Grupo: ${clienteModalAtual.grupoObra}
Endereço: ${clienteModalAtual.enderecoObra}
Arquiteto: ${clienteModalAtual.arquiteto}
Contato Arquiteto: ${clienteModalAtual.contatoArquiteto}
Responsável Obra: ${clienteModalAtual.responsavelObra}
Telefone Resp. Obra: ${clienteModalAtual.telefoneresponsavelObra}
Data Cadastro: ${clienteModalAtual.dataCadastro ? new Date(clienteModalAtual.dataCadastro).toLocaleDateString('pt-BR') : '-'}
    `;
    navigator.clipboard.writeText(info);
    alert('Dados do cliente copiados!');
}

// Exportar PDF simples (pode ser incrementado com jsPDF)
function exportarClientePDF() {
    if (!clienteModalAtual) return;
    const win = window.open('', '', 'width=800,height=600');
    win.document.write('<h2>Detalhes do Cliente</h2>');
    win.document.write('<pre>' + JSON.stringify(clienteModalAtual, null, 2) + '</pre>');
    win.print();
    win.close();
}

// Histórico completo (observações, anexos, orçamentos, visitas)
async function carregarHistoricoOrcamentosCliente(clienteId) {
    const div = document.getElementById('historicoOrcamentosCliente');
    try {
        const res = await fetch(`/api/clientes/${clienteId}`);
        const cliente = await res.json();
        if (!cliente || !cliente.orcamentosFechados || !cliente.orcamentosFechados.length) {
    div.innerHTML = '<p style="color:#888;">Nenhum orçamento fechado para este cliente.</p>';
    return;
}
        div.innerHTML = cliente.orcamentosFechados.map(o => `
            <div style="border:1px solid #ccc; border-radius:8px; padding:10px; margin-bottom:8px; background:#f9f9f9;">
                <strong>Data:</strong> ${o.data || '-'}<br>
                <strong>Tipologias:</strong> ${o.tipologias || '-'}<br>
                <strong>Vendido:</strong> ${o.vendido || '-'}
            </div>
        `).join('');
        // Gráfico de valores dos orçamentos
        setTimeout(() => {
            const ctx = document.getElementById('graficoOrcamentosCliente')?.getContext('2d');
            if (ctx) {
                const labels = cliente.orcamentosFechados.map((o, i) => o.data || `#${i+1}`);
                const valores = cliente.orcamentosFechados.map(o => Number(o.valor || 0));
                if (window.graficoOrcamentosClienteObj) window.graficoOrcamentosClienteObj.destroy();
                window.graficoOrcamentosClienteObj = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels,
                        datasets: [{
                            label: 'Valor (R$)',
                            data: valores,
                            backgroundColor: '#27ae60'
                        }]
                    },
                    options: { responsive: false, plugins: { legend: { display: false } } }
                });
            }
        }, 200);
    } catch {
        div.innerHTML = '<p style="color:#c00;">Erro ao carregar orçamentos.</p>';
    }
}
// Observações
async function carregarObservacoesModalCliente(clienteId) {
    const div = document.getElementById('observacoesModalCliente');
    try {
        const res = await fetch(`/api/clientes/${clienteId}/observacoes`);
        const lista = await res.json();
        if (!Array.isArray(lista) || lista.length === 0) {
            div.innerHTML = '<p style="color:#888;">Nenhuma observação adicionada.</p>';
            return;
        }
        div.innerHTML = lista.map(o => `
            <div style="border:1px solid #ccc; border-radius:6px; padding:6px; margin-bottom:4px; background:#f7f9fb;">
                <span contenteditable="true" onblur="editarObsModalCliente('${clienteId}','${o.id}',this.innerText)" style="color:#34495e; outline:none;">${o.texto}</span>
                <span style="float:right; color:#aaa; font-size:12px;">${o.data || ''}</span>
            </div>
        `).join('');
    } catch {
        div.innerHTML = '<p style="color:#c00;">Erro ao carregar observações.</p>';
    }
}
async function editarObsModalCliente(clienteId, obsId, novoTexto) {
    try {
        await fetch(`/api/clientes/${clienteId}/observacoes/${obsId}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ texto: novoTexto })
        });
    } catch {
        alert('Erro ao editar observação!');
    }
}
async function salvarObsModalCliente(clienteId) {
    const textarea = document.getElementById('novaObsModalCliente');
    const texto = textarea.value.trim();
    if (!texto) {
        alert('Digite a observação!');
        return;
    }
    try {
        await fetch(`/api/clientes/${clienteId}/observacoes`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ texto })
        });
        textarea.value = '';
        carregarObservacoesModalCliente(clienteId);
    } catch {
        alert('Erro ao salvar observação!');
    }
}

// Anexos
async function carregarAnexosModalCliente(clienteId) {
    const div = document.getElementById('anexosModalCliente');
    try {
        const res = await fetch(`/api/clientes/${clienteId}/anexos`);
        const lista = await res.json();
        if (!Array.isArray(lista) || lista.length === 0) {
            div.innerHTML = '<p style="color:#888;">Nenhum anexo adicionado.</p>';
            return;
        }
        div.innerHTML = lista.map(a => `
            <div style="border:1px solid #ccc; border-radius:6px; padding:6px; margin-bottom:4px; background:#f7f9fb;">
                <span style="color:#34495e;">${a.nome}</span>
                <a href="${a.url}" target="_blank" style="color:#2980b9; text-decoration:underline;">Abrir</a>
            </div>
        `).join('');
    } catch {
        div.innerHTML = '<p style="color:#c00;">Erro ao carregar anexos.</p>';
    }
}
async function salvarAnexoModalCliente(clienteId) {
    const input = document.getElementById('anexoModalClienteInput');
    if (!input.files.length) {
        alert('Selecione um arquivo!');
        return;
    }
    const formData = new FormData();
    for (const file of input.files) {
        formData.append('anexos', file);
    }
    try {
        await fetch(`/api/clientes/${clienteId}/anexos`, {
            method: 'POST',
            body: formData
        });
        input.value = '';
        carregarAnexosModalCliente(clienteId);
    } catch {
        alert('Erro ao salvar anexo!');
    }
}

async function carregarHistoricoCompletoCliente(clienteId) {
    const div = document.getElementById('historicoCompletoCliente');
    try {
        const res = await fetch(`/api/clientes/${clienteId}`);
        const cliente = await res.json();
        let eventos = [];
        // Junta todos os eventos em um array único
        if (Array.isArray(cliente.observacoes)) {
            eventos = eventos.concat(cliente.observacoes.map(o => ({
                tipo: 'Observação',
                data: o.data,
                texto: o.texto
            })));
        }
        if (Array.isArray(cliente.anexos)) {
            eventos = eventos.concat(cliente.anexos.map(a => ({
                tipo: 'Anexo',
                data: a.data,
                texto: a.nome,
                url: a.url
            })));
        }
        if (Array.isArray(cliente.visitas)) {
            eventos = eventos.concat(cliente.visitas.map(v => ({
                tipo: 'Visita',
                data: v.data,
                texto: v.motivo
            })));
        }
        // Ordena por data decrescente
        eventos.sort((a, b) => new Date(b.data) - new Date(a.data));
        // Timeline visual
        div.innerHTML = `
            <div style="border-left:4px solid #22304a; margin-left:18px; padding-left:18px;">
                ${eventos.map(ev => `
                    <div style="margin-bottom:18px; position:relative;">
                        <div style="position:absolute; left:-28px; top:0; width:18px; height:18px; background:${ev.tipo==='Observação'?'#27ae60':ev.tipo==='Anexo'?'#22304a':'#f39c12'}; border-radius:50%;"></div>
                        <div style="font-size:13px; color:#888;">${ev.data ? new Date(ev.data).toLocaleDateString('pt-BR') : '-'}</div>
                        <div style="font-weight:bold; color:#34495e;">${ev.tipo}</div>
                        <div style="color:#22304a;">${ev.texto || ''} ${ev.url ? `<a href="${ev.url}" target="_blank" style="color:#2980b9;">Abrir</a>` : ''}</div>
                    </div>
                `).join('')}
            </div>
        `;
    } catch {
        div.innerHTML = '<p style="color:#c00;">Erro ao carregar histórico.</p>';
    }
}

// Visitas
async function carregarVisitasClienteModal(clienteId) {
    const div = document.getElementById('historicoVisitasCliente');
    try {
        const res = await fetch(`/api/clientes/${clienteId}`);
        const cliente = await res.json();
        const visitas = Array.isArray(cliente.visitas) ? cliente.visitas : [];
        if (!visitas.length) {
            div.innerHTML = '<p style="color:#888;">Nenhuma visita registrada.</p>';
            return;
        }
        div.innerHTML = visitas.map(v => `
            <div style="border:1px solid #ccc; border-radius:6px; padding:8px; margin-bottom:6px; background:#fff;">
                <span style="color:#34495e;">Data: ${v.data || '-'}</span><br>
                <span style="color:#2980b9;">Motivo: ${v.motivo || '-'}</span>
            </div>
        `).join('');
    } catch {
        div.innerHTML = '<p style="color:#c00;">Erro ao carregar visitas.</p>';
    }
}
async function salvarVisitaObraModal() {
    const data = document.getElementById('dataVisitaObraModal').value;
    const motivo = document.getElementById('motivoVisitaObraModal').value.trim();
    if (!data || !motivo) {
        alert('Preencha data e motivo!');
        return;
    }
    try {
        await fetch(`/api/clientes/${clienteModalAtual.id}/visitas`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ data, motivo })
        });
        document.getElementById('dataVisitaObraModal').value = '';
        document.getElementById('motivoVisitaObraModal').value = '';
        carregarVisitasClienteModal(clienteModalAtual.id);
    } catch {
        alert('Erro ao salvar visita!');
    }
}
// ...existing code...
async function salvarObsModalCliente(clienteId) {
    const textarea = document.getElementById('novaObsModalCliente');
    const texto = textarea.value.trim();
    if (!texto) {
        alert('Digite a observação!');
        return;
    }
    try {
        await fetch(`/api/clientes/${clienteId}/observacoes`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ texto })
        });
        textarea.value = '';
        carregarObservacoesModalCliente(clienteId);
        textarea.style.background = '#eafbe6';
        setTimeout(() => textarea.style.background = '', 600);
    } catch {
        alert('Erro ao salvar observação!');
    }
}

async function salvarAnexoModalCliente(clienteId) {
    const input = document.getElementById('anexoModalClienteInput');
    if (!input.files.length) {
        alert('Selecione um arquivo!');
        return;
    }
    const formData = new FormData();
    for (const file of input.files) {
        formData.append('anexos', file);
    }
    try {
        await fetch(`/api/clientes/${clienteId}/anexos`, {
            method: 'POST',
            body: formData
        });
        input.value = '';
        carregarAnexosModalCliente(clienteId);
        input.style.background = '#eafbe6';
        setTimeout(() => input.style.background = '', 600);
    } catch {
        alert('Erro ao salvar anexo!');
    }
}
// Listar clientes em prospecção (backend)
async function listarProspeccao() {
    const lista = document.getElementById('listaProspeccao');
    lista.innerHTML = '';
    try {
        const res = await fetch('/api/clientes?prospeccao=1');
        const clientes = await res.json();
        if (!clientes.length) {
            lista.innerHTML = '<p style="color:#888;">Nenhum cliente em prospecção.</p>';
            return;
        }
        clientes.forEach(c => {
            lista.innerHTML += `
                <div style="border:1px solid #f39c12; border-radius:8px; padding:10px; margin-bottom:8px; background:#fffbe6;">
                    <strong>${c.nome}</strong> <br>
                    <span style="color:#34495e;">${c.email} | ${c.telefone}</span><br>
                    <span style="color:#2980b9;">Vendedor: ${c.vendedor}</span><br>
                    <span style="color:#f39c12;">Status: ${c.status}</span>
                </div>
            `;
        });
    } catch {
        lista.innerHTML = '<p style="color:#c00;">Erro ao carregar prospecção.</p>';
    }
}
// Adicione este método ao seu script, após listarProspeccao()

function renderizarEstagiosProspec() {
    const estagios = [
        {
            nome: "Pesquisa",
            descricao: "Coletar informações sobre potenciais clientes para entender suas necessidades e desafios."
        },
        {
            nome: "Seleção",
            descricao: "Filtrar e priorizar os leads que têm maior potencial de conversão."
        },
        {
            nome: "Contato",
            descricao: "Estabelecer a primeira comunicação, seja por e-mail, telefone ou redes sociais."
        },
        {
            nome: "Educação",
            descricao: "Apresentar soluções e conteúdos relevantes para engajar o prospect."
        },
        {
            nome: "Follow-up",
            descricao: "Acompanhar o interesse do cliente e manter a comunicação ativa."
        },
        {
            nome: "Fechamento",
            descricao: "Concluir a negociação e transformar o prospect em cliente."
        }
    ];

    const container = document.getElementById('listaProspeccao');
    container.innerHTML = `
        <h4 style="color:#34495e; margin-bottom:12px;">Estágios do Processo de Prospecção</h4>
        <div style="display:flex; flex-wrap:wrap; gap:18px;">
            ${estagios.map(e => `
                <div style="background:#fffbe6; border:1px solid #f39c12; border-radius:10px; padding:16px; min-width:220px; flex:1;">
                    <strong style="color:#f39c12; font-size:17px;">${e.nome}</strong>
                    <p style="color:#34495e; font-size:15px; margin-top:6px;">${e.descricao}</p>
                </div>
            `).join('')}
        </div>
    `;
}


// Resumo total de clientes (backend)
async function atualizarResumoClientes() {
    const clientes = await fetch('/api/clientes').then(r => r.json()).catch(() => []);
    const total = clientes.length;
    const fechados = clientes.filter(c => c.status === 'Fechado').length;
    const negociacao = clientes.filter(c => c.status === 'Negociação').length;
    const contato = clientes.filter(c => c.status === 'Contato').length;
    const prospec = clientes.filter(c => c.status === 'Prospecção').length;
    document.getElementById('resumoClientes').innerHTML = `
        <div style="display:flex; flex-wrap:wrap; gap:18px; justify-content:center;">
            <div style="background:#fff; border-radius:10px; box-shadow:0 2px 8px #27ae6022; padding:18px; min-width:140px; text-align:center;">
                <strong>Total:</strong><br><span style="font-size:22px; color:#961c1c;">${total}</span>
            </div>
            <div style="background:#fff; border-radius:10px; box-shadow:0 2px 8px #f39c1222; padding:18px; min-width:140px; text-align:center;">
                <strong>Prospecção:</strong><br><span style="font-size:22px; color:#f39c12;">${prospec}</span>
            </div>
            <div style="background:#fff; border-radius:10px; box-shadow:0 2px 8px #2980b922; padding:18px; min-width:140px; text-align:center;">
                <strong>Contato:</strong><br><span style="font-size:22px; color:#2980b9;">${contato}</span>
            </div>
            <div style="background:#fff; border-radius:10px; box-shadow:0 2px 8px #34495e22; padding:18px; min-width:140px; text-align:center;">
                <strong>Negociação:</strong><br><span style="font-size:22px; color:#34495e;">${negociacao}</span>
            </div>
            <div style="background:#fff; border-radius:10px; box-shadow:0 2px 8px #27ae6022; padding:18px; min-width:140px; text-align:center;">
                <strong>Fechado:</strong><br><span style="font-size:22px; color:#27ae60;">${fechados}</span>
            </div>
        </div>
    `;
}
async function abrirModalEstagiosProspecPorId(id) {
    try {
        const res = await fetch(`/api/clientes/${id}`);
        const cliente = await res.json();
        if (!cliente || cliente.error) {
            alert('Cliente não encontrado!');
            return;
        }
        abrirModalEstagiosProspec(cliente);
    } catch {
        alert('Erro ao buscar dados do cliente!');
    }
}

// Função para abrir o modal de estágios para um cliente
function abrirModalEstagiosProspec(cliente) {
    const estagios = [
        { nome: "Pesquisa", descricao: "Coletar informações sobre potenciais clientes para entender suas necessidades e desafios." },
        { nome: "Seleção", descricao: "Filtrar e priorizar os leads que têm maior potencial de conversão." },
        { nome: "Contato", descricao: "Estabelecer a primeira comunicação, seja por e-mail, telefone ou redes sociais.", valor: true },
        { nome: "Educação", descricao: "Apresentar soluções e conteúdos relevantes para engajar o prospect." },
        { nome: "Follow-up", descricao: "Acompanhar o interesse do cliente e manter a comunicação ativa." },
        { nome: "Fechamento", descricao: "Concluir a negociação e transformar o prospect em cliente.", valor: true }
    ];

    // Garante que o progresso tenha o mesmo tamanho e estrutura dos estágios
    let progresso = Array.from({length: estagios.length}).map((_, idx) => {
        const base = (cliente.progressoEstagios && cliente.progressoEstagios[idx]) || {};
        return {
            nome: estagios[idx].nome,
            info: base.info || "",
            data: base.data || "",
            valor: base.valor || "",
            concluido: base.concluido || false
        };
    });

    // ...restante da função...

    // Estágio atual
    const estagioAtual = cliente.status || "Pesquisa";

    // Monta o formulário
    const form = document.getElementById('formEstagiosProspec');
    form.innerHTML = estagios.map((e, idx) => `
        <div style="margin-bottom:18px; border:1px solid #f39c12; border-radius:8px; padding:12px; background:#fffbe6;">
            <label style="font-weight:bold; color:#f39c12; font-size:17px;">${e.nome}</label>
            <p style="color:#34495e; font-size:15px; margin-top:4px;">${e.descricao}</p>
            <textarea name="info${idx}" placeholder="Informações deste estágio..." style="width:100%; border-radius:8px; border:1px solid #ccc; font-size:15px; margin-bottom:8px;">${progresso[idx].info || ""}</textarea>
            <label>Data deste estágio:</label>
            <input type="date" name="data${idx}" value="${progresso[idx].data || ""}" style="margin-bottom:8px;">
            ${e.valor ? `
                <label>Valor negociado (R$):</label>
                <input type="number" name="valor${idx}" value="${progresso[idx].valor || ""}" min="0" step="0.01" style="margin-bottom:8px;">
            ` : ""}
            <div>
                <input type="radio" name="estagioAtual" value="${e.nome}" id="estagio${idx}" ${estagioAtual === e.nome ? "checked" : ""}>
                <label for="estagio${idx}" style="color:#22304a;">Marcar como estágio atual</label>
            </div>
        </div>
    `).join('') + `
        <button type="submit" style="padding:10px 20px; background:#27ae60; color:white; border:none; border-radius:8px; font-size:16px;">Salvar Progresso</button>
    `;

    // Evento de submit
  form.onsubmit = async function(e) {
    e.preventDefault();
    const novoProgresso = estagios.map((etapa, idx) => ({
        nome: etapa.nome,
        info: form["info"+idx].value,
        data: form["data"+idx].value,
        valor: etapa.valor ? form["valor"+idx].value : "",
        concluido: false
    }));
    let novoStatus = form["estagioAtual"].value;
    // Se o estágio selecionado for "Fechamento", define status como "Fechado"
    if (novoStatus === "Fechamento") {
        novoStatus = "Fechado";
    }
    try {
        await fetch(`/api/clientes/${cliente.id}/progresso-estagios`, {
            method: "PATCH",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ progressoEstagios: novoProgresso, status: novoStatus })
        });
        alert("Progresso salvo!");
        fecharModalEstagiosProspec();
        listarProspeccao();
        atualizarResumoClientes(); // <-- Atualiza o resumo imediatamente
    } catch {
        alert("Erro ao salvar progresso!");
    }
};
    document.getElementById('modalEstagiosProspec').style.display = 'flex';
}

function fecharModalEstagiosProspec() {
    document.getElementById('modalEstagiosProspec').style.display = 'none';
}

// Altere a função listarProspeccao para adicionar o botão de abrir modal em cada cliente:
// ...existing code...
async function listarProspeccao() {
    const lista = document.getElementById('listaProspeccao');
    lista.innerHTML = '';
    try {
        const res = await fetch('/api/clientes?prospeccao=1');
        const clientes = await res.json();
        if (!clientes.length) {
            lista.innerHTML = '<p style="color:#888;">Nenhum cliente em prospecção.</p>';
            return;
        }
        clientes.forEach(c => {
            lista.innerHTML += `
                <div style="border:1px solid #f39c12; border-radius:8px; padding:10px; margin-bottom:8px; background:#fffbe6;">
                    <strong>${c.nome}</strong> <br>
                    <span style="color:#34495e;">${c.email} | ${c.telefone}</span><br>
                    <span style="color:#2980b9;">Vendedor: ${c.vendedor}</span><br>
                    <span style="color:#f39c12;">Status: <b>${c.status || 'Prospecção'}</b></span><br>
                    <button onclick='abrirModalEstagiosProspec(${JSON.stringify(c)})' style="margin-top:8px; padding:8px 16px; background:#22304a; color:#fff; border:none; border-radius:8px; font-size:15px;">Ver/Editar Estágios</button>
                </div>
            `;
        });
    } catch {
        lista.innerHTML = '<p style="color:#c00;">Erro ao carregar prospecção.</p>';
    }
}



</script>

<script>

// Atualize o resumo ao abrir o submenu
async function atualizarResumoClientes() {
    const clientes = await fetch('/api/clientes').then(r => r.json()).catch(() => []);
    const total = clientes.length;
    const fechados = clientes.filter(c => c.status === 'Fechado').length;
    const prospec = clientes.filter(c => c.status === 'Prospecção').length;
    document.getElementById('totalCountResumo').innerText = total;
    document.getElementById('fechadoCountResumo').innerText = fechados;
    document.getElementById('prospecCountResumo').innerText = prospec;
}

// PROSPECÇÃO: Modal com obras em prospecção e fases
async function abrirModalObrasProspec() {
    document.getElementById('modalObrasProspec').style.display = 'flex';
    const lista = document.getElementById('listaObrasProspec');
    lista.innerHTML = '<p style="color:#888;">Carregando...</p>';
    try {
        const res = await fetch('/api/clientes?prospeccao=1');
        const clientes = await res.json();
        if (!clientes.length) {
            lista.innerHTML = '<p style="color:#888;">Nenhuma obra em prospecção.</p>';
            return;
        }
        lista.innerHTML = clientes.map(c => `
            <div style="border:1px solid #f39c12; border-radius:8px; padding:14px; margin-bottom:12px; background:#fffbe6;">
                <strong>${c.nome}</strong> <br>
                <span style="color:#34495e;">${c.email} | ${c.telefone}</span><br>
                <span style="color:#2980b9;">Vendedor: ${c.vendedor}</span><br>
                <span style="color:#f39c12;">Estágio atual: <b>${c.status || 'Prospecção'}</b></span>
                <div style="margin-top:10px;">
                    ${Array.isArray(c.progressoEstagios) ? c.progressoEstagios.map((e, idx) => `
                        <span style="display:inline-block; margin:2px; padding:4px 10px; border-radius:6px; background:${e.nome===c.status?'#27ae60':'#eee'}; color:${e.nome===c.status?'#fff':'#34495e'}; font-size:13px;">
                            ${e.nome}
                        </span>
                    `).join('') : ''}
                </div>
            </div>
        `).join('');
    } catch {
        lista.innerHTML = '<p style="color:#c00;">Erro ao carregar obras.</p>';
    }
}
function fecharModalObrasProspec() {
    document.getElementById('modalObrasProspec').style.display = 'none';
}

// TOTAL: Modal com clientes e prazo de 40 dias
async function abrirModalTotalClientes() {
    document.getElementById('modalTotalClientes').style.display = 'flex';
    const lista = document.getElementById('listaTotalClientes');
    lista.innerHTML = '<p style="color:#888;">Carregando...</p>';
    try {
        const res = await fetch('/api/clientes');
        const clientes = await res.json();
        if (!clientes.length) {
            lista.innerHTML = '<p style="color:#888;">Nenhum cliente cadastrado.</p>';
            return;
        }
        lista.innerHTML = clientes.map(c => {
            let prazoRestante = '';
            let corPrazo = '#27ae60';
            if (Array.isArray(c.progressoEstagios)) {
                const datas = c.progressoEstagios.map(e => e.data).filter(Boolean).sort();
                if (datas.length) {
                    const primeira = new Date(datas[0]);
                    const prazo = new Date(primeira);
                    prazo.setDate(prazo.getDate() + 40);
                    const hoje = new Date();
                    const dias = Math.ceil((prazo - hoje) / (1000 * 60 * 60 * 24));
                    prazoRestante = dias >= 0 ? `${dias} dias restantes` : `<span style="color:#c00;">Prazo excedido!</span>`;
                    if (dias <= 10 && dias >= 0) corPrazo = '#f39c12';
                    if (dias < 0) corPrazo = '#c00';
                }
            }
            return `
                <div style="border:1px solid #961c1c; border-radius:8px; padding:14px; margin-bottom:12px; background:#fff;">
                    <strong>${c.nome}</strong> <br>
                    <span style="color:#34495e;">${c.email} | ${c.telefone}</span><br>
                    <span style="color:#2980b9;">Vendedor: ${c.vendedor}</span><br>
                    <span style="color:${corPrazo};">Prazo: ${prazoRestante || '-'}</span>
                </div>
            `;
        }).join('');
    } catch {
        lista.innerHTML = '<p style="color:#c00;">Erro ao carregar clientes.</p>';
    }
}
function fecharModalTotalClientes() {
    document.getElementById('modalTotalClientes').style.display = 'none';
}

// FECHADOS: Modal com ganhos/perdas e dashboard
async function abrirModalFechados() {
    document.getElementById('modalFechados').style.display = 'flex';
    const lista = document.getElementById('listaFechados');
    const dash = document.getElementById('dashFechados');
    lista.innerHTML = '<p style="color:#888;">Carregando...</p>';
    dash.innerHTML = '';
    try {
        const res = await fetch('/api/clientes');
        const clientes = await res.json();
        const fechados = clientes.filter(c => c.status === 'Fechado');
        if (!fechados.length) {
            lista.innerHTML = '<p style="color:#888;">Nenhum cliente fechado.</p>';
            return;
        }
        let ganhos = 0, perdas = 0;
        fechados.forEach(c => {
            if (Array.isArray(c.progressoEstagios)) {
                const fechamento = c.progressoEstagios.find(e => e.nome === 'Fechamento');
                if (fechamento && fechamento.valor) ganhos += Number(fechamento.valor);
                // Se quiser considerar perdas, adicione lógica aqui (ex: campo "perda" ou "motivo")
            }
        });
        dash.innerHTML = `
            <div style="display:flex; gap:24px; justify-content:center; margin-bottom:18px;">
                <div style="background:#eafbe6; border-radius:10px; padding:18px; min-width:140px; text-align:center;">
                    <strong>Ganhos:</strong><br>
                    <span style="font-size:22px; color:#27ae60;">R$ ${ganhos.toLocaleString('pt-BR', {minimumFractionDigits:2})}</span>
                </div>
                <div style="background:#ffeaea; border-radius:10px; padding:18px; min-width:140px; text-align:center;">
                    <strong>Perdas:</strong><br>
                    <span style="font-size:22px; color:#c00;">R$ ${perdas.toLocaleString('pt-BR', {minimumFractionDigits:2})}</span>
                </div>
            </div>
        `;
        lista.innerHTML = fechados.map(c => {
            let valor = '-';
            if (Array.isArray(c.progressoEstagios)) {
                const fechamento = c.progressoEstagios.find(e => e.nome === 'Fechamento');
                if (fechamento && fechamento.valor) valor = 'R$ ' + Number(fechamento.valor).toLocaleString('pt-BR', {minimumFractionDigits:2});
            }
            return `
                <div style="border:1px solid #27ae60; border-radius:8px; padding:14px; margin-bottom:12px; background:#eafbe6;">
                    <strong>${c.nome}</strong> <br>
                    <span style="color:#34495e;">${c.email} | ${c.telefone}</span><br>
                    <span style="color:#2980b9;">Vendedor: ${c.vendedor}</span><br>
                    <span style="color:#27ae60;">Valor Fechado: <b>${valor}</b></span>
                </div>
            `;
        }).join('');
    } catch {
        lista.innerHTML = '<p style="color:#c00;">Erro ao carregar fechados.</p>';
    }
}
function fecharModalFechados() {
    document.getElementById('modalFechados').style.display = 'none';
}
</script>



<script>
// Vendedores (backend)
async function adicionarVendedor() {
    const nome = document.getElementById('nomeVendedor').value.trim();
    if (!nome) {
        alert('Digite o nome do vendedor!');
        return;
    }
    try {
        const res = await fetch('/api/vendedores', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ nome })
        });
        if (!res.ok) throw new Error();
        document.getElementById('nomeVendedor').value = '';
        listarVendedores();
        atualizarSelectVendedores();
        atualizarDashVendas();
    } catch {
        alert('Erro ao adicionar vendedor!');
    }
}


// Altere a listagem de vendedores para incluir botão de painel
async function listarVendedores() {
    const lista = document.getElementById('listaVendedores');
    lista.innerHTML = '';
    try {
        const res = await fetch('/api/vendedores');
        const vendedores = await res.json();
        if (!vendedores.length) {
            lista.innerHTML = '<p style="color:#888;">Nenhum vendedor cadastrado.</p>';
            return;
        }
        vendedores.forEach((v, i) => {
            lista.innerHTML += `
                <div style="border:1px solid #2980b9; border-radius:8px; padding:10px; margin-bottom:8px; background:#eaf6fb;">
                    <strong>${v.nome}</strong>
                    <button onclick="removerVendedor('${v.id}')" style="margin-left:10px; padding:4px 10px; background:#f44336; color:#fff; border:none; border-radius:6px;">Excluir</button>
                    <button onclick="abrirPainelVendedor('${v.id}')" style="margin-left:10px; padding:4px 10px; background:#27ae60; color:#fff; border:none; border-radius:6px;">Ver Painel</button>
                </div>
            `;
        });
    } catch {
        lista.innerHTML = '<p style="color:#c00;">Erro ao carregar vendedores.</p>';
    }
}

// ...existing code...
async function abrirPainelVendedor(id) {
    document.getElementById('modalPainelVendedor').style.display = 'flex';
    document.getElementById('resumoPainelVendedor').innerHTML = 'Carregando...';
    document.getElementById('obrasPainelVendedor').innerHTML = '';
    let vendedor = null;
    try {
        const res = await fetch(`/api/vendedores/${id}`);
        vendedor = await res.json();
        document.getElementById('nomePainelVendedor').innerText = vendedor.nome;
    } catch {
        document.getElementById('resumoPainelVendedor').innerHTML = '<span style="color:#c00;">Erro ao carregar vendedor.</span>';
        return;
    }
    // Buscar clientes/obras vinculadas
    let clientes = [];
    try {
        const res = await fetch(`/api/clientes?vendedor=${encodeURIComponent(vendedor.nome)}`);
        clientes = await res.json();
    } catch {}

    // Calcule os valores aqui
    let totalFechado = 0, totalPossivel = 0;
    clientes.forEach(c => {
        if (Array.isArray(c.progressoEstagios)) {
            const fechamento = c.progressoEstagios.find(e => e.nome === 'Fechamento');
            if (fechamento && fechamento.valor) totalFechado += Number(fechamento.valor);
            const possivel = c.progressoEstagios.find(e => e.nome === 'Contato' && e.valor) || c.progressoEstagios.find(e => e.nome === 'Negociação' && e.valor);
            if (possivel && possivel.valor) totalPossivel += Number(possivel.valor);
        }
    });

    document.getElementById('resumoPainelVendedor').innerHTML = `
        <div style="display:flex; gap:24px; flex-wrap:wrap;">
            <div style="background:#eafbe6; border-radius:10px; padding:14px; min-width:120px; text-align:center;">
                <strong>Fechado:</strong><br>
                <span style="font-size:18px; color:#27ae60;">R$ ${totalFechado.toLocaleString('pt-BR', {minimumFractionDigits:2})}</span>
            </div>
            <div style="background:#fffbe6; border-radius:10px; padding:14px; min-width:120px; text-align:center;">
                <strong>Possível:</strong><br>
                <span style="font-size:18px; color:#f39c12;">R$ ${totalPossivel.toLocaleString('pt-BR', {minimumFractionDigits:2})}</span>
            </div>
            <div style="background:#eaf6fb; border-radius:10px; padding:14px; min-width:120px; text-align:center;">
                <strong>Obras:</strong><br>
                <span style="font-size:18px; color:#2980b9;">${clientes.length}</span>
            </div>
        </div>
    `;
    // Listar obras/clientes
    document.getElementById('obrasPainelVendedor').innerHTML = clientes.map(c => {
        // Prazo de 40 dias
        let prazoRestante = '';
        let corPrazo = '#27ae60';
        if (Array.isArray(c.progressoEstagios)) {
            const datas = c.progressoEstagios.map(e => e.data).filter(Boolean).sort();
            if (datas.length) {
                const primeira = new Date(datas[0]);
                const prazo = new Date(primeira);
                prazo.setDate(prazo.getDate() + 40);
                const hoje = new Date();
                const dias = Math.ceil((prazo - hoje) / (1000 * 60 * 60 * 24));
                prazoRestante = dias >= 0 ? `${dias} dias restantes` : `<span style="color:#c00;">Prazo excedido!</span>`;
                if (dias <= 10 && dias >= 0) corPrazo = '#f39c12';
                if (dias < 0) corPrazo = '#c00';
            }
        }
        // Visitas
        let visitas = Array.isArray(c.visitas) ? c.visitas : [];
        return `
            <div style="border:1px solid #ccc; border-radius:8px; padding:12px; margin-bottom:10px; background:#f9f9f9;">
                <strong>${c.nome}</strong> <br>
                <span style="color:#34495e;">${c.enderecoObra || '-'}</span><br>
                <span style="color:#f39c12;">Status: ${c.status || '-'}</span><br>
                <span style="color:${corPrazo};">Prazo: ${prazoRestante || '-'}</span><br>
                <span style="color:#2980b9;">Visitas: ${visitas.length}</span>
                <button onclick="abrirModalVisitas('${c.id}')" style="margin-left:10px; padding:4px 10px; background:#34495e; color:#fff; border:none; border-radius:6px;">Ver/Registrar Visitas</button>
            </div>
        `;
    }).join('');
    window.vendedorPainelAberto = id;
}

function fecharPainelVendedor() {
    document.getElementById('modalPainelVendedor').style.display = 'none';
}

// Modal de visitas por obra
document.body.insertAdjacentHTML('beforeend', `
<div id="modalVisitasObra" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.65); z-index:9999; align-items:center; justify-content:center;">
  <div style="background:#fff; border-radius:14px; padding:32px 24px; max-width:500px; width:95vw; max-height:90vh; overflow:auto; position:relative;">
    <button onclick="fecharModalVisitas()" style="position:absolute;top:12px;right:18px;background:#f44336;color:#fff;border:none;border-radius:50%;width:32px;height:32px;font-size:22px;cursor:pointer;">&times;</button>
    <h3 style="color:#34495e; text-align:center; margin-bottom:18px;">Visitas à Obra</h3>
    <div id="listaVisitasObra"></div>
    <h4 style="margin-top:18px;">Registrar Nova Visita</h4>
    <input type="date" id="dataVisitaObra" style="margin-bottom:8px;">
    <input type="text" id="motivoVisitaObra" placeholder="Motivo da visita" style="margin-bottom:8px;">
    <button onclick="salvarVisitaObra()" style="padding:8px 18px; background:#27ae60; color:white; border:none; border-radius:8px; font-size:15px;">Salvar Visita</button>
  </div>
</div>
`);

let obraVisitaAtual = null;
async function abrirModalVisitas(clienteId) {
    obraVisitaAtual = clienteId;
    document.getElementById('modalVisitasObra').style.display = 'flex';
    await listarVisitasObra();
}
function fecharModalVisitas() {
    document.getElementById('modalVisitasObra').style.display = 'none';
    obraVisitaAtual = null;
}
async function listarVisitasObra() {
    const lista = document.getElementById('listaVisitasObra');
    lista.innerHTML = '<p style="color:#888;">Carregando...</p>';
    try {
        const res = await fetch(`/api/clientes/${obraVisitaAtual}`);
        const cliente = await res.json();
        const visitas = Array.isArray(cliente.visitas) ? cliente.visitas : [];
        if (!visitas.length) {
            lista.innerHTML = '<p style="color:#888;">Nenhuma visita registrada.</p>';
            return;
        }
        lista.innerHTML = visitas.map(v => `
            <div style="border:1px solid #ccc; border-radius:6px; padding:8px; margin-bottom:6px; background:#fff;">
                <span style="color:#34495e;">Data: ${v.data || '-'}</span><br>
                <span style="color:#2980b9;">Motivo: ${v.motivo || '-'}</span>
            </div>
        `).join('');
    } catch {
        lista.innerHTML = '<p style="color:#c00;">Erro ao carregar visitas.</p>';
    }
}
async function salvarVisitaObra() {
    const data = document.getElementById('dataVisitaObra').value;
    const motivo = document.getElementById('motivoVisitaObra').value.trim();
    if (!data || !motivo) {
        alert('Preencha data e motivo!');
        return;
    }
    try {
        const res = await fetch(`/api/clientes/${obraVisitaAtual}/visitas`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ data, motivo })
        });
        if (!res.ok) {
            const erro = await res.text();
            alert('Erro ao salvar visita: ' + erro);
            return;
        }
        document.getElementById('dataVisitaObra').value = '';
        document.getElementById('motivoVisitaObra').value = '';
        listarVisitasObra();
        // Atualiza painel vendedor após registrar visita
        if (window.vendedorPainelAberto) abrirPainelVendedor(window.vendedorPainelAberto);
    } catch (e) {
        alert('Erro ao salvar visita! ' + e.message);
    }
}
async function removerVendedor(id) {
    try {
        const res = await fetch(`/api/vendedores/${id}`, { method: 'DELETE' });
        if (!res.ok) throw new Error();
        listarVendedores();
        atualizarSelectVendedores();
        atualizarDashVendas();
    } catch {
        alert('Erro ao excluir vendedor!');
    }
}
async function atualizarSelectVendedores() {
    const vendedores = await fetch('/api/vendedores').then(r => r.json()).catch(() => []);
    const select = document.getElementById('vendedorResponsavel');
    select.innerHTML = '<option value="">Selecione o Vendedor</option>';
    vendedores.forEach(v => {
        const opt = document.createElement('option');
        opt.value = v.nome;
        opt.textContent = v.nome;
        select.appendChild(opt);
    });
}

// Dashboard (backend)
async function atualizarDashVendas() {
    const clientes = await fetch('/api/clientes').then(r => r.json()).catch(() => []);
    const vendedores = await fetch('/api/vendedores').then(r => r.json()).catch(() => []);
    document.getElementById('totalClientes').innerText = clientes.length;
    document.getElementById('totalProspec').innerText = clientes.filter(c => c.status !== 'Fechado').length;
    document.getElementById('totalVendedores').innerText = vendedores.length;
}

// Ao abrir a tela de vendas, mostra o dashboard e submenu de clientes registrados
document.addEventListener('DOMContentLoaded', () => {
    atualizarDashVendas();
    mostrarSubVendas('clientesRegistrados');
});
document.body.insertAdjacentHTML('beforeend', `
<div id="modalEstagiosProspec" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.65); z-index:9999; align-items:center; justify-content:center;">
  <div style="background:#fff; border-radius:14px; padding:32px 24px; max-width:600px; width:95vw; max-height:90vh; overflow:auto; position:relative;">
    <button onclick="fecharModalEstagiosProspec()" style="position:absolute;top:12px;right:18px;background:#f44336;color:#fff;border:none;border-radius:50%;width:32px;height:32px;font-size:22px;cursor:pointer;">&times;</button>
    <h3 style="color:#f39c12; text-align:center; margin-bottom:18px;">Estágios do Processo de Prospecção</h3>
    <form id="formEstagiosProspec"></form>
  </div>
</div>
`);
function mostrarSubVendas(sub) {
    document.querySelectorAll('.subvendas').forEach(div => div.style.display = 'none');
    if (sub === 'cadastroCliente') atualizarSelectVendedores();
    if (sub === 'clientesRegistrados') listarClientes();
    if (sub === 'prospeccao') listarProspeccao();
    if (sub === 'resumoClientes') {
        atualizarResumoClientes();
        listarVendedores(); // <-- Adicione esta linha aqui
    }
    if (sub === 'vendedores') listarVendedores();
    document.getElementById('subVendas' + capitalize(sub)).style.display = 'block';
}

</script>
<!-- Adicione este bloco onde desejar -->




   </body>
   </html>
